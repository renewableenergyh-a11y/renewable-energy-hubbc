<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Aubie RET Hub</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Quill removed; using markdown textarea -->
  <style>
    /* ====== MODERN APP DASHBOARD LAYOUT ====== */
    .admin-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--bg-main);
    }

    .site-header {
      background: linear-gradient(135deg, var(--green-main) 0%, #005a4f 100%);
      color: white;
      padding: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      gap: 20px;
    }

    .site-header .logo {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      white-space: nowrap;
    }

    /* Home hero banner inside dashboard home */
    .home-hero {
      background: linear-gradient(90deg, rgba(0,121,107,0.12), rgba(0,121,107,0.06));
      border: 1px solid rgba(0,121,107,0.08);
      color: var(--text-main);
      padding: 18px;
      border-radius: 12px;
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
    }

    .home-hero .hero-icon { font-size: 28px; color: var(--green-main); width: 44px; height:44px; display:flex;align-items:center;justify-content:center;background:rgba(0,121,107,0.08);border-radius:8px }
    .home-hero .hero-text h3 { margin:0; font-size:18px; font-weight:700 }
    .home-hero .hero-text p { margin:0; color:var(--text-muted) }

    .nav-menu {
      display: flex;
      gap: 40px;
      align-items: center;
    }

    .header-hamburger {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
    }

    .nav-menu a {
      color: white;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      padding: 12px 24px;
      border-radius: 6px;
    }

    .nav-menu a:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    main {
      flex: 1;
      display: flex;
      background: var(--bg-main);
    }

    /* ====== SIDEBAR NAVIGATION ====== */
    .admin-sidebar {
      width: 260px;
      background: white;
      border-right: 1px solid #e6eef4;
      overflow-y: auto;
      flex-shrink: 0;
      position: fixed;
      top: var(--site-header-height, 64px);
      bottom: 0;
      left: 0;
      height: calc(100vh - var(--site-header-height, 64px));
      z-index: 900;
    }

    .sidebar-content {
      padding: 24px 0;
    }

    .sidebar-section {
      margin-bottom: 8px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      padding: 12px 20px;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .sidebar-link:hover {
      background: #f9fafb;
      color: var(--green-main);
      border-left-color: var(--green-main);
    }

    .sidebar-link.active {
      background: rgba(0, 121, 107, 0.08);
      color: var(--green-main);
      border-left-color: var(--green-main);
      font-weight: 600;
    }

    .sidebar-link i {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    /* ====== MAIN CONTENT AREA ====== */
    .admin-main {
      flex: 1;
      overflow-y: auto;
      margin-left: 260px;
    }

    .admin-dashboard {
      padding: 32px;
      overflow-y: auto;
    }

    /* Fullscreen dashboard styles removed */

    .dashboard-header {
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .dashboard-header h2 {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .dashboard-header p {
      font-size: 15px;
      color: var(--text-muted);
      max-width: 600px;
    }

    .dashboard-header-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* ====== TABS NAVIGATION ====== */
    .tabs-container {
      background: white;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .tabs-navigation {
      display: flex;
      gap: 0;
      flex-wrap: wrap;
      background: linear-gradient(135deg, #f0f4f8 0%, #e8f1f7 100%);
      border-bottom: 3px solid #d4e4f0;
    }

    .tab-button {
      flex: 1;
      min-width: 140px;
      padding: 16px 22px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #5a6c7d;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-button i {
      font-size: 16px;
    }

    .tab-button:hover {
      color: #00796b;
      background: rgba(0, 121, 107, 0.08);
    }

    .tab-button.active {
      color: var(--green-main);
      background: white;
      font-weight: 700;
    }

    .tab-button.active::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--green-main), #4db8a3);
      box-shadow: 0 2px 8px rgba(0, 121, 107, 0.3);
    }

    /* ====== TABS CONTENT ====== */
    .tabs-content {
      background: white;
      border-radius: 0 0 var(--card-radius) var(--card-radius);
      padding: 32px;
      min-height: 400px;
    }

    .tab-panel {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-panel.active {
      display: block;
    }

    /* Panel heading shown at top of each tab panel */
    .tab-heading h2 {
      font-size: 35px;
      margin: 0 0 35px 0;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.05;
      letter-spacing: -0.3px;
    }
    .panel-heading-area { background: transparent; padding-top: 8px; }
    .panel-heading-area .tab-heading h2 { background: transparent; padding: 0; margin-top: 0; }
    .tabs-container { margin-top: 2px; }
    /* place heading outside card visually */
    .tab-panel > .tab-heading { margin-left: 0; }
    .tab-panel .tab-body > .card:first-child { margin-top: 0; }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ====== FORM INPUTS & BUTTONS ====== */
    input, select, textarea {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      padding: 12px 14px;
      border: 1px solid #e0e8f0;
      border-radius: 8px;
      background: #fafbfc;
      color: var(--text-main);
      transition: all 0.25s ease;
      outline: none;
    }

    input::placeholder, textarea::placeholder {
      color: #a8b8c8;
      font-weight: 500;
    }

    input:hover, select:hover, textarea:hover {
      border-color: #c8d8e8;
      background: #fcfdfe;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--green-main);
      background: #fafbfc;
      box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.08);
    }

    select {
      cursor: pointer;
      padding-right: 32px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      appearance: none;
    }

    /* ====== BUTTONS ====== */
    .btn-primary, .btn, button[type="submit"] {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 600;
      padding: 11px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.25s ease;
      text-align: center;
      white-space: nowrap;
    }

    .btn-primary, button[type="submit"] {
      background: linear-gradient(135deg, var(--green-main) 0%, #0d8b7f 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 121, 107, 0.2);
    }

    .btn-primary:hover, button[type="submit"]:hover {
      background: linear-gradient(135deg, #006957 0%, #00706b 100%);
      box-shadow: 0 4px 12px rgba(0, 121, 107, 0.3);
      transform: translateY(-1px);
    }

    .btn-primary:active, button[type="submit"]:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 121, 107, 0.2);
    }

    .btn {
      background: #f0f4f8;
      color: #3f4f63;
      border: 1px solid #e0e8f0;
    }

    /* ====== FULLSCREEN EDITOR ====== */
    #cm-editor-area.editor-fullscreen {
      position: fixed;
      inset: 0;
      background: #ffffff;
      padding: 20px;
      z-index: 99999;
      overflow: auto;
      display: flex;
      flex-direction: column;
    }
    #cm-editor-area.editor-fullscreen .card { height: 100%; box-shadow: none; border-radius: 0; }
    #cm-editor-area.editor-fullscreen textarea#cm-content-editor { height: calc(100vh - 180px) !important; width: 100%; resize: none; }
    #cm-editor-area.editor-fullscreen #cm-preview { height: calc(100vh - 180px) !important; overflow: auto; }

    /* ====== EDITOR PREVIEW IMAGE CARD ====== */
    #cm-preview img {
      display: none !important;
    }
    #cm-preview figure.inline-figure {
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px !important;
      background: linear-gradient(135deg, #f5f8fc 0%, #f0f5fa 100%) !important;
      border: 2px solid #007b6e !important;
      border-radius: 8px !important;
      margin: 16px 0 !important;
      min-width: 200px;
      text-align: center;
      width: fit-content;
    }
    #cm-preview figure.inline-figure img {
      display: none !important;
    }
    #cm-preview figure.inline-figure::before {
      content: 'ðŸ–¼ï¸\a image';
      white-space: pre;
      font-weight: 600;
      color: #007b6e;
      font-size: 48px;
      line-height: 1.2;
      margin-bottom: 12px;
    }
    #cm-preview figure.inline-figure figcaption {
      display: block !important;
      font-size: 13px;
      color: #666;
      font-style: italic;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 123, 110, 0.2);
      margin: 0 !important;
      padding: 12px 0 0 0 !important;
      background: transparent !important;
      border-radius: 0 !important;
    }

    .btn:hover {
      background: #e8f1f7;
      border-color: var(--green-main);
      color: var(--green-main);
    }

    .btn:active {
      background: #dce8f2;
    }

    /* ====== GETTING STARTED SECTION ====== */
    .getting-started {
      display: grid;
      grid-template-columns: 1fr;
      gap: 28px;
    }

    .feature-card {
      background: #f9fafb;
      border: 1px solid #e6eef4;
      border-radius: var(--card-radius);
      padding: 24px;
      transition: all 0.3s ease;
    }

    .feature-card:hover {
      border-color: var(--green-main);
      box-shadow: 0 4px 12px rgba(0, 121, 107, 0.1);
    }

    .feature-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .feature-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      background: var(--green-main);
      color: white;
      border-radius: 10px;
      font-size: 24px;
      flex-shrink: 0;
    }

    .feature-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .feature-subtitle {
      font-size: 14px;
      color: var(--text-muted);
    }

    .feature-content {
      line-height: 1.8;
      color: var(--text-muted);
      font-size: 15px;
    }

    .feature-content ul {
      list-style: none;
      padding: 0;
      margin: 12px 0 0 0;
    }

    .feature-content li {
      padding: 8px 0;
      padding-left: 24px;
      position: relative;
    }

    .feature-content li:before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: var(--green-main);
      font-weight: 700;
    }

    /* ====== ADMIN DASHBOARD OVERVIEW ====== */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #f9fafb;
      border: 1px solid #e6eef4;
      border-radius: var(--card-radius);
      padding: 20px;
      text-align: center;
    }

    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--green-main);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ====== VIDEO/GIF SECTION ====== */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .media-item {
      background: #f0f4f8;
      border-radius: var(--card-radius);
      overflow: hidden;
      border: 1px solid #e6eef4;
      transition: all 0.3s ease;
    }

    .media-item:hover {
      box-shadow: var(--shadow-soft);
      border-color: var(--green-main);
    }

    .media-placeholder {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
    }

    /* ====== STYLED MODAL DIALOGS ====== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      animation: fadeIn 0.2s ease;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 32px;
      max-width: 500px;
      width: 90%;
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin-bottom: 16px;
    }

    .modal-icon.success {
      background: #ecfdf5;
      color: #059669;
    }

    .modal-icon.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .modal-icon.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .modal-icon.info {
      background: #dbeafe;
      color: #0284c7;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .modal-message {
      font-size: 15px;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 24px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 8px;
    }

    .modal-message::-webkit-scrollbar {
      width: 6px;
    }

    .modal-message::-webkit-scrollbar-track {
      background: transparent;
    }

    .modal-message::-webkit-scrollbar-thumb {
      background: var(--green-main, #10b981);
      border-radius: 3px;
    }

    .modal-message::-webkit-scrollbar-thumb:hover {
      background: var(--green-dark, #059669);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, var(--green-main) 0%, #0d8b7f 100%);
      color: white;
      min-width: 100px;
    }

    .modal-btn-primary:hover {
      box-shadow: 0 4px 12px rgba(0, 121, 107, 0.3);
      transform: translateY(-1px);
    }

    .modal-btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
      border: 1px solid #e5e7eb;
    }

    .modal-btn-secondary:hover {
      background: #e5e7eb;
    }

    .media-info {
      padding: 16px;
    }

    .media-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 6px;
    }

    .media-description {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    /* ====== TERMINOLOGY SECTION ====== */
    .terminology-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .term-card {
      background: #f9fafb;
      border: 1px solid #e6eef4;
      border-radius: var(--card-radius);
      padding: 18px;
      transition: all 0.3s ease;
    }

    .term-card:hover {
      border-color: var(--green-main);
      background: rgba(0, 121, 107, 0.03);
    }

    .term-name {
      font-size: 15px;
      font-weight: 700;
      color: var(--green-main);
      margin-bottom: 8px;
    }

    .term-definition {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    /* ====== CHECKLIST SECTION ====== */
    .checklist-container {
      background: #f9fafb;
      border-radius: var(--card-radius);
      padding: 24px;
      border: 1px solid #e6eef4;
    }

    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid #e6eef4;
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checklist-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid #e6eef4;
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .checklist-checkbox:hover {
      border-color: var(--green-main);
      background: rgba(0, 121, 107, 0.05);
    }

    .checklist-checkbox.checked {
      background: var(--green-main);
      border-color: var(--green-main);
      color: white;
    }

    .checklist-text {
      flex: 1;
    }

    .checklist-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
      display: block;
    }

    .checklist-description {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ====== RESPONSIVE LAYOUT ====== */
    @media (max-width: 1024px) {
      .admin-sidebar {
        width: 200px;
      }

      .admin-dashboard {
        padding: 20px;
      }
      
      .admin-main {
        margin-left: 200px;
      }

      .tabs-navigation {
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .tab-button {
        min-width: 100px;
        padding: 12px 14px;
        font-size: 12px;
      }

      .tabs-content {
        padding: 20px;
      }
    }

    @media (max-width: 768px) {
      .admin-page {
        flex-direction: column;
      }

      main {
        flex-direction: column;
      }

      .admin-sidebar {
        width: 100%;
        max-height: auto;
        border-right: none;
        border-bottom: 1px solid #e6eef4;
        display: none;
        position: static;
      }

      .admin-sidebar.mobile-open {
        display: block;
        position: absolute;
        top: 60px;
        left: 0;
        right: 0;
        z-index: 999;
        background: white;
        border-bottom: 1px solid #e6eef4;
        max-height: calc(100vh - 60px);
        overflow-y: auto;
      }

      /* Mobile header: hide desktop nav and show hamburger */
      .nav-menu { display: none; }
      .header-hamburger { display: inline-block; }

      .admin-dashboard {
        padding: 16px;
        width: 100%;
      }

      .admin-main {
        margin-left: 0;
      }

      .dashboard-header {
        flex-direction: column;
        gap: 16px;
      }

      .dashboard-header h2 {
        font-size: 24px;
      }

      .overview-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .tabs-navigation {
        flex-wrap: wrap;
      }

      .tab-button {
        flex: 0 1 auto;
        min-width: 110px;
        padding: 10px 12px;
        font-size: 12px;
      }
    }

    /* ====== DARK MODE SUPPORT FOR DEPLOY PANEL CARDS ====== */
    body.dark div[style*="border:1px solid #e6eef4"] {
      background-color: rgba(255, 255, 255, 0.05) !important;
      border-color: rgba(0, 179, 138, 0.3) !important;
    }

    body.dark div[style*="background:#f0f9ff"] {
      background-color: rgba(0, 179, 138, 0.12) !important;
      border-color: rgba(0, 179, 138, 0.3) !important;
    }

    /* Text colors in dark mode for deploy panel */
    body.dark span[style*="color:#0c4a6e"],
    body.dark span[style*="color:#1e40af"],
    body.dark p[style*="color:#0c4a6e"],
    body.dark p[style*="color:#1e40af"] {
      color: #7dd3c0 !important;
    }

    body.dark div[style*="color:#6b7280"],
    body.dark p[style*="color:#6b7280"] {
      color: #9fb6c6 !important;
    }

    body.dark h4[style*="color:#1f2937"] {
      color: #e6f7ef !important;
    }

    /* Dark mode for card containers */
    body.dark #pending-courses-list > div,
    body.dark #pending-modules-metadata-list > div,
    body.dark #pending-content-list > div {
      background-color: rgba(255, 255, 255, 0.04) !important;
      border-color: rgba(0, 179, 138, 0.3) !important;
    }

    /* Dark mode for textarea and input in deploy panel */
    body.dark textarea[id*="cm-"] {
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: var(--text-main) !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
    }

    body.dark div[id*="cm-preview"],
    body.dark div[id*="cm-quill-container"] {
      background-color: rgba(255, 255, 255, 0.03) !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
    }

    /* Course/Module/Content cards in deploy panel */
    body.dark div[style*="border:1px solid #dbeafe"],
    body.dark div[style*="border:1px solid #fce7f3"],
    body.dark div[style*="border:1px solid"] {
      background-color: rgba(255, 255, 255, 0.04) !important;
      border-color: rgba(0, 179, 138, 0.3) !important;
    }

    body.dark span[style*="color:#075985"],
    body.dark span[style*="color:#831843"] {
      color: #7dd3c0 !important;
    }

    /* Ensure proper contrast for all text in cards */
    body.dark div[style*="border:1px solid"] span,
    body.dark div[style*="border:1px solid"] p {
      color: var(--text-main) !important;
    }

    /* Dark mode for info/hint boxes */
    body.dark div[style*="background:#f0f9ff"],
    body.dark div[style*="background:#fef3c7"],
    body.dark div[style*="background:#fee2e2"] {
      background-color: rgba(0, 179, 138, 0.08) !important;
      border-color: rgba(0, 179, 138, 0.25) !important;
    }
  </style>
  </style>
</head>
<body class="admin-page">
  <header class="site-header">
    <div class="header-container">
      <h1 class="logo">
        <i class="fas fa-chart-line" style="margin-right: 10px;"></i>
        Aubie RET Hub â€” Admin
      </h1>
      <nav class="nav-menu">
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="courses.html"><i class="fas fa-book"></i> Courses</a>
        <!-- mobile-menu-toggle removed (header-hamburger used instead) -->
        <button id="header-hamburger" class="header-hamburger" aria-label="Open menu" title="Menu" style="margin-left:8px;">
          <i class="fas fa-bars"></i>
        </button>
        <button id="fullscreen-toggle" class="fullscreen-btn" title="Toggle fullscreen"><i class="fas fa-expand"></i></button>
        <a id="logout-link" href="#" style="display:none;"><i class="fas fa-sign-out-alt"></i> Logout</a>
        <div id="profile-menu-wrapper" style="position:relative;">
          <button id="profile-circle" class="profile-circle" title="Profile"></button>
          <div id="profile-dropdown" class="profile-dropdown" style="display:none">
            <div class="profile-dropdown-header">
              <strong id="profile-name"></strong>
              <div id="profile-role" class="profile-role-badge"></div>
            </div>
            <div class="profile-org">Aubie RET Hub</div>
            <button id="profile-theme-toggle" class="profile-theme-toggle">
              <i class="fas fa-moon"></i>
              <span>Dark Mode</span>
            </button>
            <button id="profile-logout-btn" class="profile-logout-btn">Logout</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <!-- SIDEBAR NAVIGATION -->
    <aside class="admin-sidebar" id="admin-sidebar">
      <div class="sidebar-content">
        <button id="sidebar-collapse-btn" class="sidebar-collapse-btn" aria-label="Toggle sidebar" title="Toggle sidebar">
          <i class="fas fa-angle-left"></i>
        </button>


        <!-- NAVIGATION LINKS (shown when logged in) -->
        <section id="admin-nav-links" style="display: none;">
          <div class="sidebar-section">
            <div class="sidebar-title">Platform</div>
            <a href="#" class="sidebar-link" data-tab="home">
              <i class="fas fa-home"></i>
              <span>Home</span>
            </a>
            <a href="#" class="sidebar-link active" data-tab="getting-started">
              <i class="fas fa-rocket"></i>
              <span>Getting Started</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="analytics">
              <i class="fas fa-chart-bar"></i>
              <span>Analytics</span>
            </a>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">Management</div>
            <a href="#" class="sidebar-link" data-tab="users">
              <i class="fas fa-users"></i>
              <span>Users</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="courses">
              <i class="fas fa-book-open"></i>
              <span>Courses</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="modules">
              <i class="fas fa-layer-group"></i>
              <span>Modules</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="content">
              <i class="fas fa-file-alt"></i>
              <span>Content</span>
            </a>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">Communication</div>
            <a href="#" class="sidebar-link" data-tab="inbox" style="display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-inbox"></i>
              <span>Inbox</span>
              <span id="inbox-badge" style="display: none; margin-left: auto; background: #dc2626; color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: bold; min-width: 24px; text-align: center;">0</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="live-chat">
              <i class="fas fa-comments"></i>
              <span>Live Chat</span>
              <span id="live-chat-badge" style="display: none; margin-left: auto; background: #d32f2f; color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: bold; min-width: 24px; text-align: center;">0</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="discussions">
              <i class="fas fa-video"></i>
              <span>Discussions</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="news">
              <i class="fas fa-newspaper"></i>
              <span>News</span>
            </a>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">System</div>
            <a href="#" class="sidebar-link" data-tab="documents">
              <i class="fas fa-folder-open"></i>
              <span>Deploy</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="settings">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
          </div>
        </section>
      </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <div class="admin-main">


      <!-- DASHBOARD SECTION (hidden before login) -->
      <section id="admin-dashboard-section" class="admin-dashboard" style="display:none;">
        <div class="dashboard-header">
          <div>
            <!-- title removed; 'Dashboard' header appears only on Home panel -->
          </div>
          <div class="dashboard-header-right">
          </div>
        </div>

        <!-- PANEL HEADING (shows active panel title outside cards) -->
        <div class="panel-heading-area" style="padding:18px 24px 0 24px;">
          <div class="tab-heading"><h2></h2></div>
        </div>

        <!-- TABS CONTAINER -->
        <div class="tabs-container">
          <!-- TABS NAVIGATION (hidden on mobile) -->
          <div class="tabs-navigation" style="display: none;">
            <!-- Tab buttons will be populated by JavaScript from sidebar -->
          </div>

          <!-- TABS CONTENT -->
          <div class="tabs-content">
            <!-- Content panels populated by JavaScript -->
          <div class="tab-panel" id="home-panel">
            <div class="home-hero">
              <div class="hero-icon"><i class="fas fa-chart-line"></i></div>
              <div class="hero-text">
                <h3>Welcome</h3>
                <p>Welcome to the Aubie RET Hub administration center. Manage users, courses, and platform settings.</p>
              </div>
            </div>
            <!-- home overview moved to dynamic loader to avoid duplication -->
          </div>
          <!-- GETTING STARTED TAB -->
          <div class="tab-panel active" id="getting-started-panel">
            <div class="getting-started">
                <!-- MARKDOWN WRITING GUIDE FOR ADMINS -->
                <div class="feature-card" style="border:2px solid #00796b;background:#f5f8fc;">
                  <div class="feature-header">
                    <div class="feature-icon"><i class="fas fa-pen-nib"></i></div>
                    <div>
                      <h3 class="feature-title">How to Write in Markdown</h3>
                      <p class="feature-subtitle">A quick guide for admins to create and format content</p>
                    </div>
                  </div>
                  <div class="feature-content">
                    <p>Markdown is a simple way to write formatted text for modules, help docs, and announcements. Hereâ€™s how to get started:</p>
                    <ul>
                      <li><strong>Headings:</strong> <code># Title</code>, <code>## Section</code></li>
                      <li><strong>Bold:</strong> <code>**bold**</code> &nbsp; <strong>Italic:</strong> <code>*italic*</code></li>
                      <li><strong>Lists:</strong> <code>- Item 1</code> <br> <code>1. First</code></li>
                      <li><strong>Links:</strong> <code>[RET Hub](https://example.com)</code></li>
                      <li><strong>Images:</strong> <code>![Alt](url)</code></li>
                      <li><strong>Code:</strong> <code>`inline`</code> or <code>```block```</code></li>
                      <li><strong>Quotes:</strong> <code>&gt; Note</code></li>
                    </ul>
                    <div style="margin:18px 0 0 0;">
                      <strong>Example:</strong>
                      <pre style="background:#e6eef4;padding:10px;border-radius:6px;overflow-x:auto;font-size:13px;"># Module Title

  **Bold** and *italic* text

  - List item 1
  - List item 2

  [RET Hub](https://example.com)

  ![Solar](https://example.com/solar.jpg)

  &gt; This is a tip.

  `inline code`

  ```
  console.log('Hello!');
  ```</pre>
                    </div>
                    <div style="margin:18px 0 0 0;">
                      <strong>Best Practices:</strong>
                      <ul>
                        <li>Use headings to organize content</li>
                        <li>Keep lists clear and concise</li>
                        <li>Preview before publishing</li>
                        <li>Use images and code blocks for clarity</li>
                      </ul>
                    </div>
                    <div style="margin:18px 0 0 0;">
                      <strong>More Resources:</strong>
                      <a href="https://www.markdownguide.org/basic-syntax/" target="_blank" style="color:#00796b;text-decoration:underline;">Markdown Guide</a>
                    </div>
                  </div>
                  <!-- MARKDOWN VIDEO GUIDE -->
                  <div style="margin:28px 0 0 0;">
                    <div style="max-width:600px;margin:0 auto;">
                      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                        <iframe src="https://www.youtube.com/embed/t9PiNRSQ_BU" title="Markdown Writing for Admins" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allowfullscreen></iframe>
                      </div>
                      <p style="font-size:13px;color:#666;text-align:center;margin-top:8px;">Watch: Markdown Basics for Admins</p>
                    </div>
                  </div>
                </div>
              <!-- 1. ADMIN DASHBOARD OVERVIEW -->
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-icon">
                    <i class="fas fa-th-large"></i>
                  </div>
                  <div>
                    <h3 class="feature-title">Admin Overview</h3>
                    <p class="feature-subtitle">Get familiar with the admin panel interface</p>
                  </div>
                </div>
                <div class="feature-content">
                  <p>The admin panel is your central hub for managing the entire Aubie RET Hub platform. Here's what you'll find:</p>
                  <ul>
                    <li><strong>Quick Statistics:</strong> View real-time data on active users, total courses, and platform metrics</li>
                    <li><strong>Navigation Tabs:</strong> Access Users, Courses, Analytics, and Settings from the top menu</li>
                    <li><strong>User Management:</strong> Add, edit, or remove user accounts and manage permissions</li>
                    <li><strong>Course Administration:</strong> Create, update, and manage course content and modules</li>
                    <li><strong>Activity Logs:</strong> Monitor platform activity and user interactions</li>
                    <li><strong>System Alerts:</strong> View important notifications and system status updates</li>
                  </ul>
                  <div class="overview-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                      <div class="stat-number">1,284</div>
                      <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">24</div>
                      <div class="stat-label">Active Courses</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">87%</div>
                      <div class="stat-label">Completion Rate</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">12</div>
                      <div class="stat-label">Active Sessions</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 2. USER ROLES & PERMISSIONS -->
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-icon">
                    <i class="fas fa-shield-alt"></i>
                  </div>
                  <div>
                    <h3 class="feature-title">User Roles & Permissions</h3>
                    <p class="feature-subtitle">Understand the role hierarchy and access control</p>
                  </div>
                </div>
                <div class="feature-content">
                  <p>The platform uses a role-based access control system to manage user permissions. Each role has specific capabilities:</p>
                  <ul>
                    <li><strong>Super Admin:</strong> Full platform access, user management, course creation, and system settings</li>
                    <li><strong>Admin:</strong> User management, course management, and analytics access</li>
                    <li><strong>Instructor:</strong> Can create and manage their own courses and view student progress</li>
                    <li><strong>Student:</strong> Can enroll in courses, complete modules, and track their progress</li>
                    <li><strong>Guest:</strong> Limited read-only access to public course materials</li>
                  </ul>
                  <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e6eef4;"><i class="fas fa-info-circle"></i> <strong>Pro Tip:</strong> Always assign the minimum necessary permissions to users to maintain security. Regularly review user roles to ensure they're appropriate for their current responsibilities.</p>
                </div>
              </div>

              <!-- 3. FIRST-TIME SETUP CHECKLIST -->
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-icon">
                    <i class="fas fa-clipboard-list"></i>
                  </div>
                  <div>
                    <h3 class="feature-title">First-Time Setup Checklist</h3>
                    <p class="feature-subtitle">Complete these essential steps to get started</p>
                  </div>
                </div>
                <div class="checklist-container">
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Configure System Settings</span>
                      <span class="checklist-description">Set up platform name, logo, timezone, and language preferences in Settings tab</span>
                    </div>
                  </div>
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Add Initial Admin Users</span>
                      <span class="checklist-description">Create admin accounts for your team members with appropriate roles and permissions</span>
                    </div>
                  </div>
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Upload Course Content</span>
                      <span class="checklist-description">Import or create your initial course modules and learning materials</span>
                    </div>
                  </div>
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Set Up Email Notifications</span>
                      <span class="checklist-description">Configure email templates and notification settings for user communications</span>
                    </div>
                  </div>
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Enable Backup & Security</span>
                      <span class="checklist-description">Set up automated backups and enable two-factor authentication for admin accounts</span>
                    </div>
                  </div>
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Create Help Resources</span>
                      <span class="checklist-description">Prepare FAQs, documentation, and support materials for users and instructors</span>
                    </div>
                  </div>
                  <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="this.classList.toggle('checked')">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="checklist-text">
                      <span class="checklist-title">Launch Beta Testing</span>
                      <span class="checklist-description">Invite a small group of users to test the platform and provide feedback</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 4. VIDEO & GIF WALKTHROUGHS -->
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-icon">
                    <i class="fas fa-video"></i>
                  </div>
                  <div>
                    <h3 class="feature-title">Video & GIF Walkthroughs</h3>
                    <p class="feature-subtitle">Visual guides to help you get started quickly</p>
                  </div>
                </div>
                <div class="feature-content" style="margin-bottom: 20px;">
                  <p>Watch these step-by-step tutorials to learn how to perform common admin tasks:</p>
                </div>
                <div class="media-grid">
                  <div class="media-item">
                    <div class="media-placeholder">
                      <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="media-info">
                      <div class="media-title">Creating Your First Course</div>
                      <div class="media-description">Learn how to create a new course and add modules in 5 minutes.</div>
                      <button style="margin-top: 12px; padding: 8px 12px; background: var(--green-main); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Watch Video</button>
                    </div>
                  </div>
                  <div class="media-item">
                    <div class="media-placeholder">
                      <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="media-info">
                      <div class="media-title">Managing User Accounts</div>
                      <div class="media-description">See how to add, edit, and manage student and instructor accounts.</div>
                      <button style="margin-top: 12px; padding: 8px 12px; background: var(--green-main); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Watch Video</button>
                    </div>
                  </div>
                  <div class="media-item">
                    <div class="media-placeholder">
                      <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="media-info">
                      <div class="media-title">Dashboard Analytics Overview</div>
                      <div class="media-description">Understand key metrics and performance indicators on the dashboard.</div>
                      <button style="margin-top: 12px; padding: 8px 12px; background: var(--green-main); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Watch Video</button>
                    </div>
                  </div>
                  <div class="media-item">
                    <div class="media-placeholder">
                      <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="media-info">
                      <div class="media-title">Configuring Platform Settings</div>
                      <div class="media-description">Customize your platform appearance and settings to match your brand.</div>
                      <button style="margin-top: 12px; padding: 8px 12px; background: var(--green-main); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Watch Video</button>
                    </div>
                  </div>
                  <div class="media-item">
                    <div class="media-placeholder">
                      <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="media-info">
                      <div class="media-title">Security Best Practices</div>
                      <div class="media-description">Learn essential security measures to protect your platform and user data.</div>
                      <button style="margin-top: 12px; padding: 8px 12px; background: var(--green-main); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Watch Video</button>
                    </div>
                  </div>
                  <div class="media-item">
                    <div class="media-placeholder">
                      <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="media-info">
                      <div class="media-title">Troubleshooting Common Issues</div>
                      <div class="media-description">Solutions to frequently encountered problems and how to resolve them.</div>
                      <button style="margin-top: 12px; padding: 8px 12px; background: var(--green-main); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Watch Video</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 5. COMMON TERMINOLOGY -->
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-icon">
                    <i class="fas fa-book-open"></i>
                  </div>
                  <div>
                    <h3 class="feature-title">Common Terminology</h3>
                    <p class="feature-subtitle">Key terms and definitions used across the platform</p>
                  </div>
                </div>
                <div class="terminology-grid">
                  <div class="term-card">
                    <div class="term-name">Module</div>
                    <div class="term-definition">A self-contained unit of learning content that covers a specific topic within a course.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Course</div>
                    <div class="term-definition">A collection of modules organized around a specific subject, such as Solar Energy or Geothermal Systems.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Enrollment</div>
                    <div class="term-definition">The action of registering a student in a course, granting them access to course materials.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Progress Tracking</div>
                    <div class="term-definition">The system that monitors student completion of modules and courses, including quiz scores and time spent.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Instructor</div>
                    <div class="term-definition">A user role responsible for creating course content, managing students, and grading assignments.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Administrator</div>
                    <div class="term-definition">A user with elevated permissions to manage the entire platform, including users, courses, and system settings.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Certification</div>
                    <div class="term-definition">A credential awarded to students upon successful completion of a course and passing the final assessment.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Assessment</div>
                    <div class="term-definition">Quizzes, tests, or assignments used to evaluate student understanding and knowledge of course material.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Admin Panel</div>
                    <div class="term-definition">The main interface where admins monitor statistics, manage content, and access key features and tools.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">LMS</div>
                    <div class="term-definition">Learning Management System - the software platform used to deliver and manage online learning experiences.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">RET Hub</div>
                    <div class="term-definition">Renewable Energy Technology Hub - Aubie's comprehensive learning platform for renewable energy education.</div>
                  </div>
                  <div class="term-card">
                    <div class="term-name">Compliance</div>
                    <div class="term-definition">Adherence to educational standards, regulations, and institutional policies set for the platform.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- USERS TAB -->
          <div class="tab-panel" id="users-panel">
            <p style="color: var(--text-muted); margin-bottom: 20px;">Manage user accounts, roles, and permissions.</p>
          </div>

          <!-- COURSES TAB -->
          <div class="tab-panel" id="courses-panel">
            <p style="color: var(--text-muted); margin-bottom: 20px;">Create, edit, and manage courses and modules.</p>
          </div>

          <!-- ANALYTICS TAB -->
          <div class="tab-panel" id="analytics-panel">
            <p style="color: var(--text-muted); margin-bottom: 20px;">View detailed reports and analytics about platform usage and performance.</p>
          </div>

          <!-- SETTINGS TAB -->
          <div class="tab-panel" id="settings-panel">
            <p style="color: var(--text-muted); margin-bottom: 20px;">Configure platform settings, branding, and system preferences.</p>
          </div>

          <!-- INBOX TAB -->
          <div class="tab-panel" id="inbox-panel">
            <!-- Inbox content will be dynamically loaded here -->
          </div>

          <!-- LIVE CHAT TAB -->
          <div class="tab-panel" id="live-chat-panel">
            <p style="color: var(--text-muted); margin-bottom: 20px;">Manage incoming support requests and have real-time conversations with users.</p>

            <div style="display:grid;grid-template-columns:280px 1fr;gap:20px;height:550px;">
              <!-- SESSIONS SIDEBAR -->
              <section class="card" style="padding:0;display:flex;flex-direction:column;overflow:hidden;">
                <!-- Tab Navigation -->
                <div style="background:linear-gradient(135deg, var(--green-main) 0%, #005a4f 100%);color:#fff;padding:0;display:flex;border-bottom:1px solid rgba(255,255,255,0.2);">
                  <button id="tab-new-chats" class="chat-tab-btn" data-tab="new" style="flex:1;padding:12px 16px;border:none;background:transparent;color:#fff;font-weight:600;cursor:pointer;font-size:13px;border-bottom:3px solid rgba(255,255,255,0.5);transition:all 0.3s;">
                    <i class="fas fa-envelope" style="margin-right:6px;"></i>New
                  </button>
                  <button id="tab-attended-chats" class="chat-tab-btn" data-tab="attended" style="flex:1;padding:12px 16px;border:none;background:transparent;color:rgba(255,255,255,0.7);font-weight:600;cursor:pointer;font-size:13px;border-bottom:3px solid transparent;transition:all 0.3s;">
                    <i class="fas fa-check-circle" style="margin-right:6px;"></i>Attended
                  </button>
                </div>
                <!-- Sessions List -->
                <div id="sessions-list" style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:8px;background:var(--bg-main)"></div>
              </section>

              <!-- CONVERSATION AREA -->
              <section class="card" style="padding:0;display:flex;flex-direction:column;overflow:hidden;">
                <!-- Header -->
                <div id="conversation-header" style="background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:16px;display:none;align-items:center;justify-content:space-between;">
                  <div>
                    <h4 id="current-session-header" style="margin:0;font-size:15px;font-weight:600;color:var(--text-main)"></h4>
                    <small id="session-status" style="color:var(--text-muted);font-size:12px"></small>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button id="admin-delete" type="button" class="btn" style="padding:6px 12px;font-size:13px;border-color:#d32f2f;color:#d32f2f" title="Delete this chat permanently">
                      <i class="fas fa-trash" style="margin-right:4px;"></i>Delete
                    </button>
                    <button id="admin-terminate" type="button" class="btn" style="padding:6px 12px;font-size:13px;border-color:#ff9800;color:#ff9800" title="End this chat">
                      <i class="fas fa-times" style="margin-right:4px;"></i>Terminate
                    </button>
                  </div>
                </div>

                <!-- Messages Area -->
                <div id="conversation-wrap" style="display:none;flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 16px;background:var(--bg-main);position:relative;">
                  <div id="admin-messages" style="display:flex;flex-direction:column;gap:12px;"></div>
                  <div id="no-messages" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--text-muted);">                    <i class="fas fa-comments" style="font-size:36px;opacity:0.3;margin-bottom:8px;display:block;"></i>
                    <p style="margin:0;">No messages yet</p>
                  </div>
                </div>

                <!-- Empty State -->
                <div id="conversation-empty" style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px;text-align:center;color:var(--text-muted);">
                  <i class="fas fa-comments" style="font-size:48px;opacity:0.2;margin-bottom:12px;"></i>
                  <p style="margin:0;font-size:14px;">Select a chat to begin</p>
                </div>

                <!-- Input Area -->
                <form id="admin-reply-form" style="display:none;border-top:1px solid var(--border-color);padding:12px 16px;background:var(--bg-secondary);flex-direction:column;gap:8px;">
                  <div style="display:flex;gap:8px;align-items:flex-end;">
                    <input id="admin-from" placeholder="Your name" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-main);color:var(--text-main);width:120px;font-size:12px" />
                    <textarea id="admin-text" placeholder="Type your reply..." rows="1" style="flex:1;padding:8px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-main);color:var(--text-main);font-size:12px;resize:none;font-family:inherit;max-height:60px;"></textarea>
                    <button id="admin-send" class="btn-primary" type="submit" style="padding:6px 12px;align-self:flex-end;white-space:nowrap;font-size:12px;">
                      <i class="fas fa-paper-plane" style="margin-right:4px;"></i>Send
                    </button>
                  </div>
                  <div id="admin-notice" class="form-notice" style="margin:0;display:none;font-size:11px;padding:6px;border-radius:6px;"></div>
                </form>
              </section>
            </div>
          </div>

          <!-- DISCUSSIONS TAB -->
          <div class="tab-panel" id="discussions-panel">
            <div style="margin-bottom: 24px;">
              <h2 style="margin: 0 0 8px 0; font-size: 24px; color: var(--text-main);">
                <i class="fas fa-comments" style="margin-right: 10px; color: var(--green-main);"></i>Discussion Sessions
              </h2>
              <p style="margin: 0; color: var(--text-muted); font-size: 14px;">Create and manage live discussion sessions. Schedule for future dates or start immediately.</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; margin-bottom: 24px; height: 70vh;">
              <!-- CREATE NEW SESSION FORM -->
              <div class="card" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="display: flex; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                  <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--green-main), #00796b); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0;">
                    <i class="fas fa-plus" style="color: white; font-size: 16px;"></i>
                  </div>
                  <h3 style="margin: 0; font-size: 16px; color: var(--text-main);">Create New Session</h3>
                </div>
                
                <form id="create-discussion-form" style="display: flex; flex-direction: column; gap: 14px; flex: 1; overflow-y: auto; padding-right: 8px; min-width: 0; overflow-x: hidden;">
                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-book" style="margin-right: 4px; color: var(--green-main); font-size: 12px;"></i>Course *
                    </label>
                    <select id="disc-course-select" required style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); font-size: 12px; transition: all 0.3s; box-sizing: border-box;">
                      <option value="">-- Select a course --</option>
                    </select>
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-heading" style="margin-right: 4px; color: var(--green-main); font-size: 12px;"></i>Session Subject *
                    </label>
                    <input id="disc-subject" type="text" placeholder="e.g., Q&A Discussion" required style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 12px; transition: all 0.3s;" />
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-align-left" style="margin-right: 4px; color: var(--green-main); font-size: 12px;"></i>Description
                    </label>
                    <textarea id="disc-description" placeholder="Optional: Describe the topic" rows="2" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-family: inherit; font-size: 12px; resize: vertical; transition: all 0.3s;"></textarea>
                  </div>

                  <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <div>
                      <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                        <i class="fas fa-users" style="margin-right: 4px; color: var(--green-main); font-size: 12px;"></i>Type *
                      </label>
                      <select id="disc-type" required style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); font-size: 12px; box-sizing: border-box;">
                        <option value="peer">Peer Discussion</option>
                        <option value="instructor">Instructor-Led</option>
                      </select>
                    </div>
                  </div>

                  <div style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                    <label style="display: block; font-size: 11px; font-weight: 700; color: var(--text-main); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.3px;">
                      <i class="fas fa-clock" style="margin-right: 4px; color: var(--green-main); font-size: 11px;"></i>Schedule
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                      <div>
                        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Start *</label>
                        <input id="disc-start-time" type="datetime-local" required style="width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 11px;" />
                      </div>
                      <div>
                        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">End *</label>
                        <input id="disc-end-time" type="datetime-local" required style="width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 11px;" />
                      </div>
                    </div>
                  </div>

                  <div id="disc-form-notice" style="padding: 10px 12px; border-radius: 6px; font-size: 12px; display: none; margin-top: 6px; border-left: 3px solid var(--green-main); background: rgba(0, 121, 107, 0.08);"></div>

                  <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button id="disc-create-btn" class="btn-primary" type="submit" style="flex: 1; padding: 10px 12px; font-weight: 600; font-size: 12px; border-radius: 6px;">
                      <i class="fas fa-check-circle" style="margin-right: 4px; font-size: 12px;"></i>Create
                    </button>
                    <button id="disc-clear-btn" class="btn" type="reset" style="padding: 10px 12px; font-size: 12px; border-radius: 6px;">Reset</button>
                  </div>
                </form>
              </div>

              <!-- SESSIONS OVERVIEW -->
              <div class="card" style="padding: 24px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="display: flex; align-items: center; margin-bottom: 24px; flex-shrink: 0;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0b6fb7, #0d47a1); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <i class="fas fa-calendar-check" style="color: white; font-size: 18px;"></i>
                  </div>
                  <h3 style="margin: 0; font-size: 18px; color: var(--text-main);">Active & Upcoming</h3>
                </div>

                <!-- Session Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); overflow-x: auto; padding-bottom: 12px; flex-shrink: 0;">
                  <button class="disc-tab-btn" data-tab="all" style="padding: 8px 16px; border: none; background: none; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -12px; transition: all 0.3s; white-space: nowrap;">
                    <i class="fas fa-th-list" style="margin-right: 6px;"></i>All Sessions
                  </button>
                  <button class="disc-tab-btn" data-tab="active" style="padding: 8px 16px; border: none; background: none; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -12px; transition: all 0.3s; white-space: nowrap;">
                    <i class="fas fa-circle" style="margin-right: 6px; color: #4caf50;"></i>Active
                  </button>
                  <button class="disc-tab-btn" data-tab="upcoming" style="padding: 8px 16px; border: none; background: none; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -12px; transition: all 0.3s; white-space: nowrap;">
                    <i class="fas fa-clock" style="margin-right: 6px; color: #ff9800;"></i>Upcoming
                  </button>
                </div>

                <div id="disc-sessions-list" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; min-height: 0; padding-right: 8px;">
                  <div style="padding: 40px 24px; text-align: center; color: var(--text-muted);">
                    <i class="fas fa-inbox" style="font-size: 40px; opacity: 0.2; display: block; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-size: 14px;">No sessions yet</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px;">Create one using the form on the left</p>
                  </div>
                </div>
              </div>
            </div>

            <style>
              .disc-tab-btn.active {
                color: var(--green-main) !important;
                border-bottom-color: var(--green-main) !important;
              }
              
              .disc-session-card {
                padding: 16px;
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                transition: all 0.3s ease;
              }
              
              .disc-session-card:hover {
                border-color: var(--green-main);
                box-shadow: 0 4px 12px rgba(0, 121, 107, 0.12);
              }

              .disc-session-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
              }

              .disc-session-title {
                font-weight: 600;
                font-size: 14px;
                color: var(--text-main);
                margin-bottom: 4px;
              }

              .disc-session-course {
                font-size: 12px;
                color: var(--text-muted);
              }

              .disc-session-badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                white-space: nowrap;
              }

              .disc-session-badge.active {
                background: rgba(76, 175, 80, 0.2);
                color: #4caf50;
              }

              .disc-session-badge.upcoming {
                background: rgba(255, 152, 0, 0.2);
                color: #ff9800;
              }

              .disc-session-badge.closed {
                background: rgba(244, 67, 54, 0.2);
                color: #f44336;
              }

              .disc-session-badge.peer {
                background: rgba(33, 150, 243, 0.1);
                color: #2196f3;
                margin-right: 6px;
              }

              .disc-session-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin: 12px 0;
                padding: 12px 0;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                font-size: 12px;
              }

              .disc-session-meta {
                display: flex;
                align-items: center;
                gap: 6px;
                color: var(--text-muted);
              }

              .disc-session-meta i {
                color: var(--green-main);
                width: 14px;
              }

              .disc-session-actions {
                display: flex;
                gap: 8px;
                margin-top: 12px;
              }

              .disc-session-btn {
                flex: 1;
                padding: 8px 12px;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
              }

              .disc-session-btn-primary {
                background: var(--green-main);
                color: white;
              }

              .disc-session-btn-primary:hover {
                background: #005a4f;
                box-shadow: 0 2px 8px rgba(0, 121, 107, 0.3);
              }

              .disc-session-btn-secondary {
                background: var(--bg-secondary);
                color: var(--text-main);
                border: 1px solid var(--border-color);
              }

              .disc-session-btn-secondary:hover {
                background: var(--border-color);
              }

              .disc-session-btn-danger {
                background: rgba(244, 67, 54, 0.1);
                color: #f44336;
                border: 1px solid rgba(244, 67, 54, 0.2);
              }

              .disc-session-btn-danger:hover {
                background: rgba(244, 67, 54, 0.2);
              }
            </style>
          </div>

          <!-- NEWS MANAGEMENT TAB -->
          <div class="tab-panel" id="news-panel">
            <div style="margin-bottom: 24px;">
              <h2 style="margin: 0 0 8px 0; font-size: 24px; color: var(--text-main);">
                <i class="fas fa-newspaper" style="margin-right: 10px; color: var(--green-main);"></i>News Management
              </h2>
              <p style="margin: 0; color: var(--text-muted); font-size: 14px;">Create, edit, and publish news articles with engagement tracking (likes, reactions, shares).</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start;">
              <!-- CREATE/EDIT NEWS FORM -->
              <div class="card" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                  <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--green-main), #00796b); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                    <i class="fas fa-plus" style="color: white; font-size: 16px;"></i>
                  </div>
                  <h3 id="news-form-title" style="margin: 0; font-size: 16px; color: var(--text-main);">Create News Article</h3>
                </div>
                
                <form id="news-form" style="display: flex; flex-direction: column; gap: 14px;">
                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-heading" style="margin-right: 4px; color: var(--green-main);"></i>Title *
                    </label>
                    <input id="news-title" type="text" placeholder="Article title" required style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 12px;" />
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-link" style="margin-right: 4px; color: var(--green-main);"></i>Slug *
                    </label>
                    <input id="news-slug" type="text" placeholder="article-url-slug" required style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 12px;" />
                    <small style="color: var(--text-muted); font-size: 11px; display: block; margin-top: 4px;">URL-friendly slug (lowercase, hyphens). Auto-generated from title if empty.</small>
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-image" style="margin-right: 4px; color: var(--green-main);"></i>Cover Image URL
                    </label>
                    <input id="news-image" type="url" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 12px;" />
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-paragraph" style="margin-right: 4px; color: var(--green-main);"></i>Excerpt
                    </label>
                    <textarea id="news-excerpt" placeholder="Brief summary (optional, auto-generated from content if empty)" rows="2" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-family: inherit; font-size: 12px; resize: vertical;"></textarea>
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-pen" style="margin-right: 4px; color: var(--green-main);"></i>Content *
                    </label>
                    <textarea id="news-content" placeholder="Article content (markdown supported)" required rows="8" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                  </div>

                  <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 6px;">
                      <i class="fas fa-user" style="margin-right: 4px; color: var(--green-main);"></i>Author
                    </label>
                    <input id="news-author" type="text" placeholder="Author name" style="width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main); box-sizing: border-box; font-size: 12px;" />
                    <small style="color: var(--text-muted); font-size: 11px; display: block; margin-top: 4px;">Auto-filled with your name if empty.</small>
                  </div>

                  <div id="news-form-notice" style="padding: 10px 12px; border-radius: 6px; font-size: 12px; display: none; margin: 6px 0; border-left: 3px solid var(--green-main); background: rgba(0, 121, 107, 0.08);"></div>

                  <div style="display: flex; gap: 8px;">
                    <button id="news-save-draft" class="btn" type="button" style="flex: 1; padding: 10px 12px; font-weight: 600; font-size: 12px; border-radius: 6px;">
                      <i class="fas fa-save" style="margin-right: 4px;"></i>Save Draft
                    </button>
                    <button id="news-publish" class="btn-primary" type="button" style="flex: 1; padding: 10px 12px; font-weight: 600; font-size: 12px; border-radius: 6px;">
                      <i class="fas fa-paper-plane" style="margin-right: 4px;"></i>Publish
                    </button>
                    <button id="news-cancel" class="btn" type="button" style="flex: 0.5; padding: 10px 12px; font-size: 12px; border-radius: 6px; display: none;">Cancel</button>
                  </div>
                </form>
              </div>

              <!-- NEWS LIST & MANAGEMENT -->
              <div class="card" style="padding: 24px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="display: flex; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #00796b, #005a4f); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <i class="fas fa-list" style="color: white; font-size: 18px;"></i>
                  </div>
                  <h3 style="margin: 0; font-size: 18px; color: var(--text-main);">Published & Drafts</h3>
                </div>

                <!-- News Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); overflow-x: auto; padding-bottom: 12px; flex-shrink: 0;">
                  <button class="news-tab-btn" data-tab="published" style="padding: 8px 16px; border: none; background: none; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -12px; transition: all 0.3s; white-space: nowrap;">
                    <i class="fas fa-check-circle" style="margin-right: 6px; color: #4caf50;"></i>Published
                  </button>
                  <button class="news-tab-btn" data-tab="drafts" style="padding: 8px 16px; border: none; background: none; color: var(--text-muted); font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -12px; transition: all 0.3s; white-space: nowrap;">
                    <i class="fas fa-file-alt" style="margin-right: 6px; color: #ff9800;"></i>Drafts
                  </button>
                </div>

                <div id="news-list" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; min-height: 0; padding-right: 8px;">
                  <div style="padding: 40px 24px; text-align: center; color: var(--text-muted);">
                    <i class="fas fa-inbox" style="font-size: 40px; opacity: 0.2; display: block; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-size: 14px;">No articles yet</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px;">Create your first article using the form on the left</p>
                  </div>
                </div>
              </div>
            </div>

            <style>
              .news-tab-btn.active {
                color: var(--green-main) !important;
                border-bottom-color: var(--green-main) !important;
              }
              
              .news-card {
                padding: 16px;
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                transition: all 0.3s ease;
              }
              
              .news-card:hover {
                border-color: var(--green-main);
                box-shadow: 0 4px 12px rgba(0, 121, 107, 0.12);
              }

              .news-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
              }

              .news-card-title {
                font-weight: 600;
                font-size: 14px;
                color: var(--text-main);
                margin-bottom: 4px;
                word-break: break-word;
              }

              .news-card-slug {
                font-size: 12px;
                color: var(--text-muted);
              }

              .news-card-badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                white-space: nowrap;
              }

              .news-card-badge.published {
                background: rgba(76, 175, 80, 0.2);
                color: #4caf50;
              }

              .news-card-badge.draft {
                background: rgba(255, 152, 0, 0.2);
                color: #ff9800;
              }

              .news-card-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin: 12px 0;
                padding: 8px 0;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                font-size: 12px;
              }

              .news-card-stat {
                display: flex;
                align-items: center;
                gap: 4px;
                color: var(--text-muted);
              }

              .news-card-stat i {
                color: var(--green-main);
                width: 14px;
              }

              .news-card-actions {
                display: flex;
                gap: 6px;
                margin-top: 12px;
                flex-wrap: wrap;
              }

              .news-card-btn {
                flex: 1;
                min-width: 70px;
                padding: 6px 8px;
                border: none;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
              }

              .news-card-btn-primary {
                background: var(--green-main);
                color: white;
              }

              .news-card-btn-primary:hover {
                background: #005a4f;
                box-shadow: 0 2px 8px rgba(0, 121, 107, 0.3);
              }

              .news-card-btn-secondary {
                background: var(--bg-secondary);
                color: var(--text-main);
                border: 1px solid var(--border-color);
              }

              .news-card-btn-secondary:hover {
                background: var(--border-color);
              }

              .news-card-btn-danger {
                background: rgba(244, 67, 54, 0.1);
                color: #f44336;
                border: 1px solid rgba(244, 67, 54, 0.2);
              }

              .news-card-btn-danger:hover {
                background: rgba(244, 67, 54, 0.2);
              }
            </style>
          </div>

          <!-- MODULES TAB PANEL -->
          <div class="tab-panel" id="modules-panel">
            <p style="color:var(--text-muted);margin-bottom:20px;">Select a course to manage its modules (add / delete).</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start;">
              <div class="card" style="padding:16px;">
                <h4 style="margin-top:0;margin-bottom:12px;font-size:16px;">Courses</h4>
                <select id="mm-course-select" style="width:100%;padding:10px;border-radius:8px;margin-bottom:16px;border:1px solid #e6eef4;"></select>
                <h4 style="margin:0 0 12px 0;font-size:14px;color:#3b2466;">Modules in Course</h4>
                <div id="mm-modules-list" style="max-height:500px;overflow-y:auto;border:1px solid #e6eef4;border-radius:8px;background:#fff;"></div>
              </div>

              <div>
                <div id="mm-add-card" class="card" style="padding:16px;display:block;"><h4 style="margin-top:0;margin-bottom:16px;">Add New Module</h4>
                  <form id="mm-add-form" style="display:flex;flex-direction:column;gap:12px;">
                    <input id="mm-id" placeholder="Module id (optional, e.g. module-1)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-title" placeholder="Module title" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-category" placeholder="Category (e.g. solar, wind, general)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-file" placeholder="File name (e.g. module-1-intro.md)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-tag" placeholder="Tag (optional, e.g. fundamentals)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <label style="display:flex;align-items:center;gap:8px;padding:8px 0;"><input id="mm-isPremium" type="checkbox" style="width:18px;height:18px;" /> <span style="font-size:13px;color:var(--text-muted);">Premium module</span></label>
                    <div style="border:1px dashed #ddd;padding:12px;border-radius:6px;background:#fafafa">
                      <label style="font-weight:600;display:block;margin-bottom:8px;">Module Video (optional)</label>
                      <div style="display:flex;gap:8px;margin-bottom:8px">
                        <input id="mm-add-video" placeholder="https://example.com/video.mp4 or /videos/..." style="padding:10px;border-radius:6px;border:1px solid #e6eef4;flex:1;" />
                        <button type="button" id="mm-add-upload-video-btn" class="btn-primary" style="padding:10px 16px;white-space:nowrap">Upload Video</button>
                        <button type="button" id="mm-add-delete-video-btn" class="btn" style="padding:10px 16px;white-space:nowrap;color:#d32f2f;border-color:#d32f2f">Delete Video</button>
                      </div>
                      <small style="color:var(--text-muted);display:block">Upload a local video (MP4, WebM) or paste a URL. Premium users will see this video in the module.</small>
                    </div>
                    <textarea id="mm-content" placeholder="Initial content (markdown)" rows="6" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;font-family:monospace;font-size:13px;"></textarea>
                    <button class="btn-primary" type="submit" style="padding:12px;font-weight:600;">Create Module</button>
                  </form>
                </div>
                <div id="mm-edit-card" class="card" style="padding:16px;display:none;"><h4 style="margin-top:0;margin-bottom:16px;">Edit Module Details</h4>
                  <form id="mm-edit-form" style="display:flex;flex-direction:column;gap:12px;">
                    <input id="mm-edit-courseId" type="hidden" />
                    <input id="mm-edit-file" type="hidden" />
                    <input id="mm-edit-id" placeholder="Module id (optional)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-edit-title" placeholder="Module title" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-edit-category" placeholder="Category (e.g. solar, wind, general)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <input id="mm-edit-tag" placeholder="Tag (optional, e.g. fundamentals)" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;" />
                    <label style="display:flex;align-items:center;gap:8px;padding:8px 0;"><input id="mm-edit-isPremium" type="checkbox" style="width:18px;height:18px;" /> <span style="font-size:13px;color:var(--text-muted);">Premium module</span></label>
                    <div style="border:1px dashed #ddd;padding:12px;border-radius:6px;background:#fafafa">
                      <label style="font-weight:600;display:block;margin-bottom:8px;">Module Video (optional)</label>
                      <div style="display:flex;gap:8px;margin-bottom:8px">
                        <input id="mm-edit-video" placeholder="https://example.com/video.mp4 or /videos/..." style="padding:10px;border-radius:6px;border:1px solid #e6eef4;flex:1;" />
                        <button type="button" id="mm-upload-video-btn" class="btn-primary" style="padding:10px 16px;white-space:nowrap">Upload Video</button>
                        <button type="button" id="mm-edit-delete-video-btn" class="btn" style="padding:10px 16px;white-space:nowrap;color:#d32f2f;border-color:#d32f2f">Delete Video</button>
                      </div>
                      <small style="color:var(--text-muted);display:block">Upload a local video (MP4, WebM) or paste a URL. Premium users will see this video in the module.</small>
                    </div>
                    <textarea id="mm-edit-content" placeholder="Module content (markdown)" rows="6" style="padding:10px;border-radius:6px;border:1px solid #e6eef4;font-family:monospace;font-size:13px;"></textarea>
                    <div style="display:flex;gap:12px;margin-top:8px;">
                      <button class="btn-primary" type="submit" style="flex:1;padding:12px;font-weight:600;">Save Changes</button>
                      <button type="button" id="mm-edit-cancel" class="btn" style="padding:12px;">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="content-panel">
            <p style="color:var(--text-muted);">Select a course and module to edit the markdown content.</p>
            <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
              <div style="flex:0 0 300px"><div class="card" style="padding:12px">
                <h4>Course</h4>
                <select id="cm-course-select" style="width:100%;padding:8px;border-radius:8px;margin-bottom:12px"></select>
                <h4 style="margin-top:6px">Modules</h4>
                <div id="cm-modules-list" style="max-height:420px;overflow:auto"></div>
              </div></div>

              <div style="flex:1;min-width:320px"><div class="card" style="padding:12px">
                <h4 id="cm-editor-title">Module Editor</h4>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
                  <label style="font-size:13px;color:var(--text-muted);margin-right:8px">Editor mode:</label>
                  <select id="cm-editor-mode" style="padding:6px;border-radius:6px">
                    <option value="markdown">Markdown</option>
                    <option value="wysiwyg">WYSIWYG</option>
                  </select>
                  <button id="cm-fullscreen-btn" class="btn" style="margin-left:auto">Full screen</button>
                  <button id="cm-preview-btn" class="btn" style="margin-left:8px">Preview</button>
                  <button id="cm-insert-image-btn" class="btn" style="margin-left:8px" title="Insert image: ![alt](url)">ðŸ–¼ï¸ Insert Image</button>
                  <button id="cm-edit-objectives-btn" class="btn" style="margin-left:8px">Edit Objectives</button>
                  <button id="cm-edit-quiz-btn" class="btn" style="margin-left:8px">Edit Quiz</button>
                  <button id="cm-edit-projects-btn" class="btn" style="margin-left:8px">Edit Projects</button>
                    <button id="cm-edit-resources-btn" class="btn" style="margin-left:8px"><i class="fas fa-link"></i> Add Resources</button>
                </div>
                <div id="cm-editor-area" style="display:flex;flex-direction:column;gap:8px">
                  <textarea id="cm-content-editor" rows="20" style="width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef4"></textarea>
                  <div id="cm-quill-container" style="display:none"><div id="cm-quill-editor" style="height:360px;background:#fff"></div></div>
                  <div id="cm-preview" style="display:none;border:1px solid #e6eef4;padding:12px;border-radius:8px;background:#fff;max-height:420px;overflow:auto"></div>
                  <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cm-save-btn" class="btn-primary">Save</button></div>
                </div>
              </div></div>
            </div>
          </div>
          <div class="tab-panel" id="documents-panel">
            <div style="background:#f0f9ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin-bottom:20px;">
              <p style="margin:0;color:#1e40af;font-size:14px;">
                <strong>Manage Pending Documents</strong><br/>
                <span style="font-size:12px;color:#0c4a6e;">Finalize courses with modules and content before deploying. Expand any course to manage its pending modules and content.</span>
              </p>
            </div>
            <div style="display:flex;flex-direction:column;gap:20px;margin-top:12px;">
              <!-- Pending Courses with Module Management -->
              <div style="border:1px solid #e6eef4;border-radius:8px;padding:16px;">
                <h4 style="margin-top:0;margin-bottom:16px;font-size:16px;color:#1f2937;">
                  <i class="fas fa-book" style="margin-right:8px;color:#0ea5e9;"></i>Pending Courses
                </h4>
                <div id="pending-courses-list" style="display:flex;flex-direction:column;gap:12px;"></div>
              </div>
              
              <!-- Standalone Pending Modules (for already-deployed courses) -->
              <div style="border:1px solid #e6eef4;border-radius:8px;padding:16px;">
                <h4 style="margin-top:0;margin-bottom:12px;font-size:16px;color:#1f2937;">
                  <i class="fas fa-cube" style="margin-right:8px;color:#8b5cf6;"></i>Pending Modules (Standalone)
                </h4>
                <p style="margin:0 0 12px 0;font-size:13px;color:#6b7280;">Module details for already-deployed courses</p>
                <div id="pending-modules-metadata-list" style="display:flex;flex-direction:column;gap:8px;"></div>
              </div>
              
              <!-- Pending Content -->
              <div style="border:1px solid #e6eef4;border-radius:8px;padding:16px;">
                <h4 style="margin-top:0;margin-bottom:12px;font-size:16px;color:#1f2937;">
                  <i class="fas fa-file-alt" style="margin-right:8px;color:#ec4899;"></i>Pending Content (Markdown)
                </h4>
                <p style="margin:0 0 12px 0;font-size:13px;color:#6b7280;">Module markdown content changes</p>
                <div id="pending-content-list" style="display:flex;flex-direction:column;gap:8px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Video Upload Modal -->
    <div id="video-upload-modal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-width:600px;padding:24px;">
        <h3 style="margin:0 0 16px 0;font-size:18px;color:var(--text-main);">Upload Module Video</h3>
        
        <!-- Upload Zone -->
        <div id="video-upload-zone" style="border:2px dashed var(--border-color);border-radius:8px;padding:32px;text-align:center;cursor:pointer;transition:all 0.3s ease;margin-bottom:16px;background:rgba(0,121,107,0.02)">
          <i class="fas fa-cloud-upload-alt" style="font-size:36px;color:var(--green-main);display:block;margin-bottom:12px"></i>
          <p style="margin:0 0 4px 0;color:var(--text-main);font-weight:600;">Drag and drop your video here</p>
          <p style="margin:0;font-size:12px;color:var(--text-secondary);">or click to browse</p>
        </div>
        <input type="file" id="video-upload-input" accept="video/*" style="display:none;">
        
        <!-- Progress -->
        <div id="video-upload-progress" style="display:none;margin-bottom:16px;">
          <div style="height:6px;background:#e6eef4;border-radius:3px;overflow:hidden;margin-bottom:8px">
            <div id="video-progress-bar" style="height:100%;background:linear-gradient(90deg,var(--green-main),#00d4a8);width:0%;transition:width 0.3s ease"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-secondary)">
            <span id="video-status">Uploading...</span>
            <span id="video-percent">0%</span>
          </div>
        </div>

        <!-- Result -->
        <div id="video-upload-result" style="display:none;margin-bottom:16px;padding:12px;border-radius:6px;background:#d4edda;border:1px solid #c3e6cb">
          <div style="color:#155724;font-size:14px">
            <strong>âœ“ Upload successful!</strong>
            <div style="margin-top:8px;padding:8px;background:white;border-radius:4px;font-family:monospace;font-size:11px;word-break:break-all" id="video-url-display"></div>
          </div>
        </div>

        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button type="button" id="video-upload-cancel" class="modal-btn modal-btn-secondary">Cancel</button>
          <button type="button" id="video-upload-use" class="modal-btn modal-btn-primary" style="display:none;">Use This Video</button>
        </div>
      </div>
    </div>

    </div>
  </main>

  <script>
    // Prevent global nav UI logic from running on admin dashboard
    window._skipGlobalNavUI = true;
  </script>
  <script src="js/core/dashboardDefense.js"></script>
  <script src="js/core/storageSync.js"></script>

  <!-- Notification Service (must load BEFORE main.js) -->
  <script src="js/core/notificationService.js"></script>

  <!-- Notification Triggers -->
  <script src="js/core/notificationTriggers.js"></script>

  <script src="js/main.js"></script>

  <script>
      // Load marked and Quill dynamically for content editing/preview
      const _loadEditors = (function(){
        let loaded = false;
        return async function() {
          if (loaded) return;
          loaded = true;
          try {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            s.onload = () => {
              // Configure marked to render HTML properly
              if (typeof marked !== 'undefined') {
                // Set marked options - use lexer + renderer pattern
                marked.setOptions({ 
                  breaks: true, 
                  gfm: true,
                  pedantic: false
                });
              }
            };
            document.head.appendChild(s);
          } catch (e) { console.warn('failed to load marked', e); }
          try {
            const hlCss = document.createElement('link'); hlCss.rel = 'stylesheet'; hlCss.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css'; document.head.appendChild(hlCss);
            const hl = document.createElement('script'); hl.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js'; document.head.appendChild(hl);
          } catch (e) { console.warn('failed to load highlight.js', e); }
          try {
            const katexCss = document.createElement('link'); katexCss.rel = 'stylesheet'; katexCss.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css'; document.head.appendChild(katexCss);
            const katex = document.createElement('script'); katex.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js'; document.head.appendChild(katex);
            const ar = document.createElement('script'); ar.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js'; document.head.appendChild(ar);
          } catch (e) { console.warn('failed to load katex', e); }
        };
      })();

      // ===== ENTER KEY SUPPORT FOR TEXTAREAS =====
      // Helper function to enable Enter key submission for forms (Shift+Enter for newline)
      function enableEnterSubmit(textareaId, formId) {
        const textarea = document.getElementById(textareaId);
        const form = document.getElementById(formId);
        if (!textarea || !form) return;
        
        textarea.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
          }
        });
      }

    // ===== LOGIN/LOGOUT LOGIC =====
    const loginMainSection = null;
    const loginSidebarSection = null;
    const navLinksSection = document.getElementById('admin-nav-links');
    const dashboardSection = document.getElementById('admin-dashboard-section');
    const logoutLink = document.getElementById('logout-link');
    const adminSidebar = document.getElementById('admin-sidebar');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');

    // Check if admin is already logged in
    function checkAdminLogin() {
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        showDashboard();
      } else {
        // Redirect to admin login page if not authenticated
        window.location.href = 'admin-login.html';
      }
    }

    // This function is no longer used (login forms removed)
    function showLogin() {
      console.log('ðŸ”“ showLogin() called - redirecting to admin-login.html');
      window.location.href = 'admin-login.html';
    }

    function showDashboard() {
      console.log('ðŸ” showDashboard() called - displaying dashboard');
      if (loginSidebarSection) { loginSidebarSection.style.display = 'none'; loginSidebarSection.style.visibility = 'hidden'; }
      if (loginMainSection) { loginMainSection.style.display = 'none'; loginMainSection.style.visibility = 'hidden'; }
      if (navLinksSection) { navLinksSection.style.display = 'block'; navLinksSection.style.visibility = 'visible'; }
      if (dashboardSection) { dashboardSection.style.display = 'block'; dashboardSection.style.visibility = 'visible'; }
      
      // Setup profile menu
      const profileCircle = document.getElementById('profile-circle');
      const profileDropdown = document.getElementById('profile-dropdown');
      const adminName = localStorage.getItem('adminName') || 'Admin';
      const adminRole = localStorage.getItem('adminRole') || 'superadmin';
      const firstLetter = (adminName.charAt(0) || 'A').toUpperCase();
      
      console.log('Profile Setup - Name:', adminName, 'Role:', adminRole, 'Letter:', firstLetter);

      // Fullscreen toggle setup
      const fsBtn = document.getElementById('fullscreen-toggle');
      function isFullScreen() {
        return !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
      }
      function updateFsIcon() {
        const ic = document.querySelector('#fullscreen-toggle i');
        if (!ic) return;
        ic.className = isFullScreen() ? 'fas fa-compress' : 'fas fa-expand';
      }
      if (fsBtn) {
        fsBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (!isFullScreen()) {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
            else if (el.msRequestFullscreen) el.msRequestFullscreen();
          } else {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
            else if (document.msExitFullscreen) document.msExitFullscreen();
          }
        }, false);
        document.addEventListener('fullscreenchange', updateFsIcon);
        document.addEventListener('webkitfullscreenchange', updateFsIcon);
        document.addEventListener('mozfullscreenchange', updateFsIcon);
        document.addEventListener('MSFullscreenChange', updateFsIcon);
        updateFsIcon();
      }
      
      if (profileCircle) {
        profileCircle.textContent = firstLetter;
        profileCircle.style.display = 'flex';
        profileCircle.style.pointerEvents = 'auto';
        console.log('Profile circle set to:', firstLetter);
        
        // Remove old listeners to prevent duplicates
        const newCircle = profileCircle.cloneNode(true);
        profileCircle.parentNode.replaceChild(newCircle, profileCircle);
        const newProfileCircle = document.getElementById('profile-circle');
        
        // Toggle dropdown on circle click
        newProfileCircle.addEventListener('click', (e) => {
          console.log('Profile circle clicked!');
          e.stopPropagation();
          const dropdown = document.getElementById('profile-dropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }, false);
      }
      
      const profileNameEl = document.getElementById('profile-name');
      const profileRoleEl = document.getElementById('profile-role');
      if (profileNameEl) profileNameEl.textContent = adminName;
      if (profileRoleEl) profileRoleEl.textContent = adminRole;
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('profile-dropdown');
        const circle = document.getElementById('profile-circle');
        if (dropdown && circle && !circle.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      }, false);
      
      // Logout from profile menu
      const logoutBtn = document.getElementById('profile-logout-btn');
      if (logoutBtn) {
        const newLogoutBtn = logoutBtn.cloneNode(true);
        logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
        const newBtn = document.getElementById('profile-logout-btn');
        
        newBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('Logout clicked from profile menu');
          const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?', 'warning');
          if (!confirmed) return;
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminEmail');
          localStorage.removeItem('adminName');
          localStorage.removeItem('adminRole');
          localStorage.setItem('isAdmin', 'false');
          await showAlert('Logged Out', 'You have been successfully logged out.', 'info');
          showLogin();
        }, false);
      }

      // Theme toggle from profile menu
      const themeToggleBtn = document.getElementById('profile-theme-toggle');
      if (themeToggleBtn) {
        const newThemeBtn = themeToggleBtn.cloneNode(true);
        themeToggleBtn.parentNode.replaceChild(newThemeBtn, themeToggleBtn);
        const newBtn = document.getElementById('profile-theme-toggle');
        
        // Update button text on page load
        function updateThemeButtonText() {
          const isDark = document.body.classList.contains('dark');
          const icon = newBtn.querySelector('i');
          const span = newBtn.querySelector('span');
          if (isDark) {
            icon.className = 'fas fa-sun';
            if (span) span.textContent = 'Light Mode';
          } else {
            icon.className = 'fas fa-moon';
            if (span) span.textContent = 'Dark Mode';
          }
        }
        updateThemeButtonText();
        
        newBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          document.body.classList.toggle('dark');
          localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
          updateThemeButtonText();
        }, false);
      }
      if (logoutLink) logoutLink.style.display = 'inline-block';
      if (typeof mobileMenuToggle !== 'undefined' && mobileMenuToggle) mobileMenuToggle.style.display = 'block';
      // Enforce role-based UI visibility
      try { enforceRoleUI(); } catch(e){}
      // open dashboard home by default
      try {
        loadTabContent('home');
        // mark sidebar link active
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const homeLink = document.querySelector('.sidebar-link[data-tab="home"]'); if (homeLink) homeLink.classList.add('active');
        if (typeof loadHomeUI === 'function') loadHomeUI();
      } catch(e){}
    }

    function enforceRoleUI() {
      const role = localStorage.getItem('adminRole') || 'superadmin';
      // default: show everything for superadmin
      if (role === 'superadmin') return;
      // hide system-level links for non-superadmins
      const hideForAdmin = ['.sidebar-link[data-tab="settings"]', '.sidebar-link[data-tab="documents"]'];
      const hideForInstructor = ['.sidebar-link[data-tab="users"]', '.sidebar-link[data-tab="analytics"]', '.sidebar-link[data-tab="settings"]', '.sidebar-link[data-tab="documents"]'];

      if (role === 'admin') {
        hideForAdmin.forEach(s => { document.querySelectorAll(s).forEach(el => el.style.display = 'none'); });
      }
      if (role === 'instructor') {
        hideForInstructor.forEach(s => { document.querySelectorAll(s).forEach(el => el.style.display = 'none'); });
      }
    }


    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?', 'warning');
        if (!confirmed) return;
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminEmail');
        localStorage.setItem('isAdmin', 'false');
        await showAlert('Logged Out', 'You have been successfully logged out.', 'info');
      } catch (err) {
        // ignore alert errors
      }
      showLogin();
    });

    // Mobile menu toggle (only if element exists)
    if (typeof mobileMenuToggle !== 'undefined' && mobileMenuToggle) {
      mobileMenuToggle.addEventListener('click', () => {
        adminSidebar.classList.toggle('mobile-open');
      });
    }

    // Close mobile menu when clicking a link
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', () => {
        adminSidebar.classList.remove('mobile-open');
      });
    });

    // Sidebar link click handler
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tabName = link.getAttribute('data-tab');
        
        // Remove active from all sidebar links
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        
        // Add active to clicked link
        link.classList.add('active');
        
        // Load the corresponding tab content
        loadTabContent(tabName);
        onTabActivated(tabName);
      });
    });

    function loadTabContent(tabName) {
      const container = document.querySelector('.tabs-content');
      
      // Map of tab names to their panel IDs
      const tabMap = {
        'home': 'home-panel',
        'getting-started': 'getting-started-panel',
        'users': 'users-panel',
        'courses': 'courses-panel',
        'analytics': 'analytics-panel',
        'settings': 'settings-panel',
        'inbox': 'inbox-panel',
        'live-chat': 'live-chat-panel',
        'discussions': 'discussions-panel',
        'news': 'news-panel',
        'modules': 'modules-panel',
        'content': 'content-panel',
        'documents': 'documents-panel'
      };

      // Human friendly titles for each tab
      const titleMap = {
        'home': 'Dashboard Home',
        'getting-started': 'Getting Started',
        'users': 'Users',
        'courses': 'Courses',
        'analytics': 'Analytics',
        'settings': 'Settings',
        'inbox': 'Inbox',
        'live-chat': 'Live Chat',
        'discussions': 'Discussions',
        'news': 'News',
        'modules': 'Modules',
        'content': 'Content',
        'documents': 'Documents'
      };

      const panelId = tabMap[tabName];
      if (panelId) {
        const panels = container.querySelectorAll('.tab-panel');
        panels.forEach(p => p.classList.remove('active'));
        
        let panel = document.getElementById(panelId);
        if (!panel) {
          // Create panel if it doesn't exist
          panel = document.createElement('div');
          panel.id = panelId;
          panel.className = 'tab-panel';
          container.appendChild(panel);
        }

        // Set the shared panel heading (displayed outside the card area)
        const title = titleMap[tabName] || '';
        const sharedH2 = document.querySelector('.panel-heading-area .tab-heading h2');
        if (sharedH2) sharedH2.textContent = title;

        panel.classList.add('active');
      }
    }

    // Check on page load
    checkAdminLogin();
    console.log('âœ… Admin dashboard loaded, checkAdminLogin() called. adminToken =', localStorage.getItem('adminToken'));

    // Ensure login state is re-evaluated when page is restored from bfcache
    window.addEventListener('pageshow', (ev) => { 
      try { 
        checkAdminLogin(); 
        console.log('âœ… pageshow event: checkAdminLogin() called. adminToken =', localStorage.getItem('adminToken'));
      } catch (e) { console.error('Error in pageshow checkAdminLogin:', e); }
    });

    // ===== DASHBOARD PROTECTION SYSTEM =====
    // Monitor the dashboard for crashes and unexpected issues
    (function initDashboardProtection() {
      if (typeof DashboardDefense === 'undefined') {
        console.warn('DashboardDefense module not loaded - protection disabled');
        return;
      }

      // Wrap all critical DOM operations with error boundaries
      const originalShowLogin = showLogin;
      const originalShowDashboard = showDashboard;
      const originalLoadTab = typeof loadTabContent !== 'undefined' ? loadTabContent : null;

      // Protected showLogin function
      window.showLogin = function() {
        DashboardDefense.safeExecute(() => {
          originalShowLogin.call(this);
        }, 'showLogin()');
      };

      // Protected showDashboard function
      window.showDashboard = function() {
        DashboardDefense.safeExecute(() => {
          originalShowDashboard.call(this);
        }, 'showDashboard()');
      };

      // Monitor for common dashboard errors
      const errorHandler = (event) => {
        // Prevent cascade failures
        event.preventDefault();
        console.error('ðŸ›¡ï¸ Dashboard error caught by protection system:', event.error);
        
        // Try to recover by reloading critical elements
        DashboardDefense.safeExecute(() => {
          if (localStorage.getItem('adminToken')) {
            console.log('Attempting to recover dashboard state...');
            checkAdminLogin();
          }
        }, 'error recovery');
      };

      window.addEventListener('error', errorHandler);

      // Monitor unhandled promise rejections
      window.addEventListener('unhandledrejection', (event) => {
        console.error('ðŸ›¡ï¸ Unhandled promise rejection in dashboard:', event.reason);
        // Don't prevent default to allow graceful handling
      });

      // Periodically verify critical elements exist
      const checkCriticalElements = () => {
        const criticalElements = {
          'header': '.site-header',
          'sidebar': '#admin-sidebar',
          'main content': '#admin-dashboard-section',
          'login section': '#admin-login-main'
        };

        let allPresent = true;
        Object.entries(criticalElements).forEach(([name, selector]) => {
          const elem = DashboardDefense.safeGetElement(selector, `critical element: ${name}`);
          if (!elem) {
            console.warn(`Critical element missing: ${name}`);
            allPresent = false;
          }
        });

        if (!allPresent) {
          console.warn('Some critical elements are missing - dashboard may be unstable');
        }

        return allPresent;
      };

      // Run check after a short delay to ensure DOM is ready, then periodically
      setTimeout(() => {
        checkCriticalElements();
        setInterval(checkCriticalElements, 30000); // Check every 30 seconds
      }, 500); // Wait 500ms for DOM to fully render

      // Log successful protection initialization
      console.log('âœ… Dashboard protection system initialized');
      console.log('   - Error boundaries enabled');
      console.log('   - Element validation enabled');
      console.log('   - Critical element monitoring enabled (30s interval)');
    })();

    // ----- Admin panel loaders (define first) -----
    function escapeHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function loadUsersUI() {
      const container = document.getElementById('users-panel');
      if (!container) return;
      let body = container.querySelector('.tab-body');
      if (!body) { body = document.createElement('div'); body.className = 'tab-body'; container.appendChild(body); }
      body.innerHTML = '' +
        '<div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">' +
        '<div style="flex:1;min-width:300px"><div id="users-list" class="card" style="padding:12px"></div></div>' +
        '<div style="flex:1;min-width:320px"><div class="card" style="padding:12px"><h4>Add User</h4>' +
        (function(){
          const currentRole = (localStorage.getItem('adminRole') || 'superadmin');
          let roleOptions = '<option value="student">Student</option>';
          if (currentRole === 'superadmin' || currentRole === 'admin') roleOptions += '<option value="instructor">Instructor</option>';
          if (currentRole === 'superadmin') roleOptions += '<option value="admin">Admin</option>';
          return '<form id="add-user-form" style="display:flex;flex-direction:column;gap:8px">' +
            '<input id="new-name" placeholder="Name" />' +
            '<input id="new-email" placeholder="Email" />' +
            '<input id="new-password" placeholder="Password" />' +
            '<select id="new-role">' + roleOptions + '</select>' +
            '<div id="new-role-fields"></div>' +
            '<button class="btn-primary" type="submit">Create User</button>' +
            '</form>';
        })();

      const listEl = document.getElementById('users-list');
      async function render(users) {
        listEl.innerHTML = '';
        if (!users || users.length === 0) { listEl.innerHTML = '<div style="color:var(--text-muted)">No users found.</div>'; return; }
        // fetch status map
        let statuses = {};
        try {
          const token = localStorage.getItem('adminToken') || '';
          const sres = await fetch('/api/admin/users/status', { headers: { 'Authorization': 'Bearer ' + token } });
          if (sres.ok) statuses = await sres.json();
        } catch (e) { console.warn('Could not load user statuses', e); }
        users.forEach(u => {
          const row = document.createElement('div');
          row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center'; row.style.padding = '8px 0'; row.style.borderBottom = '1px solid #eef6fb';
          const roleLabel = escapeHtml((u.role || 'student'));
          row.innerHTML = `<div><strong>${escapeHtml(u.name||u.email)}</strong><div style="font-size:12px;color:var(--text-muted)">${escapeHtml(u.email)}</div><span class="role-tag role-${roleLabel}" style="margin-top:4px;display:inline-block">${roleLabel}</span></div>`;
          const indicator = document.createElement('span');
          indicator.style.display = 'inline-block';
          indicator.style.width = '10px';
          indicator.style.height = '10px';
          indicator.style.borderRadius = '50%';
          indicator.style.marginRight = '8px';
          const active = !!statuses[u.email];
          indicator.style.background = active ? '#28a745' : '#cbd5e1';
          const leftDiv = row.querySelector('div');
          if (leftDiv) leftDiv.prepend(indicator);
            const actionsWrap = document.createElement('div'); actionsWrap.style.display='flex';
            const del = document.createElement('button'); del.className = 'btn'; del.textContent = 'Delete'; del.addEventListener('click', async () => {
              const confirmed = await showConfirm('Delete User', 'Delete user '+u.email+'? This action cannot be undone.', 'error');
              if (!confirmed) return;
              const token = localStorage.getItem('adminToken') || '';
              await fetch('/api/admin/users/' + encodeURIComponent(u.email), { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
              loadUsersUI();
            });
            const flog = document.createElement('button'); flog.className = 'btn'; flog.style.marginLeft='8px'; flog.textContent = 'Force logout'; flog.addEventListener('click', async () => {
              const confirmed = await showConfirm('Force Logout', 'Are you sure you want to force logout for '+u.email+'?');
              if (!confirmed) return;
              const token = localStorage.getItem('adminToken') || '';
              const res = await fetch('/api/admin/users/' + encodeURIComponent(u.email) + '/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
              if (res.ok) await showAlert('Logout Successful', 'User has been logged out.', 'success'); else await showAlert('Logout Failed', 'Could not logout user.', 'error');
            });
            actionsWrap.appendChild(flog); actionsWrap.appendChild(del);
            row.appendChild(actionsWrap);
          listEl.appendChild(row);
        });
      }

      // Show/hide role-specific fields when role selector changes
      const newRoleSelect = document.getElementById('new-role');
      function renderNewRoleFields() {
        const rv = newRoleSelect.value;
        const f = document.getElementById('new-role-fields');
        if (!f) return;
        if (rv === 'admin') {
          f.innerHTML = '<input id="new-secret" placeholder="Secret Key" minlength="8" />';
        } else {
          f.innerHTML = '';
        }
      }
      if (newRoleSelect) { newRoleSelect.addEventListener('change', renderNewRoleFields); renderNewRoleFields(); }

      document.getElementById('add-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('new-name').value.trim();
        const email = document.getElementById('new-email').value.trim();
        const password = document.getElementById('new-password').value.trim();
        const role = document.getElementById('new-role').value;
        
        const secret = (document.getElementById('new-secret') ? document.getElementById('new-secret').value.trim() : '');
        if (role === 'admin' && (!secret || secret.length < 8)) { showAlert('Error', 'Secret must be at least 8 characters', 'error'); return; }
        try {
          const token = localStorage.getItem('adminToken') || '';
          const res = await fetch('/api/admin/users', { 
            method: 'POST', 
            headers: {'Content-Type':'application/json', 'Authorization': 'Bearer ' + token}, 
            body: JSON.stringify({ name, email, password, role, secret }) 
          });
          
          const result = await res.json();
          
          if (res.ok && result.success) {
            showAlert('Success', `User ${email} created successfully`, 'success');
            document.getElementById('add-user-form').reset();
            loadUsersUI();
          } else {
            showAlert('Error', result.error || 'Failed to create user', 'error');
          }
        } catch (err) {
          console.error('Error creating user:', err);
          showAlert('Error', 'Failed to create user: ' + err.message, 'error');
        }
      });

      try {
        const token = localStorage.getItem('adminToken') || '';
        const loggedInRole = localStorage.getItem('adminRole') || 'superadmin';
        const loggedInEmail = localStorage.getItem('adminEmail') || '';
        const res = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
        const users = await res.json();
        
        // Filter users based on logged-in admin's role
        let filteredUsers = users || [];
        
        // Remove self from list
        filteredUsers = filteredUsers.filter(u => u.email !== loggedInEmail);
        
        // Filter by role visibility
        if (loggedInRole === 'admin') {
          // Admin can see instructors and students
          filteredUsers = filteredUsers.filter(u => u.role === 'instructor' || u.role === 'student');
        } else if (loggedInRole === 'instructor') {
          // Instructor can only see and manage students
          filteredUsers = filteredUsers.filter(u => u.role === 'student');
        }
        // superadmin sees all remaining users (already filtered for self)
        
        render(filteredUsers);
      } catch (err) { listEl.innerHTML = '<div style="color:var(--text-muted)">Unable to load users.</div>'; console.error(err); }
    }

    // Home dashboard loader
    function loadHomeUI() {
      const container = document.getElementById('home-panel');
      if (!container) return;
      // populate quick stats (attempt to fetch real data, fall back to placeholders)
      let body = container.querySelector('.tab-body');
      if (!body) { body = document.createElement('div'); body.className = 'tab-body'; container.appendChild(body); }
      body.innerHTML = '<div style="padding:12px"><h4>Overview</h4><div class="overview-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:8px"><div class="card stat-card"><div class="stat-number">--</div><div class="stat-label">Total Users</div></div><div class="card stat-card"><div class="stat-number">--</div><div class="stat-label">Active Courses</div></div><div class="card stat-card"><div class="stat-number">--</div><div class="stat-label">Completion Rate</div></div><div class="card stat-card"><div class="stat-number">--</div><div class="stat-label">Active Sessions</div></div></div><div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap"><div class="card" style="flex:1;min-width:260px"><h4>Recent Activity</h4><div id="home-recent" style="max-height:220px;overflow:auto;color:var(--text-muted)">Loading...</div></div><div class="card" style="flex:0 0 220px"><h4>Quick Actions</h4><div style="display:flex;flex-direction:column;gap:8px"><button class="btn" onclick="loadTabContent(\'users\');loadUsersUI();">Manage Users</button><button class="btn" onclick="loadTabContent(\'courses\');loadCoursesUI();">Manage Courses</button><button class="btn" onclick="loadTabContent(\'content\');loadContentManagementUI();">Manage Content</button></div></div></div></div>';
      // try to fetch simple stats
      (async ()=>{
        try {
          const usersRes = await fetch('/api/admin/users');
          if (usersRes.ok) {
            const users = await usersRes.json();
            const total = (users && users.length) || 0;
            container.querySelectorAll('.stat-number')[0].textContent = total;
          }
        } catch(e){}
        try {
          const coursesRes = await fetch('/api/admin/courses');
          if (coursesRes.ok) {
            const courses = await coursesRes.json();
            container.querySelectorAll('.stat-number')[1].textContent = (courses && courses.length) || '--';
          }
        } catch(e){}
        // recent activity placeholder
        const recent = container.querySelector('#home-recent');
        if (recent) recent.textContent = 'No recent activity available.';
      })();
    }

    async function loadCoursesUI() {
      const container = document.getElementById('courses-panel');
      if (!container) return;
      let body = container.querySelector('.tab-body');
      if (!body) { body = document.createElement('div'); body.className = 'tab-body'; container.appendChild(body); }
      body.innerHTML = '' +
        '<div style="display:flex;gap:16px;flex-wrap:wrap">' +
        '<div style="flex:1;min-width:300px;display:flex;flex-direction:column;max-height:70vh"><div id="courses-list" class="card" style="padding:12px;flex:1;overflow-y:auto;overflow-x:hidden"></div><div id="courses-list-actions" style="margin-top:12px;flex-shrink:0"></div></div>' +
        '<div style="flex:1;min-width:320px;overflow-y:auto;max-height:70vh;overflow-y:auto;max-height:70vh">' +
        '<div id="add-course-card" class="card" style="padding:12px;display:block"><h4>Add Course</h4>' +
        '<form id="add-course-form" style="display:flex;flex-direction:column;gap:8px">' +
        '<input id="course-title" placeholder="Title" />' +
        '<input id="course-slug" placeholder="Slug" />' +
        '<input id="course-image" placeholder="Paste course preview image url" />' +
        '<input id="course-category" placeholder="Category (optional)" />' +
        '<textarea id="course-desc" placeholder="Description"></textarea>' +
        '<select id="course-access-type" style="padding:8px;border-radius:6px;border:1px solid #ccc"><option value="auto">Auto-detect (by modules)</option><option value="free">Free</option><option value="premium">Premium</option><option value="mixed">Free | Premium</option></select>' +
        '<button class="btn-primary" type="submit">Create Course</button>' +
        '</form></div>' +
        '<div id="edit-course-card" class="card" style="padding:12px;display:none"><h4>Edit Course</h4>' +
        '<form id="edit-course-form" style="display:flex;flex-direction:column;gap:8px">' +
        '<input id="edit-course-id" type="hidden" />' +
        '<input id="edit-course-title" placeholder="Title" />' +
        '<input id="edit-course-slug" placeholder="Slug" />' +
        '<input id="edit-course-image" placeholder="Paste course preview image url" />' +
        '<input id="edit-course-category" placeholder="Category (optional)" />' +
        '<textarea id="edit-course-desc" placeholder="Description"></textarea>' +
        '<select id="edit-course-access-type" style="padding:8px;border-radius:6px;border:1px solid #ccc"><option value="auto">Auto-detect (by modules)</option><option value="free">Free</option><option value="premium">Premium</option><option value="mixed">Free | Premium</option></select>' +
        '<div style="display:flex;gap:8px">' +
        '<button class="btn-primary" type="submit">Save Changes</button>' +
        '<button type="button" id="edit-course-cancel" class="btn">Cancel</button>' +
        '</div></form></div>' +
        '</div></div>';

      const listEl = document.getElementById('courses-list');
      const addCourseCard = document.getElementById('add-course-card');
      const editCourseCard = document.getElementById('edit-course-card');
      
      // Helper to get module status for a course
      async function getModuleStatusTag(courseId, courseAccessType) {
        // If accessType is manually set and not 'auto', use that
        if (courseAccessType && courseAccessType !== 'auto') {
          const statusMap = {
            'free': { text: 'Free', class: 'free' },
            'premium': { text: 'Premium', class: 'premium' },
            'mixed': { text: 'Free | Premium', class: 'mixed' }
          };
          if (statusMap[courseAccessType]) return statusMap[courseAccessType];
        }
        
        // Otherwise auto-detect from modules
        try {
          const res = await fetch(`/api/modules/${encodeURIComponent(courseId)}`);
          if (res.ok) {
            const modules = await res.json();
            if (modules && modules.length > 0) {
              const hasFree = modules.some(m => !m.isPremium);
              const hasPremium = modules.some(m => m.isPremium);
              
              if (hasFree && hasPremium) return { text: 'Free | Premium', class: 'mixed' };
              if (hasFree) return { text: 'Free', class: 'free' };
              if (hasPremium) return { text: 'Premium', class: 'premium' };
            }
          }
        } catch (err) {
          console.warn('Could not determine module status:', err);
        }
        
        // If accessType is set to auto but we couldn't determine, show that
        if (courseAccessType === 'auto') return { text: 'Auto (checking...)', class: 'neutral' };
        
        // Default fallback
        return { text: 'Not Set', class: 'neutral' };
      }
      
      let draggedIndex = null;
      let hasOrderChanged = false;
      let currentCourses = [];  // Track current courses for saving

      function showSaveOrderButton() {
        let saveBtn = document.getElementById('save-course-order-btn');
        if (!saveBtn) {
          saveBtn = document.createElement('button');
          saveBtn.id = 'save-course-order-btn';
          saveBtn.className = 'btn btn-primary';
          saveBtn.textContent = 'Save Course Order';
          saveBtn.style.width = '100%';
          saveBtn.style.marginTop = '0';
          saveBtn.addEventListener('click', async () => {
            try {
              saveBtn.disabled = true;
              saveBtn.textContent = 'Saving...';
              // Validate and clean courses before sending
              const validCourses = currentCourses.filter(c => c.id && c.title && c.slug).map(c => ({
                id: c.id,
                title: c.title,
                slug: c.slug,
                image: c.image || '',
                category: c.category || '',
                description: c.description || '',
                accessType: c.accessType || 'auto'
              }));
              
              if (validCourses.length === 0) {
                throw new Error('No valid courses to save');
              }
              
              const response = await fetch('/api/admin/courses/reorder', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({ courses: validCourses }) 
              });
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save course order');
              }
              hasOrderChanged = false;
              const actionsContainer = document.getElementById('courses-list-actions');
              if (actionsContainer) actionsContainer.innerHTML = '';
              else saveBtn.remove();
              await showAlert('Success', 'Course order has been saved and will be applied on the live site.', 'success');
            } catch (e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Save Course Order';
              console.error('Save error:', e);
              await showAlert('Error', e.message || 'Failed to save course order.', 'error');
            }
          });
          const actionsContainer = document.getElementById('courses-list-actions');
          if (actionsContainer) {
            actionsContainer.innerHTML = '';
            actionsContainer.appendChild(saveBtn);
          } else {
            listEl.parentNode.insertBefore(saveBtn, listEl.nextSibling);
          }
        }
      }

      async function render(items) {
        currentCourses = [...items];  // Keep a copy for saving
        listEl.innerHTML = '';
        if (!items || items.length === 0) { listEl.innerHTML = '<div style="color:var(--text-muted)">No courses found.</div>'; return; }
        
        for (let idx = 0; idx < items.length; idx++) {
          const c = items[idx];
          const row = document.createElement('div');
          row.draggable = true;
          row.dataset.courseIndex = idx;
          row.style.display = 'flex'; 
          row.style.justifyContent = 'space-between'; 
          row.style.alignItems = 'center'; 
          row.style.padding = '8px 0'; 
          row.style.borderBottom = '1px solid #eef6fb'; 
          row.style.gap = '8px';
          row.style.cursor = 'grab';
          row.style.transition = 'all 0.2s';
          
          // Drag event listeners
          row.addEventListener('dragstart', (e) => {
            draggedIndex = idx;
            row.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
          });

          row.addEventListener('dragend', () => {
            row.style.opacity = '1';
            document.querySelectorAll('#courses-list > div').forEach(el => {
              el.style.borderTop = '';
              el.style.backgroundColor = '';
            });
          });

          row.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (draggedIndex !== null && draggedIndex !== idx) {
              row.style.backgroundColor = 'rgba(0, 179, 138, 0.1)';
              row.style.borderTop = '2px solid var(--accent)';
            }
          });

          row.addEventListener('dragleave', () => {
            row.style.borderTop = '';
            row.style.backgroundColor = '';
          });

          row.addEventListener('drop', async (e) => {
            e.preventDefault();
            if (draggedIndex !== null && draggedIndex !== idx) {
              // Reorder array
              const draggedItem = items[draggedIndex];
              items.splice(draggedIndex, 1);
              items.splice(idx, 0, draggedItem);
              currentCourses = [...items];  // Update tracked courses
              draggedIndex = null;
              hasOrderChanged = true;
              await render(items);
              showSaveOrderButton();
            }
          });
          
          // Get module status for tag
          const tagInfo = await getModuleStatusTag(c.id, c.accessType);
          const tagEl = document.createElement('span');
          tagEl.style.display = 'inline-block';
          tagEl.style.padding = '2px 6px';
          tagEl.style.borderRadius = '4px';
          tagEl.style.fontSize = '11px';
          tagEl.style.fontWeight = '600';
          tagEl.style.color = 'white';
          
          if (tagInfo.class === 'free') tagEl.style.background = '#4caf50';
          else if (tagInfo.class === 'premium') tagEl.style.background = 'var(--accent)';
          else if (tagInfo.class === 'mixed') tagEl.style.background = 'linear-gradient(135deg, #4caf50 50%, var(--accent) 50%)';
          else tagEl.style.background = '#999';
          
          tagEl.textContent = tagInfo.text;

          // Add drag handle icon
          const dragHandle = document.createElement('span');
          dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
          dragHandle.style.color = 'var(--text-muted)';
          dragHandle.style.marginRight = '8px';
          dragHandle.style.cursor = 'grab';
          dragHandle.title = 'Drag to reorder courses';
          
          const titleDiv = document.createElement('div');
          titleDiv.style.flex = '1';
          titleDiv.style.textAlign = 'left';
          titleDiv.innerHTML = `<strong>${escapeHtml(c.title)}</strong><div style="font-size:12px;color:var(--text-muted)">${escapeHtml(c.slug)}</div>`;
          titleDiv.appendChild(tagEl);
          
          row.appendChild(dragHandle);
          row.appendChild(titleDiv);
          
          const actionsDiv = document.createElement('div');
          actionsDiv.style.display = 'flex';
          actionsDiv.style.gap = '6px';
          actionsDiv.style.alignItems = 'center';
          
          const editBtn = document.createElement('button');
          editBtn.className = 'btn';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => {
            addCourseCard.style.display = 'none';
            editCourseCard.style.display = 'block';
            document.getElementById('edit-course-id').value = c.id;
            document.getElementById('edit-course-title').value = c.title || '';
            document.getElementById('edit-course-slug').value = c.slug || '';
            document.getElementById('edit-course-image').value = c.image || '';
            document.getElementById('edit-course-category').value = c.category || '';
            document.getElementById('edit-course-desc').value = c.description || '';
            document.getElementById('edit-course-access-type').value = c.accessType || 'auto';
            window.scrollTo(0, 0);
          });
          
          const del = document.createElement('button');
          del.className = 'btn';
          del.textContent = 'Delete';
          del.addEventListener('click', async () => {
            const confirmed = await showConfirm('Delete Course', 'Delete course '+c.title+'? This action cannot be undone.', 'error');
            if (!confirmed) return;
            await fetch('/api/admin/courses/' + encodeURIComponent(c.id), { method: 'DELETE' });
            loadCoursesUI();
          });
          
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(del);
          row.appendChild(actionsDiv);
          listEl.appendChild(row);
        }
      }

      document.getElementById('add-course-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        let title = document.getElementById('course-title').value.trim();
        let slug = document.getElementById('course-slug').value.trim();
        const image = document.getElementById('course-image').value.trim();
        const category = document.getElementById('course-category').value.trim();
        const description = document.getElementById('course-desc').value.trim();
        const accessType = document.getElementById('course-access-type').value;
        if (!title) { await showAlert('Validation', 'Please enter a course title.', 'warning'); return; }
        // Auto-generate slug from title if empty
        if (!slug) {
          slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');
        }
        const courseId = (typeof crypto !== 'undefined' && crypto.getRandomValues) ? crypto.getRandomValues(new Uint8Array(6)).reduce((s,c)=>s+c.toString(16).padStart(2,'0'),'') : Math.random().toString(36).slice(2,10);
        const res = await fetch('/api/pending-courses', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, slug, description, image, category, courseId, isNew: true, accessType }) });
        if (!res.ok) {
          let msg = 'Failed to save pending course.';
          try { const j = await res.json(); if (j && j.error) msg = j.error; } catch(e){}
          await showAlert('Error', msg, 'error');
          return;
        }
        document.getElementById('course-title').value = '';
        document.getElementById('course-slug').value = '';
        document.getElementById('course-image').value = '';
        document.getElementById('course-category').value = '';
        document.getElementById('course-desc').value = '';
        document.getElementById('course-access-type').value = 'auto';
        // Sync to localStorage immediately
        (async () => { 
          try { 
            const courses = await (await fetch('/api/admin/courses')).json(); 
            await StorageSync.saveCourses(courses); 
          } catch(e) {} 
        })();
        await showAlert('Success', 'Course saved to Pending Deploy. Go to Documents tab to deploy.', 'success');
        loadCoursesUI();
        loadDocumentsUI();
      });
      
      document.getElementById('edit-course-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-course-id').value;
        const title = document.getElementById('edit-course-title').value.trim();
        let slug = document.getElementById('edit-course-slug').value.trim();
        const image = document.getElementById('edit-course-image').value.trim();
        const category = document.getElementById('edit-course-category').value.trim();
        const description = document.getElementById('edit-course-desc').value.trim();
        const accessType = document.getElementById('edit-course-access-type').value;
        if (!title) { await showAlert('Validation', 'Please enter a course title.', 'warning'); return; }
        if (!slug) { slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-'); }
        const res = await fetch('/api/pending-courses', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ courseId: id, title, slug, description, image, category, isNew: false, accessType }) });
        if (res.ok) {
          addCourseCard.style.display = 'block';
          editCourseCard.style.display = 'none';
          // Sync to localStorage immediately
          (async () => { 
            try { 
              const courses = await (await fetch('/api/admin/courses')).json(); 
              await StorageSync.saveCourses(courses); 
            } catch(e) {} 
          })();
          await showAlert('Success', 'Course changes saved to Pending Deploy. Go to Documents tab to deploy.', 'success');
          loadCoursesUI();
          loadDocumentsUI();
        } else {
          let msg = 'Failed to update course';
          try { const j = await res.json(); if (j && j.error) msg = j.error; } catch(e){}
          await showAlert('Error', msg, 'error');
        }
      });
      
      document.getElementById('edit-course-cancel').addEventListener('click', () => {
        addCourseCard.style.display = 'block';
        editCourseCard.style.display = 'none';
      });

      try {
        const res = await fetch('/api/admin/courses');
        const courses = await res.json();
        // Sync courses to localStorage
        localStorage.setItem('courses_cache', JSON.stringify(courses));
        localStorage.setItem('courses_cache_timestamp', new Date().toISOString());
        render(courses);
      } catch (err) { listEl.innerHTML = '<div style="color:var(--text-muted)">Unable to load courses.</div>'; console.error(err); }
    }

    // ============================================================
    // DISCUSSIONS MANAGEMENT
    // ============================================================

    async function loadDiscussionsUI() {
      const courseSelect = document.getElementById('disc-course-select');
      const sessionsList = document.getElementById('disc-sessions-list');

      // Load courses for the dropdown
      try {
        const coursesResp = await fetch('/api/courses', { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('appToken') || localStorage.getItem('token') || '') } });
        if (coursesResp.ok) {
          const courses = await coursesResp.json();
          courseSelect.innerHTML = '<option value="">-- Select a course --</option>';
          courses.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            courseSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error('Failed to load courses for discussions:', err);
      }

      // Load active and upcoming sessions
      await refreshDiscussionSessions(sessionsList);

      // Form submission
      const form = document.getElementById('create-discussion-form');
      if (form) {
        form.onsubmit = async (e) => {
          e.preventDefault();
          const notice = document.getElementById('disc-form-notice');
          try {
            const courseId = document.getElementById('disc-course-select').value;
            const subject = document.getElementById('disc-subject').value.trim();
            const description = document.getElementById('disc-description').value.trim();
            const sessionType = document.getElementById('disc-type').value;
            const startTime = document.getElementById('disc-start-time').value;
            const endTime = document.getElementById('disc-end-time').value;

            if (!courseId || !subject || !startTime || !endTime) {
              notice.textContent = 'Please fill in all required fields';
              notice.style.background = '#f8d7da';
              notice.style.color = '#721c24';
              notice.style.display = 'block';
              return;
            }

            const response = await fetch('/api/discussions/sessions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (localStorage.getItem('appToken') || localStorage.getItem('token') || '') },
              body: JSON.stringify({
                courseId,
                subject,
                description,
                sessionType,
                startTime: new Date(startTime).toISOString(),
                endTime: new Date(endTime).toISOString()
              })
            });

            if (!response.ok) {
              throw new Error('Failed to create discussion session');
            }

            notice.textContent = 'Discussion session created successfully!';
            notice.style.background = '#d4edda';
            notice.style.color = '#155724';
            notice.style.display = 'block';
            form.reset();

            await refreshDiscussionSessions(sessionsList);
          } catch (error) {
            notice.textContent = 'Error: ' + error.message;
            notice.style.background = '#f8d7da';
            notice.style.color = '#721c24';
            notice.style.display = 'block';
          }
        };
      }
    }

    async function refreshDiscussionSessions(container) {
      try {
        const response = await fetch('/api/discussions/sessions', {
          headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('appToken') || localStorage.getItem('token') || '') }
        });
        if (!response.ok) throw new Error('Failed to load sessions');
        const sessions = await response.json();

        container.innerHTML = '';
        
        if (!sessions || sessions.length === 0) {
          container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);"><i class="fas fa-inbox" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 8px;"></i><p style="margin: 0;">No sessions yet</p></div>';
          return;
        }

        sessions.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

        sessions.forEach(session => {
          const sessionCard = document.createElement('div');
          sessionCard.style.cssText = 'border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; background: var(--bg-secondary);';
          
          const startDate = new Date(session.startTime).toLocaleString();
          const endDate = new Date(session.endTime).toLocaleString();
          const actualStatus = getActualSessionStatus(session);
          const statusBadge = actualStatus === 'closed' ? '<span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">Closed</span>' : actualStatus === 'active' ? '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">Active</span>' : '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">Upcoming</span>';
          
          sessionCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; color: var(--text-main); margin-bottom: 2px;">${escapeHtml(session.subject)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${startDate} to ${endDate}</div>
                ${session.description ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(session.description)}</div>` : ''}
              </div>
              ${statusBadge}
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-end;">
              ${actualStatus !== 'closed' ? `
                <button style="padding: 6px 12px; background: var(--green-main); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.3s ease;" onclick="joinDiscussionSession('${session.sessionId}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                  <i class="fas fa-sign-in-alt" style="margin-right: 4px;"></i>Join Session
                </button>
              ` : ''}
              ${actualStatus !== 'closed' ? `
                <button style="padding: 6px 12px; background: #f97316; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.3s ease;" onclick="endDiscussionSession('${session.sessionId}', '${escapeHtml(session.subject)}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                  <i class="fas fa-stop-circle" style="margin-right: 4px;"></i>End Session
                </button>
              ` : ''}
              <button style="padding: 6px 12px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.3s ease;" onclick="deleteDiscussionSession('${session.sessionId}', '${escapeHtml(session.subject)}')" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                <i class="fas fa-trash" style="margin-right: 4px;"></i>Delete
              </button>
            </div>
          `;
          container.appendChild(sessionCard);
        });
      } catch (error) {
        console.error('refreshDiscussionSessions error:', error);
        container.innerHTML = '<div style="color: var(--text-muted);">Failed to load sessions</div>';
      }
    }

    async function joinDiscussionSession(sessionId) {
      try {
        console.log('[admin-dashboard] joinDiscussionSession called with sessionId:', sessionId);
        
        // Preserve admin authentication for discussion room
        const adminToken = localStorage.getItem('adminToken');
        const adminEmail = localStorage.getItem('adminEmail') || '';
        const adminRole = localStorage.getItem('adminRole') || 'superadmin';
        const adminName = localStorage.getItem('adminName') || 'Admin';
        const adminId = localStorage.getItem('adminId') || adminEmail;

        if (adminToken) {
          // Set standard auth token and currentUser so discussion room recognizes admin
          localStorage.setItem('authToken', adminToken);
          localStorage.setItem('currentUser', JSON.stringify({
            id: adminId,
            _id: adminId,
            email: adminEmail,
            name: adminName,
            fullName: adminName,
            username: adminName,
            role: adminRole
          }));
          localStorage.setItem('isLoggedIn', 'true');
        }

        // Redirect into the discussion room using standard session URL
        const targetUrl = `/discussion-room.html?sessionId=${sessionId}`;
        window.location.href = targetUrl;
      } catch (error) {
        console.error('joinDiscussionSession error:', error);
        alert('Failed to join discussion session');
      }
    }

    async function deleteDiscussionSession(sessionId, subject) {
      const confirmed = await showConfirm('Delete Session', `Are you sure you want to delete the session "${subject}"? This action cannot be undone.`);
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/discussions/sessions/${sessionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('appToken') || localStorage.getItem('token') || '') }
        });
        if (!response.ok) throw new Error('Failed to delete session');
        
        const sessionsList = document.getElementById('disc-sessions-list');
        if (sessionsList) {
          await refreshDiscussionSessions(sessionsList);
        }
        showAlert('Success', `Session "${subject}" has been deleted.`, 'success');
      } catch (error) {
        console.error('deleteDiscussionSession error:', error);
        showAlert('Error', 'Failed to delete session: ' + error.message, 'error');
      }
    }

    async function endDiscussionSession(sessionId, subject) {
      const confirmed = await showConfirm('End Session', `End the session "${subject}"? All participants will be notified and redirected.`);
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/discussions/sessions/${sessionId}/close`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('appToken') || localStorage.getItem('token') || '') }
        });
        if (!response.ok) throw new Error('Failed to end session');
        
        const sessionsList = document.getElementById('disc-sessions-list');
        if (sessionsList) {
          await refreshDiscussionSessions(sessionsList);
        }
        showAlert('Success', `Session "${subject}" has been ended.`, 'success');
      } catch (error) {
        console.error('endDiscussionSession error:', error);
        showAlert('Error', 'Failed to end session: ' + error.message, 'error');
      }
    }

    // ----- News Management UI -----
    let newsManagementInitialized = false;
    async function loadNewsManagementUI() {
      // Prevent duplicate initialization
      if (newsManagementInitialized) {
        renderNews(currentViewingTab);
        return;
      }
      newsManagementInitialized = true;
      
      const newsForm = document.getElementById('news-form');
      const newsList = document.getElementById('news-list');
      const newsFormTitle = document.getElementById('news-form-title');
      const newsFormNotice = document.getElementById('news-form-notice');
      
      let currentEditingId = null;
      let currentViewingTab = 'published';
      
      // Get the proper admin token
      function getAdminToken() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          console.warn('âš ï¸ No admin token found in localStorage');
          showAlert('Authentication Error', 'Your session has expired. Please log in again.', 'error');
          window.location.href = 'admin-login.html';
          return null;
        }
        return token;
      }
      
      // Fetch and render news articles
      async function renderNews(filter = 'published') {
        try {
          const adminToken = getAdminToken();
          if (!adminToken) return;
          
          const response = await fetch('/api/admin/news', {
            headers: { 'Authorization': `Bearer ${adminToken}` }
          });
          
          if (!response.ok) throw new Error('Failed to load news');
          
          const articles = await response.json();
          console.log('ðŸ“° Loaded articles:', { total: articles.length, filter });
          
          // Filter by status
          let filtered = articles || [];
          if (filter === 'published') {
            filtered = filtered.filter(a => a.published);
          } else if (filter === 'drafts') {
            filtered = filtered.filter(a => !a.published);
          }
          
          console.log('ðŸ“° Filtered articles:', { filter, count: filtered.length, articles: filtered.map(a => ({ title: a.title, published: a.published })) });
          
          newsList.innerHTML = '';
          
          if (!filtered || filtered.length === 0) {
            const empty = document.createElement('div');
            empty.style.cssText = 'padding: 40px 24px; text-align: center; color: var(--text-muted);';
            empty.innerHTML = '<i class="fas fa-inbox" style="font-size: 40px; opacity: 0.2; display: block; margin-bottom: 12px;"></i><p style="margin: 0; font-size: 14px;">No ' + filter + ' articles yet</p>';
            newsList.appendChild(empty);
            return;
          }
          
          // Sort by latest first
          filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          
          filtered.forEach(article => {
            const card = document.createElement('div');
            card.className = 'news-card';
            
            const likeCount = article.counts ? article.counts.like : 0;
            const reactionCounts = article.counts ? {
              love: article.counts.love || 0,
              insightful: article.counts.insightful || 0,
              celebrate: article.counts.celebrate || 0
            } : {};
            
            const reactionEmojis = {
              'love': 'â¤ï¸',
              'insightful': 'ðŸ’¡',
              'celebrate': 'ðŸŽ‰'
            };
            
            let reactionSummary = '';
            Object.entries(reactionCounts).slice(0, 3).forEach(([type, count]) => {
              if (count > 0) {
                reactionSummary += reactionEmojis[type] + ` ${count} `;
              }
            });
            
            const publishDate = new Date(article.publishedAt || article.createdAt);
            const formattedDate = publishDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            card.innerHTML = `
              <div class="news-card-header">
                <div>
                  <div class="news-card-title">${escapeHtml(article.title)}</div>
                  <div class="news-card-slug">${escapeHtml(article.slug)}</div>
                </div>
                <span class="news-card-badge ${article.published ? 'published' : 'draft'}">
                  ${article.published ? 'Published' : 'Draft'}
                </span>
              </div>
              
              <div class="news-card-stats">
                <div class="news-card-stat">
                  <i class="fas fa-heart"></i>
                  <span>${likeCount}</span>
                </div>
                <div class="news-card-stat">
                  <i class="fas fa-smile"></i>
                  <span>${Object.values(reactionCounts).reduce((a, b) => a + b, 0)}</span>
                </div>
                <div class="news-card-stat">
                  <i class="fas fa-calendar"></i>
                  <span>${formattedDate}</span>
                </div>
              </div>
              
              <div class="news-card-actions">
                <button class="news-card-btn news-card-btn-secondary" onclick="editNews('${escapeHtml(article._id)}')" title="Edit article">
                  <i class="fas fa-edit"></i> Edit
                </button>
                ${!article.published ? `
                  <button class="news-card-btn news-card-btn-primary" onclick="publishNews('${escapeHtml(article._id)}')" title="Publish article">
                    <i class="fas fa-paper-plane"></i> Publish
                  </button>
                ` : `
                  <button class="news-card-btn news-card-btn-secondary" onclick="unpublishNews('${escapeHtml(article._id)}')" title="Unpublish article">
                    <i class="fas fa-times"></i> Unpublish
                  </button>
                `}
                <button class="news-card-btn news-card-btn-danger" onclick="deleteNews('${escapeHtml(article._id)}')" title="Delete article">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            `;
            
            newsList.appendChild(card);
          });
        } catch (error) {
          console.error('renderNews error:', error);
          newsList.innerHTML = '<div style="color: var(--text-muted); padding: 20px; text-align: center;">Failed to load articles</div>';
        }
      }
      
      // Tab switching
      document.querySelectorAll('.news-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          currentViewingTab = tab;
          
          document.querySelectorAll('.news-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          renderNews(tab);
        });
      });
      
      // Set initial active tab
      document.querySelector('.news-tab-btn[data-tab="published"]').classList.add('active');
      
      // Form submission - add a flag to prevent duplicate submissions
      let isSubmittingNews = false;
      newsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Prevent duplicate submissions
        if (isSubmittingNews) {
          console.warn('âš ï¸ News submission already in progress, ignoring duplicate');
          return;
        }
        
        const title = document.getElementById('news-title').value.trim();
        const slug = document.getElementById('news-slug').value.trim() || 
                     title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        const excerpt = document.getElementById('news-excerpt').value.trim();
        const content = document.getElementById('news-content').value.trim();
        const image = document.getElementById('news-image').value.trim();
        const author = document.getElementById('news-author').value.trim() || (localStorage.getItem('adminName') || 'Admin');
        
        if (!title || !content) {
          showAlert('Validation Error', 'Title and content are required.', 'warning');
          return;
        }
        
        isSubmittingNews = true;
        try {
          const adminToken = getAdminToken();
          if (!adminToken) {
            isSubmittingNews = false;
            return;
          }
          
          const method = currentEditingId ? 'PUT' : 'POST';
          const url = currentEditingId ? 
            `/api/admin/news/${currentEditingId}` : 
            '/api/admin/news';
          
          console.log('ðŸ“ News submission:', { method, url, hasToken: !!adminToken, tokenLength: adminToken.length });
          
          const response = await fetch(url, {
            method,
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title,
              slug,
              excerpt: excerpt || undefined,
              content,
              coverImage: image || undefined,
              author
            })
          });
          
          console.log('Response status:', response.status);
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('API error:', error);
            throw new Error(error.error || `HTTP ${response.status}`);
          }
          
          newsFormNotice.textContent = currentEditingId ? 
            'Article updated successfully!' : 
            'Article created as draft. Publish when ready.';
          newsFormNotice.style.background = '#d4edda';
          newsFormNotice.style.borderLeftColor = '#28a745';
          newsFormNotice.style.color = '#155724';
          newsFormNotice.style.display = 'block';
          
          newsForm.reset();
          currentEditingId = null;
          newsFormTitle.textContent = 'Create News Article';
          document.getElementById('news-cancel').style.display = 'none';
          
          setTimeout(() => {
            newsFormNotice.style.display = 'none';
          }, 4000);
          
          renderNews(currentViewingTab);
          
          // Auto-refresh news list every 5 seconds to show real-time likes/reactions
          if (!window.newsListRefreshInterval) {
            window.newsListRefreshInterval = setInterval(() => {
              if (document.querySelector('[data-section="news"]')?.parentElement?.style.display !== 'none') {
                renderNews(currentViewingTab);
              }
            }, 5000);
          }
        } catch (error) {
          console.error('Form submission error:', error);
          newsFormNotice.textContent = 'Error: ' + error.message;
          newsFormNotice.style.background = '#f8d7da';
          newsFormNotice.style.borderLeftColor = '#dc3545';
          newsFormNotice.style.color = '#721c24';
          newsFormNotice.style.display = 'block';
        } finally {
          isSubmittingNews = false;
        }
      });
      
      // Save draft button
      document.getElementById('news-save-draft').addEventListener('click', async (e) => {
        e.preventDefault();
        newsForm.dispatchEvent(new Event('submit'));
      });
      
      // Publish button
      document.getElementById('news-publish').addEventListener('click', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('news-title').value.trim();
        const content = document.getElementById('news-content').value.trim();
        
        if (!title || !content) {
          showAlert('Validation Error', 'Title and content are required.', 'warning');
          return;
        }
        
        // First save the article
        const slug = document.getElementById('news-slug').value.trim() || 
                     title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        const excerpt = document.getElementById('news-excerpt').value.trim();
        const image = document.getElementById('news-image').value.trim();
        const author = document.getElementById('news-author').value.trim() || (localStorage.getItem('adminName') || 'Admin');
        
        try {
          const adminToken = getAdminToken();
          if (!adminToken) return;
          
          const method = currentEditingId ? 'PUT' : 'POST';
          const url = currentEditingId ? 
            `/api/admin/news/${currentEditingId}` : 
            '/api/admin/news';
          
          console.log('ðŸ“ News publish:', { method, url, hasToken: !!adminToken });
          
          const response = await fetch(url, {
            method,
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title,
              slug,
              excerpt: excerpt || undefined,
              content,
              coverImage: image || undefined,
              author
            })
          });
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('Save error:', error);
            throw new Error(error.error || `HTTP ${response.status}`);
          }
          
          const savedArticle = await response.json();
          console.log('ðŸ’¾ Article saved:', { id: savedArticle._id, title: savedArticle.title });
          
          // Then publish it
          console.log('ðŸ“¤ Attempting to publish article:', { id: savedArticle._id });
          const publishRes = await fetch(`/api/admin/news/${savedArticle._id}/publish`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ published: true })
          });
          
          console.log('ðŸ“¤ Publish response status:', publishRes.status);
          
          if (!publishRes.ok) {
            const pubError = await publishRes.json().catch(() => ({}));
            console.error('âŒ Publish error:', { status: publishRes.status, error: pubError });
            throw new Error('Failed to publish article');
          }
          
          const publishedArticle = await publishRes.json();
          console.log('âœ… Article published:', { id: publishedArticle._id, published: publishedArticle.published });
          
          await showAlert('Success', 'Article published successfully!', 'success');
          
          newsForm.reset();
          currentEditingId = null;
          newsFormTitle.textContent = 'Create News Article';
          document.getElementById('news-cancel').style.display = 'none';
          
          currentViewingTab = 'published';
          document.querySelectorAll('.news-tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelector('.news-tab-btn[data-tab="published"]').classList.add('active');
          
          renderNews('published');
        } catch (error) {
          console.error('âŒ Publish button error:', error);
          await showAlert('Error', error.message, 'error');
        }
      });
      
      // Cancel button
      document.getElementById('news-cancel').addEventListener('click', () => {
        newsForm.reset();
        currentEditingId = null;
        newsFormTitle.textContent = 'Create News Article';
        document.getElementById('news-cancel').style.display = 'none';
      });
      
      // Global functions for inline onclick handlers
      window.editNews = async (id) => {
        try {
          const adminToken = getAdminToken();
          if (!adminToken) return;
          
          console.log('Loading article for edit:', { id, hasToken: !!adminToken });
          
          const response = await fetch(`/api/admin/news`, {
            headers: { 'Authorization': `Bearer ${adminToken}` }
          });
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('Load error:', error);
            throw new Error('Failed to load articles');
          }
          
          const articles = await response.json();
          const article = articles.find(a => a._id === id);
          
          if (!article) throw new Error('Article not found');
          
          currentEditingId = id;
          newsFormTitle.textContent = `Edit: ${article.title}`;
          document.getElementById('news-title').value = article.title;
          document.getElementById('news-slug').value = article.slug;
          document.getElementById('news-excerpt').value = article.excerpt || '';
          document.getElementById('news-content').value = article.content;
          document.getElementById('news-image').value = article.coverImage || '';
          document.getElementById('news-author').value = article.author || '';
          document.getElementById('news-cancel').style.display = 'block';
          
          // Scroll to form
          newsForm.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          console.error('editNews error:', error);
          showAlert('Error', 'Failed to load article for editing', 'error');
        }
      };
      
      window.publishNews = async (id) => {
        const confirmed = await showConfirm('Publish Article', 'Publish this article?', 'success');
        if (!confirmed) return;
        
        try {
          const adminToken = getAdminToken();
          if (!adminToken) return;
          
          console.log('ðŸ“¤ Publishing news:', { id, hasToken: !!adminToken });
          
          const response = await fetch(`/api/admin/news/${id}/publish`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ published: true })
          });
          
          console.log('ðŸ“¤ Publish response status:', response.status);
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('Publish error:', error);
            throw new Error('Failed to publish');
          }
          
          const publishedArticle = await response.json();
          console.log('ðŸ“¤ Article published:', { id, published: publishedArticle.published, publishedAt: publishedArticle.publishedAt });
          
          await showAlert('Success', 'Article published!', 'success');
          
          // Switch to published tab to show the published article
          currentViewingTab = 'published';
          document.querySelectorAll('.news-tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelector('.news-tab-btn[data-tab="published"]').classList.add('active');
          
          renderNews('published');
        } catch (error) {
          console.error('publishNews error:', error);
          showAlert('Error', 'Failed to publish article', 'error');
        }
      };
      
      window.unpublishNews = async (id) => {
        const confirmed = await showConfirm('Unpublish Article', 'Move this article back to drafts?', 'warning');
        if (!confirmed) return;
        
        try {
          const adminToken = getAdminToken();
          if (!adminToken) return;
          
          const response = await fetch(`/api/admin/news/${id}/publish`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ published: false })
          });
          
          if (!response.ok) throw new Error('Failed to unpublish');
          
          await showAlert('Success', 'Article moved to drafts', 'success');
          renderNews(currentViewingTab);
        } catch (error) {
          console.error('unpublishNews error:', error);
          showAlert('Error', 'Failed to unpublish article', 'error');
        }
      };
      
      window.deleteNews = async (id) => {
        const confirmed = await showConfirm('Delete Article', 'Delete this article permanently? This cannot be undone.', 'error');
        if (!confirmed) return;
        
        try {
          const adminToken = getAdminToken();
          if (!adminToken) return;
          
          console.log('Deleting news:', { id, hasToken: !!adminToken });
          
          const response = await fetch(`/api/admin/news/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${adminToken}` }
          });
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            console.error('Delete error:', error);
            throw new Error('Failed to delete');
          }
          await showAlert('Success', 'Article deleted', 'success');
          renderNews(currentViewingTab);
        } catch (error) {
          console.error('deleteNews error:', error);
          showAlert('Error', 'Failed to delete article', 'error');
        }
      };
      
      // Initial load
      renderNews('published');
    }

    // ----- Pending Documents UI (extracted for global access) -----
    async function loadDocumentsUI() {
      const coursesWrap = document.getElementById('pending-courses-list');
      const modulesMetadataWrap = document.getElementById('pending-modules-metadata-list');
      const contentWrap = document.getElementById('pending-content-list');
      if (!coursesWrap || !modulesMetadataWrap || !contentWrap) return;
      
      // Load pending courses with module management
      try {
        coursesWrap.innerHTML = '<div style="color:var(--text-muted)">Loading...</div>';
        const res = await fetch('/api/pending-courses');
        if (!res.ok) throw new Error('Unable to load');
        const courses = await res.json();
        if (!courses || courses.length === 0) { coursesWrap.innerHTML = '<div style="color:var(--text-muted)">No pending courses.</div>'; }
        else {
          coursesWrap.innerHTML = '';
          const adminEmail = localStorage.getItem('adminEmail') || '';
          
          for (const item of courses) {
            // Main course row (collapsible)
            const courseContainer = document.createElement('div');
            courseContainer.style.border = '1px solid #e5e7eb';
            courseContainer.style.borderRadius = '8px';
            courseContainer.style.overflow = 'hidden';
            courseContainer.style.backgroundColor = '#fafbfc';
            
            const courseHeader = document.createElement('div');
            courseHeader.style.display = 'flex';
            courseHeader.style.justifyContent = 'space-between';
            courseHeader.style.alignItems = 'center';
            courseHeader.style.padding = '12px 16px';
            courseHeader.style.cursor = 'pointer';
            courseHeader.style.backgroundColor = '#f3f4f6';
            courseHeader.style.borderBottom = '1px solid #e5e7eb';
            courseHeader.style.userSelect = 'none';
            
            const courseTitle = document.createElement('div');
            courseTitle.style.flex = '1';
            courseTitle.innerHTML = `<div style="font-weight:600;color:#1f2937;display:flex;align-items:center;gap:8px;"><i class="fas fa-book"></i> ${escapeHtml(item.title)}</div><div style="font-size:12px;color:#6b7280;margin-top:4px">${escapeHtml(item.slug)} â€” ${item.isNew ? 'New' : 'Edited'}</div>`;
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn';
            toggleBtn.style.padding = '4px 8px';
            toggleBtn.style.fontSize = '14px';
            toggleBtn.style.backgroundColor = 'transparent';
            toggleBtn.style.border = 'none';
            toggleBtn.style.color = '#6b7280';
            toggleBtn.textContent = 'â–¼';
            
            let isExpanded = false;
            const contentArea = document.createElement('div');
            contentArea.style.display = 'none';
            contentArea.style.padding = '16px';
            contentArea.style.backgroundColor = '#fff';
            
            courseHeader.appendChild(courseTitle);
            courseHeader.appendChild(toggleBtn);
            
            // Toggle expand/collapse
            const toggleExpand = async () => {
              isExpanded = !isExpanded;
              toggleBtn.textContent = isExpanded ? 'â–²' : 'â–¼';
              if (isExpanded && contentArea.innerHTML === '') {
                // Load modules and content for this course
                contentArea.innerHTML = '<div style="color:var(--text-muted);padding:20px;text-align:center;">Loading modules...</div>';
                try {
                  const allModules = await (await fetch(`/api/pending-modules`, { headers: { 'X-Author-Email': adminEmail } })).json().catch(()=>[]);
                  const allContent = await (await fetch(`/api/pending-content`, { headers: { 'X-Author-Email': adminEmail } })).json().catch(()=>[]);
                  const itemIdLower = String(item.id).trim().toLowerCase();
                  const pendingModules = allModules.filter(m => String(m.courseId).trim().toLowerCase() === itemIdLower) || [];
                  const pendingContent = allContent.filter(c => String(c.courseId).trim().toLowerCase() === itemIdLower) || [];
                  
                  contentArea.innerHTML = '';
                  
                  // Pending modules section
                  if (pendingModules && pendingModules.length > 0) {
                    const modulesSection = document.createElement('div');
                    modulesSection.style.marginBottom = '16px';
                    modulesSection.innerHTML = `<h5 style="margin-top:0;margin-bottom:12px;color:#1f2937;font-size:14px;"><i class="fas fa-cube" style="margin-right:8px;color:#8b5cf6;"></i>Pending Modules (${pendingModules.length})</h5>`;
                    
                    const modulesList = document.createElement('div');
                    modulesList.style.display = 'flex';
                    modulesList.style.flexDirection = 'column';
                    modulesList.style.gap = '8px';
                    
                    pendingModules.forEach(mod => {
                      const modRow = document.createElement('div');
                      modRow.style.padding = '12px';
                      modRow.style.backgroundColor = '#f9fafb';
                      modRow.style.border = '1px solid #e5e7eb';
                      modRow.style.borderRadius = '6px';
                      modRow.style.display = 'flex';
                      modRow.style.justifyContent = 'space-between';
                      modRow.style.alignItems = 'center';
                      modRow.style.gap = '8px';
                      modRow.style.flexWrap = 'wrap';
                      
                      const modInfo = document.createElement('div');
                      modInfo.style.flex = '1';
                      modInfo.style.minWidth = '200px';
                      modInfo.innerHTML = `<div style="font-weight:600;color:#1f2937;font-size:14px;">${escapeHtml(mod.title)}</div><div style="font-size:12px;color:#6b7280;margin-top:2px">${escapeHtml(mod.file)}</div>`;
                      
                      const modBtns = document.createElement('div');
                      modBtns.style.display = 'flex';
                      modBtns.style.gap = '6px';
                      modBtns.style.flexWrap = 'wrap';
                      
                      const editBtn = document.createElement('button');
                      editBtn.className = 'btn';
                      editBtn.textContent = 'Edit';
                      editBtn.style.padding = '4px 10px';
                      editBtn.style.fontSize = '11px';
                      editBtn.addEventListener('click', () => {
                        document.querySelector('.sidebar-link[data-tab="modules"]').click();
                        setTimeout(() => {
                          document.getElementById('mm-course-select').value = item.id;
                          document.getElementById('mm-course-select').onchange();
                        }, 200);
                      });
                      
                      const delBtn = document.createElement('button');
                      delBtn.className = 'btn';
                      delBtn.textContent = 'Delete';
                      delBtn.style.padding = '4px 10px';
                      delBtn.style.fontSize = '11px';
                      delBtn.addEventListener('click', async () => {
                        const confirmed = await showConfirm('Delete Module', 'Delete this pending module?', 'warning');
                        if (!confirmed) return;
                        try {
                          const r = await fetch(`/api/pending-modules/${encodeURIComponent(item.id)}/${encodeURIComponent(mod.file)}`, { method: 'DELETE', headers: { 'X-Author-Email': adminEmail } });
                          if (!r.ok) throw new Error('Delete failed');
                          await showAlert('Deleted', 'Pending module deleted.', 'success');
                          loadDocumentsUI();
                        } catch (e) {
                          await showAlert('Error', 'Failed to delete module.', 'error');
                        }
                      });
                      
                      modBtns.appendChild(editBtn);
                      modBtns.appendChild(delBtn);
                      modRow.appendChild(modInfo);
                      modRow.appendChild(modBtns);
                      modulesList.appendChild(modRow);
                    });
                    
                    modulesSection.appendChild(modulesList);
                    contentArea.appendChild(modulesSection);
                  } else {
                    const noModules = document.createElement('p');
                    noModules.style.color = '#9ca3af';
                    noModules.style.fontSize = '13px';
                    noModules.style.margin = '0 0 16px 0';
                    noModules.textContent = 'No pending modules yet. Add modules in the Modules tab.';
                    contentArea.appendChild(noModules);
                  }
                  
                  // Pending content section
                  if (pendingContent && pendingContent.length > 0) {
                    const contentSection = document.createElement('div');
                    contentSection.innerHTML = `<h5 style="margin-top:0;margin-bottom:12px;color:#1f2937;font-size:14px;"><i class="fas fa-file-alt" style="margin-right:8px;color:#ec4899;"></i>Pending Content (${pendingContent.length})</h5>`;
                    
                    const contentList = document.createElement('div');
                    contentList.style.display = 'flex';
                    contentList.style.flexDirection = 'column';
                    contentList.style.gap = '8px';
                    
                    pendingContent.forEach(con => {
                      const conRow = document.createElement('div');
                      conRow.style.padding = '12px';
                      conRow.style.backgroundColor = '#f9fafb';
                      conRow.style.border = '1px solid #e5e7eb';
                      conRow.style.borderRadius = '6px';
                      conRow.style.display = 'flex';
                      conRow.style.justifyContent = 'space-between';
                      conRow.style.alignItems = 'center';
                      conRow.style.gap = '8px';
                      conRow.style.flexWrap = 'wrap';
                      
                      const conInfo = document.createElement('div');
                      conInfo.style.flex = '1';
                      conInfo.style.minWidth = '200px';
                      conInfo.innerHTML = `<div style="font-weight:600;color:#1f2937;font-size:14px;">${escapeHtml(con.title || con.file)}</div><div style="font-size:12px;color:#6b7280;margin-top:2px">${escapeHtml(con.file)}</div>`;
                      
                      const conBtns = document.createElement('div');
                      conBtns.style.display = 'flex';
                      conBtns.style.gap = '6px';
                      conBtns.style.flexWrap = 'wrap';
                      
                      const reviewBtn = document.createElement('button');
                      reviewBtn.className = 'btn';
                      reviewBtn.textContent = 'Review';
                      reviewBtn.style.padding = '4px 10px';
                      reviewBtn.style.fontSize = '11px';
                      reviewBtn.addEventListener('click', async () => {
                        try {
                          const r = await fetch(`/api/pending-module/${encodeURIComponent(item.id)}/${encodeURIComponent(con.file)}`, { headers: { 'X-Author-Email': adminEmail } });
                          if (!r.ok) throw new Error('Load failed');
                          const md = await r.text();
                          const modal = document.createElement('div');
                          modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;overflow-y:auto;';
                          const container = document.createElement('div');
                          container.style.cssText = 'background:#fff;width:95%;max-width:900px;max-height:90vh;border-radius:8px;overflow-y:auto;padding:24px;margin:auto;';
                          const closeBtn = document.createElement('button');
                          closeBtn.textContent = 'âœ• Close';
                          closeBtn.className = 'btn';
                          closeBtn.style.cssText = 'float:right;margin-bottom:16px;';
                          closeBtn.addEventListener('click', () => modal.remove());
                          const contentDiv = document.createElement('div');
                          contentDiv.id = 'pending-content-preview';
                          contentDiv.style.cssText = 'margin-top:16px;clear:both;';
                          contentDiv.className = 'lesson-content markdown';
                          container.appendChild(closeBtn);
                          container.appendChild(contentDiv);
                          modal.appendChild(container);
                          document.body.appendChild(modal);
                          try {
                            const { renderMarkdown } = await import('/js/components/markdownRenderer.js');
                            renderMarkdown(contentDiv, md);
                          } catch (err) {
                            console.error('renderMarkdown import failed', err);
                            contentDiv.innerHTML = '<pre style="white-space:pre-wrap;word-break:break-word;background:#f5f5f5;padding:12px;border-radius:4px;font-size:12px">' + escapeHtml(md) + '</pre>';
                          }
                          modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                        } catch (e) {
                          await showAlert('Error', 'Failed to load content.', 'error');
                        }
                      });
                      
                      const editBtn = document.createElement('button');
                      editBtn.className = 'btn';
                      editBtn.textContent = 'Edit';
                      editBtn.style.padding = '4px 10px';
                      editBtn.style.fontSize = '11px';
                      editBtn.addEventListener('click', () => {
                        document.querySelector('.sidebar-link[data-tab="content"]').click();
                        setTimeout(() => loadContentManagementUI(item.id, con.file, con.title), 200);
                      });
                      
                      const delBtn = document.createElement('button');
                      delBtn.className = 'btn';
                      delBtn.textContent = 'Delete';
                      delBtn.style.padding = '4px 10px';
                      delBtn.style.fontSize = '11px';
                      delBtn.addEventListener('click', async () => {
                        const confirmed = await showConfirm('Delete Content', 'Delete this pending content?', 'warning');
                        if (!confirmed) return;
                        try {
                          const r = await fetch(`/api/pending-module/${encodeURIComponent(item.id)}/${encodeURIComponent(con.file)}`, { method: 'DELETE', headers: { 'X-Author-Email': adminEmail } });
                          if (!r.ok) throw new Error('Delete failed');
                          await showAlert('Deleted', 'Pending content deleted.', 'success');
                          loadDocumentsUI();
                        } catch (e) {
                          await showAlert('Error', 'Failed to delete content.', 'error');
                        }
                      });
                      
                      conBtns.appendChild(reviewBtn);
                      conBtns.appendChild(editBtn);
                      conBtns.appendChild(delBtn);
                      conRow.appendChild(conInfo);
                      conRow.appendChild(conBtns);
                      contentList.appendChild(conRow);
                    });
                    
                    contentSection.appendChild(contentList);
                    contentArea.appendChild(contentSection);
                  }
                  
                  // Action buttons for the course
                  const actionsDiv = document.createElement('div');
                  actionsDiv.style.marginTop = '16px';
                  actionsDiv.style.paddingTop = '12px';
                  actionsDiv.style.borderTop = '1px solid #e5e7eb';
                  actionsDiv.style.display = 'flex';
                  actionsDiv.style.gap = '8px';
                  actionsDiv.style.flexWrap = 'wrap';
                  actionsDiv.style.justifyContent = 'flex-end';
                  
                  const deployBtn = document.createElement('button');
                  deployBtn.className = 'btn-primary';
                  deployBtn.textContent = 'Deploy Course';
                  deployBtn.style.padding = '6px 12px';
                  deployBtn.style.fontSize = '12px';
                  deployBtn.addEventListener('click', async () => {
                    const confirmed = await showConfirm('Deploy Course', 'Deploy this course and all its pending modules/content?', 'warning');
                    if (!confirmed) return;
                    deployBtn.disabled = true;
                    try {
                      const r = await fetch(`/api/pending-courses/${encodeURIComponent(item.id)}/deploy`, { method: 'POST' });
                      if (!r.ok) throw new Error('Deploy failed');
                      await showAlert('Deployed', 'Course deployed successfully!', 'success');
                      loadDocumentsUI();
                    } catch (e) {
                      await showAlert('Error', 'Failed to deploy course.', 'error');
                    } finally {
                      deployBtn.disabled = false;
                    }
                  });
                  
                  const deleteBtn = document.createElement('button');
                  deleteBtn.className = 'btn';
                  deleteBtn.textContent = 'Delete';
                  deleteBtn.style.padding = '6px 12px';
                  deleteBtn.style.fontSize = '12px';
                  deleteBtn.addEventListener('click', async () => {
                    const confirmed = await showConfirm('Delete Course', 'Delete this pending course?', 'warning');
                    if (!confirmed) return;
                    deleteBtn.disabled = true;
                    try {
                      const r = await fetch(`/api/pending-courses/${encodeURIComponent(item.id)}`, { method: 'DELETE' });
                      if (!r.ok) throw new Error('Delete failed');
                      await showAlert('Deleted', 'Course deleted.', 'success');
                      loadDocumentsUI();
                    } catch (e) {
                      await showAlert('Error', 'Failed to delete course.', 'error');
                    } finally {
                      deleteBtn.disabled = false;
                    }
                  });
                  
                  actionsDiv.appendChild(deployBtn);
                  actionsDiv.appendChild(deleteBtn);
                  contentArea.appendChild(actionsDiv);
                } catch (e) {
                  console.error(e);
                  contentArea.innerHTML = '<div style="color:var(--text-error);padding:12px;">Error loading modules and content.</div>';
                }
              }
              contentArea.style.display = isExpanded ? 'block' : 'none';
            };
            
            courseHeader.addEventListener('click', toggleExpand);
            
            courseContainer.appendChild(courseHeader);
            courseContainer.appendChild(contentArea);
            coursesWrap.appendChild(courseContainer);
          }
        }
      } catch (e) { console.error(e); coursesWrap.innerHTML = '<div style="color:var(--text-muted)">Unable to load pending courses.</div>'; }
      
      // Load pending modules metadata (for already-deployed courses)
      try {
        modulesMetadataWrap.innerHTML = '<div style="color:var(--text-muted)">Loading...</div>';
        const adminEmail = localStorage.getItem('adminEmail') || '';
        
        // Get pending courses to filter them out from standalone list
        const pendingCoursesRes = await fetch('/api/pending-courses');
        const pendingCourses = await pendingCoursesRes.json().catch(() => []);
        const pendingCourseIds = pendingCourses && pendingCourses.length > 0 ? pendingCourses.map(c => String(c.id).trim().toLowerCase()) : [];
        
        const res = await fetch('/api/pending-modules', { headers: { 'X-Author-Email': adminEmail } });
        if (!res.ok) throw new Error('Unable to load');
        const allModules = await res.json();
        // Filter out modules that are part of pending courses (already shown above)
        // Use case-insensitive matching
        const standaloneModules = (allModules || []).filter(m => !pendingCourseIds.includes(String(m.courseId).trim().toLowerCase()));
        
        if (!standaloneModules || standaloneModules.length === 0) { 
          modulesMetadataWrap.innerHTML = '<div style="color:var(--text-muted)">No standalone pending modules. Modules for pending courses appear when you expand the course above.</div>'; 
        }
        else {
          modulesMetadataWrap.innerHTML = '';
          standaloneModules.forEach(item => {
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='12px'; row.style.border='1px solid #eef6fb'; row.style.borderRadius='6px'; row.style.gap='12px'; row.style.backgroundColor='#fafbfc';
            const left = document.createElement('div'); left.style.flex = '1'; left.innerHTML = `<div style="font-weight:600;color:#1f2937">${escapeHtml(item.title)}</div><div style="font-size:12px;color:#6b7280;margin-top:4px">${escapeHtml(item.courseId)} / ${escapeHtml(item.file)}</div><div style="font-size:11px;color:#9ca3af;margin-top:2px">${new Date(item.createdAt).toLocaleString()}</div>`;
            const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.flexWrap='wrap'; right.style.justifyContent='flex-end';
            const deployBtn = document.createElement('button'); deployBtn.className='btn-primary'; deployBtn.textContent='Deploy'; deployBtn.style.padding='6px 12px'; deployBtn.style.fontSize='12px'; deployBtn.style.whiteSpace='nowrap';
            deployBtn.addEventListener('click', async ()=>{
              const confirmed = await showConfirm('Deploy Module Metadata', 'Deploy this module metadata change? This will update the module details (id, title, tag, premium status).', 'warning');
              if (!confirmed) return;
              deployBtn.disabled = true;
              try {
                const r = await fetch(`/api/pending-modules/${encodeURIComponent(item.courseId)}/${encodeURIComponent(item.file)}/deploy`, { method: 'POST' });
                if (!r.ok) { const j = await r.json().catch(()=>({})); await showAlert('Deploy Failed', 'Could not deploy: '+(j && j.error? j.error : 'Status '+r.status), 'error'); return; }
                await showAlert('Deployed', 'Module metadata has been deployed.', 'success');
                loadDocumentsUI();
              } catch (e) { console.error(e); await showAlert('Deploy Error', 'Failed to deploy.', 'error'); }
              finally { deployBtn.disabled = false; }
            });
            const deleteBtn = document.createElement('button'); deleteBtn.className='btn'; deleteBtn.textContent='Delete'; deleteBtn.style.padding='6px 12px'; deleteBtn.style.fontSize='12px'; deleteBtn.style.whiteSpace='nowrap';
            deleteBtn.addEventListener('click', async ()=>{
              const confirmed = await showConfirm('Delete Module Metadata', 'Delete this pending module metadata change?', 'warning');
              if (!confirmed) return;
              deleteBtn.disabled = true;
              try {
                const r = await fetch(`/api/pending-modules/${encodeURIComponent(item.courseId)}/${encodeURIComponent(item.file)}`, { method: 'DELETE' });
                if (!r.ok) { const j = await r.json().catch(()=>({})); await showAlert('Delete Failed', 'Could not delete: '+(j && j.error? j.error : 'Status '+r.status), 'error'); return; }
                await showAlert('Deleted', 'Pending module metadata has been deleted.', 'success');
                loadDocumentsUI();
              } catch (e) { console.error(e); await showAlert('Delete Error', 'Failed to delete.', 'error'); }
              finally { deleteBtn.disabled = false; }
            });
            right.appendChild(deployBtn); right.appendChild(deleteBtn);
            row.appendChild(left); row.appendChild(right);
            modulesMetadataWrap.appendChild(row);
          });
        }
      } catch (e) { console.error(e); modulesMetadataWrap.innerHTML = '<div style="color:var(--text-muted)">Unable to load pending module metadata.</div>'; }
      
      // Load pending content (for already-deployed courses)
      try {
        contentWrap.innerHTML = '<div style="color:var(--text-muted)">Loading...</div>';
        const adminEmail = localStorage.getItem('adminEmail') || '';
        
        // Get pending courses to filter them out from standalone list
        const pendingCoursesRes = await fetch('/api/pending-courses');
        const pendingCourses = await pendingCoursesRes.json().catch(() => []);
        const pendingCourseIds = pendingCourses && pendingCourses.length > 0 ? pendingCourses.map(c => c.id) : [];
        
        const res = await fetch('/api/pending-content', { headers: { 'X-Author-Email': adminEmail } });
        if (!res.ok) throw new Error('Unable to load');
        const allContent = await res.json();
        // Filter out content that is part of pending courses (already shown above)
        const standaloneContent = (allContent || []).filter(c => !pendingCourseIds.includes(c.courseId));
        
        if (!standaloneContent || standaloneContent.length === 0) { 
          contentWrap.innerHTML = '<div style="color:var(--text-muted)">No standalone pending content. Content for pending courses appears when you expand the course above.</div>'; 
        }
        else {
          contentWrap.innerHTML = '';
          standaloneContent.forEach(item => {
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='12px'; row.style.border='1px solid #eef6fb'; row.style.borderRadius='6px'; row.style.gap='12px'; row.style.backgroundColor='#fafbfc';
            const left = document.createElement('div'); left.style.flex = '1'; left.innerHTML = `<div style="font-weight:600;color:#1f2937">${escapeHtml(item.title || item.file)}</div><div style="font-size:12px;color:#6b7280;margin-top:4px">${escapeHtml(item.courseId)} / ${escapeHtml(item.file)}</div><div style="font-size:11px;color:#9ca3af;margin-top:2px">${new Date(item.createdAt).toLocaleString()}</div>`;
            const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.flexWrap='wrap'; right.style.justifyContent='flex-end';
            const openBtn = document.createElement('button'); openBtn.className='btn'; openBtn.textContent='Review'; openBtn.style.padding='6px 12px'; openBtn.style.fontSize='12px'; openBtn.style.whiteSpace='nowrap';
            openBtn.addEventListener('click', async ()=>{
              try {
                const adminEmail = localStorage.getItem('adminEmail') || '';
                const r = await fetch(`/api/pending-module/${encodeURIComponent(item.courseId)}/${encodeURIComponent(item.file)}`, { headers: { 'X-Author-Email': adminEmail } });
                if (!r.ok) { await showAlert('Load Failed', 'Unable to load content.', 'error'); return; }
                const md = await r.text();
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;';
                const container = document.createElement('div');
                container.style.cssText = 'background:#fff;width:95%;max-width:900px;max-height:90vh;border-radius:8px;overflow-y:auto;padding:24px;';
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'âœ• Close';
                closeBtn.className = 'btn';
                closeBtn.style.cssText = 'float:right;margin-bottom:16px;';
                closeBtn.addEventListener('click', () => modal.remove());
                const contentDiv = document.createElement('div');
                contentDiv.id = 'pending-content-preview';
                contentDiv.style.cssText = 'margin-top:16px;clear:both;';
                contentDiv.className = 'lesson-content markdown';
                container.appendChild(closeBtn);
                container.appendChild(contentDiv);
                modal.appendChild(container);
                document.body.appendChild(modal);
                try {
                  const { renderMarkdown } = await import('/js/components/markdownRenderer.js');
                  renderMarkdown(contentDiv, md);
                } catch (err) {
                  console.error('renderMarkdown import failed', err);
                  contentDiv.innerHTML = '<pre style="white-space:pre-wrap;word-break:break-word;background:#f5f5f5;padding:12px;border-radius:4px;font-size:12px">' + escapeHtml(md) + '</pre>';
                }
                modal.addEventListener('click', (e) => {
                  if (e.target === modal) modal.remove();
                });
              } catch (e) { console.error(e); await showAlert('Load Error', 'Failed to load content.', 'error'); }
            });
            const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Edit'; editBtn.style.padding='6px 12px'; editBtn.style.fontSize='12px'; editBtn.style.whiteSpace='nowrap';
            editBtn.addEventListener('click', async ()=>{
              document.querySelector('.sidebar-link[data-tab="content"]').click();
              setTimeout(()=> loadContentManagementUI(item.courseId, item.file, item.title), 200);
            });
            const deployBtn = document.createElement('button'); deployBtn.className='btn-primary'; deployBtn.textContent='Deploy'; deployBtn.style.padding='6px 12px'; deployBtn.style.fontSize='12px'; deployBtn.style.whiteSpace='nowrap';
            deployBtn.addEventListener('click', async ()=>{
              const confirmed = await showConfirm('Deploy Content', 'Deploy this content change to the live site?', 'warning');
              if (!confirmed) return;
              deployBtn.disabled = true;
              try {
                const r = await fetch(`/api/pending-module/${encodeURIComponent(item.courseId)}/${encodeURIComponent(item.file)}/deploy`, { method: 'POST' });
                if (!r.ok) { const j = await r.json().catch(()=>({})); await showAlert('Deploy Failed', 'Could not deploy: '+(j && j.error? j.error : 'Status '+r.status), 'error'); return; }
                await showAlert('Deployed', 'Content has been deployed.', 'success');
                loadDocumentsUI();
              } catch (e) { console.error(e); await showAlert('Deploy Error', 'Failed to deploy.', 'error'); }
              finally { deployBtn.disabled = false; }
            });
            const deleteBtn = document.createElement('button'); deleteBtn.className='btn'; deleteBtn.textContent='Delete'; deleteBtn.style.padding='6px 12px'; deleteBtn.style.fontSize='12px'; deleteBtn.style.whiteSpace='nowrap';
            deleteBtn.addEventListener('click', async ()=>{
              const confirmed = await showConfirm('Delete Content', 'Delete this pending content change?', 'warning');
              if (!confirmed) return;
              deleteBtn.disabled = true;
              try {
                const r = await fetch(`/api/pending-module/${encodeURIComponent(item.courseId)}/${encodeURIComponent(item.file)}`, { method: 'DELETE' });
                if (!r.ok) { const j = await r.json().catch(()=>({})); await showAlert('Delete Failed', 'Could not delete: '+(j && j.error? j.error : 'Status '+r.status), 'error'); return; }
                await showAlert('Deleted', 'Pending content has been deleted.', 'success');
                loadDocumentsUI();
              } catch (e) { console.error(e); await showAlert('Delete Error', 'Failed to delete.', 'error'); }
              finally { deleteBtn.disabled = false; }
            });
            right.appendChild(openBtn); right.appendChild(editBtn); right.appendChild(deployBtn); right.appendChild(deleteBtn);
            row.appendChild(left); row.appendChild(right);
            contentWrap.appendChild(row);
          });
        }
      } catch (e) { console.error(e); contentWrap.innerHTML = '<div style="color:var(--text-muted)">Unable to load pending content.</div>'; }
    }
    
    function showReadOnly(content, item) {
      showModal({
        type: 'info',
        title: `Preview: ${item.title || item.file}`,
        message: `<pre style="max-height:400px; overflow-y:auto; background:#f5f5f5; padding:10px; border-radius:4px; font-size:12px; font-family:monospace; white-space:pre-wrap; word-break:break-word;">${escapeHtml(content)}</pre>`,
        onConfirm: () => {}
      });
    }

    // ----- Module Management -----
    async function loadModuleManagementUI() {
      const container = document.getElementById('modules-panel');
      container.querySelector('#mm-modules-list').innerHTML = '<div style="color:var(--text-muted)">Loading...</div>';
      // load courses and pending courses for select
      try {
        const [coursesRes, pendingRes] = await Promise.all([
          fetch('/api/admin/courses'),
          fetch('/api/pending-courses')
        ]);
        const courses = await coursesRes.json();
        const pendingCourses = await pendingRes.json();
        const sel = document.getElementById('mm-course-select');
        sel.innerHTML = '';
        
        // Add deployed courses
        const deployedGroup = document.createElement('optgroup');
        deployedGroup.label = 'Deployed Courses';
        courses.forEach(c => { 
          const opt = document.createElement('option'); 
          opt.value = c.id || c.slug || c.title; 
          opt.textContent = c.title; 
          deployedGroup.appendChild(opt); 
        });
        sel.appendChild(deployedGroup);
        
        // Add pending courses
        if (pendingCourses && pendingCourses.length > 0) {
          const pendingGroup = document.createElement('optgroup');
          pendingGroup.label = 'Pending Courses (Not Yet Deployed)';
          pendingCourses.forEach(c => { 
            const opt = document.createElement('option'); 
            opt.value = c.id; 
            opt.textContent = c.title + ' (Pending)'; 
            pendingGroup.appendChild(opt); 
          });
          sel.appendChild(pendingGroup);
        }

        async function refreshModules() {
          const courseId = sel.value;
          const ms = await import('/js/core/moduleService.js');
          let modules = await ms.getModulesForCourse(courseId);
          
          // Also load pending modules for this course
          const adminEmail = localStorage.getItem('adminEmail') || '';
          const pendingRes = await fetch('/api/pending-modules', { headers: { 'X-Author-Email': adminEmail } }).catch(() => ({ json: async () => [] }));
          const allPending = await pendingRes.json().catch(() => []);
          const pendingModules = allPending.filter(m => m.courseId === courseId) || [];
          
          // Combine deployed and pending modules
          const allModules = [...(modules || []), ...pendingModules];
          
          // normalize module entries: support array of strings or objects
          let normalized = allModules.map(m => {
            if (typeof m === 'string') return { file: m, title: m };
            if (m && typeof m === 'object') {
              const file = m.content || m.file || m.slug || m.name || m.title;
              const title = m.title || m.name || m.content || m.file || m.slug || file;
              return { ...m, file, title };
            }
            return { file: String(m), title: String(m) };
          });
          
          const list = document.getElementById('mm-modules-list');
          list.innerHTML = '';
          if (!normalized || normalized.length === 0) { list.innerHTML = '<div style="color:var(--text-muted)">No modules found.</div>'; return; }
          normalized.forEach(m => {
            const row = document.createElement('div');
            row.style.display='flex'; 
            row.style.justifyContent='space-between'; 
            row.style.alignItems='center'; 
            row.style.padding='12px 12px'; 
            row.style.borderBottom='1px solid #eef6fb'; 
            row.style.gap='12px';
            row.style.flexWrap='wrap';
            
            const infoDiv = document.createElement('div');
            infoDiv.style.flex='1';
            infoDiv.style.minWidth='200px';
            infoDiv.innerHTML = `<div style="font-weight:600;color:#1f2937;margin-bottom:4px;word-break:break-word">${escapeHtml(m.title||m.file||m.name)}</div><div style="font-size:12px;color:#6b7280;word-break:break-word">${escapeHtml(m.file||m.slug||'')}</div>`;
            
            const edit = document.createElement('button'); 
            edit.className='btn'; 
            edit.textContent='Edit Details'; 
            edit.style.whiteSpace='nowrap';
            edit.style.fontSize='12px';
            edit.style.padding='6px 12px';
            edit.addEventListener('click', async ()=>{
              document.getElementById('mm-add-card').style.display = 'none';
              document.getElementById('mm-edit-card').style.display = 'block';
              document.getElementById('mm-edit-courseId').value = courseId;
              document.getElementById('mm-edit-file').value = m.file;
              document.getElementById('mm-edit-title').value = m.title || '';
              document.getElementById('mm-edit-category').value = m.category || '';
              document.getElementById('mm-edit-tag').value = m.tag || '';
              document.getElementById('mm-edit-isPremium').checked = !!m.isPremium;
              document.getElementById('mm-edit-content').value = '';
              document.getElementById('mm-edit-id').value = m.id || '';
              document.getElementById('mm-edit-video').value = m.video || '';
              document.getElementById('mm-edit-video-file').value = '';
            });
            
            const manage = document.createElement('button'); 
            manage.className='btn'; 
            manage.textContent='Manage Content';
            manage.style.whiteSpace='nowrap';
            manage.style.fontSize='12px';
            manage.style.padding='6px 12px';
            manage.addEventListener('click', ()=>{
              // switch to content tab and load editor
              document.querySelector('.sidebar-link[data-tab="content"]').click();
              setTimeout(()=> loadContentManagementUI(courseId, m.file, m.title), 200);
            });
            
            const del = document.createElement('button'); 
            del.className='btn'; 
            del.textContent='Delete';
            del.style.whiteSpace='nowrap';
            del.style.fontSize='12px';
            del.style.padding='6px 12px';
            del.addEventListener('click', async ()=>{
              const confirmed = await showConfirm('Delete Module', 'Delete module '+(m.file||m.title)+'? This action cannot be undone.', 'error');
              if (!confirmed) return;
              await fetch('/api/modules/'+encodeURIComponent(courseId)+'/'+encodeURIComponent(m.file), { method: 'DELETE' });
              refreshModules();
            });
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.display='flex';
            buttonsDiv.style.gap='6px';
            buttonsDiv.style.flexWrap='wrap';
            buttonsDiv.style.justifyContent='flex-end';
            buttonsDiv.style.minWidth='300px';
            buttonsDiv.appendChild(edit);
            buttonsDiv.appendChild(manage);
            buttonsDiv.appendChild(del);
            
            row.appendChild(infoDiv);
            row.appendChild(buttonsDiv);
            list.appendChild(row);
          });
        }

        sel.onchange = refreshModules;
        
        // Add-module inline quiz/projects/objectives removed â€” these controls live only in the Module Editor now
        
        // add form submit (use onsubmit to avoid duplicate handlers)
        const addForm = document.getElementById('mm-add-form');
        const addCard = document.getElementById('mm-add-card');
        const editCard = document.getElementById('mm-edit-card');
        const editForm = document.getElementById('mm-edit-form');
        const editCancel = document.getElementById('mm-edit-cancel');
        
        addForm.onsubmit = async (e)=>{
          e.preventDefault();
          const id = (document.getElementById('mm-id').value || '').trim();
          const title = document.getElementById('mm-title').value.trim();
          const category = (document.getElementById('mm-category').value || '').trim();
          const file = document.getElementById('mm-file').value.trim();
          const tag = (document.getElementById('mm-tag').value || '').trim();
          const isPremium = document.getElementById('mm-isPremium').checked;
          const videoUrl = (document.getElementById('mm-add-video').value || '').trim();
          const content = document.getElementById('mm-content').value || '';
          if (!title || !file) { await showAlert('Missing Information', 'Please provide both a title and file name.', 'warning'); return; }
          const courseId = sel.value;

          const adminEmail = localStorage.getItem('adminEmail') || '';
          
          // First save to pending modules metadata
          const metadataBody = { file, title, category: category || undefined, tag: tag || undefined, isPremium: !!isPremium, id: id || undefined, video: videoUrl || undefined };
          const metaRes = await fetch('/api/pending-modules/'+encodeURIComponent(courseId), { 
            method: 'POST', 
            headers: {'Content-Type':'application/json', 'X-Author-Email': adminEmail}, 
            body: JSON.stringify(metadataBody) 
          });
          if (!metaRes.ok) { await showAlert('Creation Failed', 'Failed to save module metadata.', 'error'); return; }
          
          // Then save content to pending content
          if (content) {
            const contentRes = await fetch('/api/pending-module/'+encodeURIComponent(courseId)+'/'+encodeURIComponent(file), { 
              method: 'POST', 
              headers: {'Content-Type':'text/plain', 'X-Author-Email': adminEmail}, 
              body: content 
            });
            if (!contentRes.ok) { await showAlert('Warning', 'Module metadata saved but content save failed.', 'warning'); }
          }
          
          addForm.reset();
          await showAlert('Success', 'Module created (awaiting deploy).', 'success');
          refreshModules();
        };
        
        // Edit module form
        editForm.onsubmit = async (e)=>{
          e.preventDefault();
          const courseId = document.getElementById('mm-edit-courseId').value;
          const file = document.getElementById('mm-edit-file').value;
          const id = (document.getElementById('mm-edit-id').value || '').trim();
          const title = document.getElementById('mm-edit-title').value.trim();
          const category = (document.getElementById('mm-edit-category').value || '').trim();
          const tag = (document.getElementById('mm-edit-tag').value || '').trim();
          const isPremium = document.getElementById('mm-edit-isPremium').checked;
          const videoUrl = (document.getElementById('mm-edit-video').value || '').trim();
          const content = document.getElementById('mm-edit-content').value || '';
          if (!title) { await showAlert('Missing Information', 'Please provide a title.', 'warning'); return; }
          
          // Save module metadata to pending modules (video URL included)
          const adminEmail = localStorage.getItem('adminEmail') || '';
          const metadataBody = { file, title, category: category || undefined, tag: tag || undefined, isPremium: !!isPremium, id: id || undefined, video: videoUrl || undefined };
          const metaRes = await fetch('/api/pending-modules/'+encodeURIComponent(courseId), { 
            method: 'POST', 
            headers: {'Content-Type':'application/json', 'X-Author-Email': adminEmail}, 
            body: JSON.stringify(metadataBody) 
          });
          if (!metaRes.ok) { await showAlert('Save Failed', 'Failed to save module metadata.', 'error'); return; }
          
          // If content is provided, also save it to pending content
          if (content) {
            const contentRes = await fetch('/api/pending-module/'+encodeURIComponent(courseId)+'/'+encodeURIComponent(file), { 
              method: 'POST', 
              headers: {'Content-Type':'text/plain', 'X-Author-Email': adminEmail}, 
              body: content 
            });
            if (!contentRes.ok) { await showAlert('Warning', 'Module metadata saved but content save failed.', 'warning'); }
          }
          
          addCard.style.display = 'block';
          editCard.style.display = 'none';
          await showAlert('Success', 'Module details saved (awaiting deploy).', 'success');
          refreshModules();
        };
        
        editCancel.onclick = ()=>{
          addCard.style.display = 'block';
          editCard.style.display = 'none';
        };

        // Video Upload Modal Handler
        const videoModal = document.getElementById('video-upload-modal');
        const uploadBtn = document.getElementById('mm-upload-video-btn');
        const addUploadBtn = document.getElementById('mm-add-upload-video-btn');
        const uploadZone = document.getElementById('video-upload-zone');
        const uploadInput = document.getElementById('video-upload-input');
        const cancelBtn = document.getElementById('video-upload-cancel');
        const useBtn = document.getElementById('video-upload-use');
        let currentUploadedVideoUrl = '';
        let currentVideoTargetField = null;

        function openVideoModal(targetFieldId) {
          videoModal.style.display = 'flex';
          currentUploadedVideoUrl = '';
          currentVideoTargetField = targetFieldId;
          document.getElementById('video-upload-progress').style.display = 'none';
          document.getElementById('video-upload-result').style.display = 'none';
          useBtn.style.display = 'none';
        }

        uploadBtn.addEventListener('click', () => openVideoModal('mm-edit-video'));
        addUploadBtn.addEventListener('click', () => openVideoModal('mm-add-video'));

        cancelBtn.addEventListener('click', () => {
          videoModal.style.display = 'none';
        });

        uploadZone.addEventListener('click', () => uploadInput.click());
        uploadZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadZone.style.borderColor = 'var(--green-main)';
          uploadZone.style.background = 'rgba(0,121,107,0.1)';
        });
        uploadZone.addEventListener('dragleave', () => {
          uploadZone.style.borderColor = 'var(--border-color)';
          uploadZone.style.background = 'rgba(0,121,107,0.02)';
        });
        uploadZone.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadZone.style.borderColor = 'var(--border-color)';
          uploadZone.style.background = 'rgba(0,121,107,0.02)';
          if (e.dataTransfer.files.length > 0) {
            uploadInput.files = e.dataTransfer.files;
            handleVideoUpload(e.dataTransfer.files[0]);
          }
        });

        uploadInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleVideoUpload(e.target.files[0]);
          }
        });

        async function handleVideoUpload(file) {
          if (!file.type.startsWith('video/')) {
            alert('Please select a video file');
            return;
          }

          const maxSize = 500 * 1024 * 1024;
          if (file.size > maxSize) {
            alert('File too large. Max 500MB.');
            return;
          }

          const progressDiv = document.getElementById('video-upload-progress');
          progressDiv.style.display = 'block';

          const formData = new FormData();
          formData.append('video', file);

          const xhr = new XMLHttpRequest();
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              document.getElementById('video-progress-bar').style.width = percent + '%';
              document.getElementById('video-percent').textContent = Math.round(percent) + '%';
            }
          });

          xhr.addEventListener('load', () => {
            progressDiv.style.display = 'none';
            if (xhr.status === 200) {
              try {
                const response = JSON.parse(xhr.responseText);
                currentUploadedVideoUrl = response.videoUrl;
                const resultDiv = document.getElementById('video-upload-result');
                document.getElementById('video-url-display').textContent = response.videoUrl;
                resultDiv.style.display = 'block';
                useBtn.style.display = 'block';
              } catch (e) {
                console.error('Error parsing upload response:', e, xhr.responseText);
                alert('Upload succeeded but failed to parse response');
              }
            } else {
              try {
                const errorData = JSON.parse(xhr.responseText);
                alert('Upload failed: ' + (errorData.error || xhr.statusText));
              } catch (e) {
                alert('Upload failed: ' + xhr.status + ' ' + xhr.statusText);
              }
            }
          });

          xhr.addEventListener('error', () => {
            progressDiv.style.display = 'none';
            alert('Upload error');
          });

          xhr.open('POST', '/api/upload-local-video');
          xhr.send(formData);
        }

        useBtn.addEventListener('click', () => {
          if (currentVideoTargetField) {
            document.getElementById(currentVideoTargetField).value = currentUploadedVideoUrl;
          }
          videoModal.style.display = 'none';
        });

        // Delete video button handlers
        const addDeleteBtn = document.getElementById('mm-add-delete-video-btn');
        const editDeleteBtn = document.getElementById('mm-edit-delete-video-btn');
        
        addDeleteBtn.addEventListener('click', async () => {
          const videoField = document.getElementById('mm-add-video');
          if (!videoField.value.trim()) {
            alert('No video to delete');
            return;
          }
          const confirmed = await showConfirm('Delete Video', 'Remove this video from the module? This action cannot be undone.', 'warning');
          if (!confirmed) return;
          videoField.value = '';
          showAlert('Success', 'Video removed from module', 'success');
        });
        
        editDeleteBtn.addEventListener('click', async () => {
          const videoField = document.getElementById('mm-edit-video');
          if (!videoField.value.trim()) {
            alert('No video to delete');
            return;
          }
          const confirmed = await showConfirm('Delete Video', 'Remove this video from the module? This action cannot be undone.', 'warning');
          if (!confirmed) return;
          
          // Clear the video field
          videoField.value = '';
          
          // Immediately save the module with empty video
          const courseId = document.getElementById('mm-edit-courseId').value;
          const file = document.getElementById('mm-edit-file').value;
          const id = (document.getElementById('mm-edit-id').value || '').trim();
          const title = document.getElementById('mm-edit-title').value.trim();
          const tag = (document.getElementById('mm-edit-tag').value || '').trim();
          const isPremium = document.getElementById('mm-edit-isPremium').checked;
          const content = document.getElementById('mm-edit-content').value || '';
          
          const adminEmail = localStorage.getItem('adminEmail') || '';
          const metadataBody = { file, title, tag: tag || undefined, isPremium: !!isPremium, id: id || undefined, video: '' };
          const metaRes = await fetch('/api/pending-modules/'+encodeURIComponent(courseId), { 
            method: 'POST', 
            headers: {'Content-Type':'application/json', 'X-Author-Email': adminEmail}, 
            body: JSON.stringify(metadataBody) 
          });
          
          if (metaRes.ok) {
            showAlert('Success', 'Video removed and module updated', 'success');
            refreshModules();
          } else {
            showAlert('Error', 'Failed to delete video from module', 'error');
          }
        });

        // trigger initial
        if (sel.options.length>0) { sel.selectedIndex = 0; await refreshModules(); }
      } catch (err) { console.error('loadModuleManagementUI error', err); const list = document.getElementById('mm-modules-list'); if (list) list.innerHTML = '<div style="color:var(--text-muted)">Unable to load modules.</div>'; }
    }
    async function loadContentManagementUI(prefCourse, prefFile, prefTitle) {
      const container = document.getElementById('content-panel');
      const courseSel = document.getElementById('cm-course-select');
      const modulesList = document.getElementById('cm-modules-list');
      const editorTitle = document.getElementById('cm-editor-title');
      const editor = document.getElementById('cm-content-editor');
      const saveBtn = document.getElementById('cm-save-btn');

      try {
        // Load both deployed and pending courses
        const [coursesRes, pendingRes] = await Promise.all([
          fetch('/api/admin/courses'),
          fetch('/api/pending-courses')
        ]);
        const courses = await coursesRes.json();
        const pendingCourses = await pendingRes.json();
        
        courseSel.innerHTML = '';
        
        // Add deployed courses
        const deployedGroup = document.createElement('optgroup');
        deployedGroup.label = 'Deployed Courses';
        courses.forEach(c => { 
          const opt = document.createElement('option'); 
          opt.value = c.id || c.slug || c.title; 
          opt.textContent = c.title; 
          deployedGroup.appendChild(opt); 
        });
        courseSel.appendChild(deployedGroup);
        
        // Add pending courses
        if (pendingCourses && pendingCourses.length > 0) {
          const pendingGroup = document.createElement('optgroup');
          pendingGroup.label = 'Pending Courses';
          pendingCourses.forEach(c => { 
            const opt = document.createElement('option'); 
            opt.value = c.id; 
            opt.textContent = c.title + ' (Pending)'; 
            pendingGroup.appendChild(opt); 
          });
          courseSel.appendChild(pendingGroup);
        }

        async function refreshModuleList() {
          const courseId = courseSel.value;
          const ms = await import('/js/core/moduleService.js');
          let modules = await ms.getModulesForCourse(courseId);
          
          // Also load pending modules for this course
          const adminEmail = localStorage.getItem('adminEmail') || '';
          const pendingRes = await fetch('/api/pending-modules', { headers: { 'X-Author-Email': adminEmail } }).catch(() => ({ json: async () => [] }));
          const allPending = await pendingRes.json().catch(() => []);
          const pendingModules = allPending.filter(m => m.courseId === courseId) || [];
          
          // Combine deployed and pending modules
          const allModules = [...(modules || []), ...pendingModules];
          
          modulesList.innerHTML = '';
          let normalized = (allModules || []).map(m => {
            if (typeof m === 'string') return { file: m, title: m };
            if (m && typeof m === 'object') {
              const file = m.content || m.file || m.slug || m.name || m.title;
              const title = m.title || m.name || m.content || m.file || m.slug || file;
              return { ...m, file, title };
            }
            return { file: String(m), title: String(m) };
          });
          if (!normalized || normalized.length === 0) { modulesList.innerHTML = '<div style="color:var(--text-muted)">No modules found.</div>'; return; }
          normalized.forEach(m => {
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='flex-start'; row.style.padding='8px 0'; row.style.borderBottom='1px solid #eef6fb'; row.style.wordBreak='break-word'; row.style.whiteSpace='normal';
              const link = document.createElement('a'); link.href='#'; link.style.whiteSpace='normal'; link.style.wordBreak='break-word'; link.textContent = m.title || m.file || m.name; link.addEventListener('click', async (ev)=>{ ev.preventDefault();
              editorTitle.textContent = `Editing: ${m.title || m.file}`;
              const mdFile = m.file || m.content;
              // track current selection for editor-side edit buttons
              _currentEditorCourse = courseId;
              _currentEditorFile = mdFile;
              _currentEditorEntry = m;
              // Try to load from pending first (if module was just saved)
              let content = null;
              try {
                const adminEmail = localStorage.getItem('adminEmail') || '';
                const pendingResp = await fetch('/api/pending-module/'+encodeURIComponent(courseId)+'/'+encodeURIComponent(mdFile), { headers: {'X-Author-Email': adminEmail} });
                if (pendingResp.ok) {
                  content = await pendingResp.text();
                  editorTitle.textContent = `Editing: ${m.title || m.file} (Pending Review)`;
                }
              } catch (e) { console.error('Failed to load pending content:', e); }
              // Fall back to live content if no pending version exists
              if (!content) {
                if (m && m.markdownContent && typeof m.markdownContent === 'string') content = m.markdownContent;
                else {
                  content = await (await import('/js/core/moduleService.js')).getModuleContent(courseId, mdFile);
                }
              }
              editor.value = content || '';
              
              // Debounced preview update for better performance
              let previewTimeout;
              const updatePreviewLocal = () => {
                clearTimeout(previewTimeout);
                previewTimeout = setTimeout(() => {
                  if (window.updatePreview) {
                    window.updatePreview();
                  }
                }, 300); // Update 300ms after user stops typing
              };
              editor.removeEventListener('input', updatePreviewLocal);
              editor.addEventListener('input', updatePreviewLocal);
              
              // attach save handler (save to pending/staging area for review)
              saveBtn.onclick = async ()=>{ 
                saveBtn.disabled = true; 
                try { 
                  const adminEmail = localStorage.getItem('adminEmail') || ''; 
                  const r = await fetch('/api/pending-module/'+encodeURIComponent(courseId)+'/'+encodeURIComponent(mdFile), { 
                    method: 'POST', 
                    headers: {'Content-Type':'text/plain','X-Author-Email': adminEmail}, 
                    body: editor.value 
                  }); 
                  if (!r.ok) { 
                    const j = await r.json().catch(()=>({})); 
                    await showAlert('Save Failed', 'Could not save to pending: '+(j && j.error? j.error : 'Status '+r.status), 'error'); 
                  } else { 
                    await showAlert('Success', 'Module saved to Pending Deploy (awaiting review).', 'success'); 
                    // Reload the editor to show the pending content (so clicking the module again loads the saved version)
                    try {
                      const pendingContent = await fetch('/api/pending-module/'+encodeURIComponent(courseId)+'/'+encodeURIComponent(mdFile), { headers: {'X-Author-Email': adminEmail} });
                      if (pendingContent.ok) {
                        const text = await pendingContent.text();
                        editor.value = text; // Update editor to show saved pending content
                      }
                    } catch (e) { console.error('Failed to reload pending content:', e); }
                    loadDocumentsUI(); 
                  } 
                } catch (e) { 
                  console.error(e); 
                  await showAlert('Save Error', 'Failed to save module.', 'error'); 
                } finally { 
                  saveBtn.disabled = false; 
                } 
              };
            });
            row.appendChild(link);
            modulesList.appendChild(row);
          });
        }

        courseSel.addEventListener('change', refreshModuleList);
        // preselect if provided
        if (prefCourse) {
          for (let i=0;i<courseSel.options.length;i++){ if (courseSel.options[i].value===prefCourse){ courseSel.selectedIndex=i; break; } }
        }
        await refreshModuleList();
        // If prefFile provided, find and click the module link to load it
        if (prefFile) {
          setTimeout(async () => {
            const links = modulesList.querySelectorAll('a');
            for (let link of links) {
              if (link.textContent === prefTitle || link.textContent === prefFile) {
                link.click();
                break;
              }
            }
          }, 100);
        }
        // setup editor controls: markdown-only editor
        const modeSel = document.getElementById('cm-editor-mode');
        const quillContainer = document.getElementById('cm-quill-container');
        // hide mode selector and quill container since we only use markdown textarea
        if (modeSel) modeSel.style.display = 'none';
        if (quillContainer) quillContainer.style.display = 'none';
        document.getElementById('cm-content-editor').style.display = '';
        // ensure markdown image controls are hidden (no attachments)
        const mdInsertImage = document.getElementById('md-insert-image'); if (mdInsertImage) mdInsertImage.style.display = 'none';
        const mdImageInput = document.getElementById('md-image-input'); if (mdImageInput) mdImageInput.style.display = 'none';

        // Setup preview button to toggle preview visibility
        const previewBtnEl = document.getElementById('cm-preview-btn'); 
        const previewDiv = document.getElementById('cm-preview');
        
        // Create updatePreview function at module level
        window.updatePreview = async () => {
          if (previewDiv && previewDiv.style.display !== 'none') {
            try {
              const markdown = document.getElementById('cm-content-editor').value || '';
              const { marked } = await import('https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js');
              const html = marked.parse(markdown);
              previewDiv.innerHTML = html;
              previewDiv.classList.add('markdown');
            } catch (e) {
              console.error('Preview error:', e);
              previewDiv.innerHTML = '<p style="color:red">Preview error: ' + e.message + '</p>';
            }
          }
        };
        
        if (previewBtnEl && previewDiv) {
          previewBtnEl.style.display = '';
          previewBtnEl.addEventListener('click', async () => {
            const isHidden = previewDiv.style.display === 'none' || !previewDiv.style.display;
            previewDiv.style.display = isHidden ? '' : 'none';
            previewBtnEl.textContent = isHidden ? 'âœ“ Preview' : 'Preview';
            previewBtnEl.style.fontWeight = isHidden ? '600' : '400';
            if (isHidden) {
              await window.updatePreview();
            }
          });
        }

        // Initialize global editor tracking variables
        window._currentEditorCourse = null;
        window._currentEditorFile = null;
        window._currentEditorEntry = null;

        // Helper: Load current module entry
        async function _loadCurrentModuleEntry(courseId, mdFile) {
          try {
            const ms = await import('/js/core/moduleService.js');
            const modules = await ms.getModulesForCourse(courseId) || [];
            const normalized = modules.map(m => {
              if (typeof m === 'string') return { file: m, title: m };
              if (m && typeof m === 'object') {
                const file = m.content || m.file || m.slug || m.name || m.title;
                const title = m.title || m.name || m.content || m.file || m.slug || file;
                return { ...m, file, title };
              }
              return { file: String(m), title: String(m) };
            });
            return normalized.find(x=>x.file===mdFile || x.content===mdFile || x.slug===mdFile || x.name===mdFile) || null;
          } catch (e) { console.error('Failed to load module entry', e); return null; }
        }

        // Helper: Open edit modal for objectives/quiz/projects
        async function _openEditModal(kind) {
          if (!window._currentEditorCourse || !window._currentEditorFile) { await showAlert('No Module Selected', 'Please select a module to edit.', 'warning'); return; }
          window._currentEditorEntry = await _loadCurrentModuleEntry(window._currentEditorCourse, window._currentEditorFile) || window._currentEditorEntry;
          const entry = window._currentEditorEntry || {};
          
          let existingQuiz = [];
          if (entry.quiz) {
            if (Array.isArray(entry.quiz)) existingQuiz = entry.quiz;
            else if (typeof entry.quiz === 'string') {
              try { const r = await fetch(`/data/modules/${encodeURIComponent(window._currentEditorCourse)}/${encodeURIComponent(entry.quiz)}`); if (r.ok) existingQuiz = await r.json(); } catch(e){}
            }
          }
          let existingProjects = [];
          if (entry.projects) {
            if (Array.isArray(entry.projects)) existingProjects = entry.projects;
            else if (typeof entry.projects === 'string') {
              try { const r = await fetch(`/data/modules/${encodeURIComponent(window._currentEditorCourse)}/${encodeURIComponent(entry.projects)}`); if (r.ok) existingProjects = await r.json(); } catch(e){}
            }
          }
          let existingObjectives = [];
          if (entry.objectives) {
            if (Array.isArray(entry.objectives)) existingObjectives = entry.objectives;
            else if (typeof entry.objectives === 'string') {
              try { const r = await fetch(`/data/modules/${encodeURIComponent(window._currentEditorCourse)}/${encodeURIComponent(entry.objectives)}`); if (r.ok) existingObjectives = await r.json(); } catch(e){}
            }
          }
          let existingResources = [];
          if (entry.resources) {
            if (Array.isArray(entry.resources)) existingResources = entry.resources;
            else if (typeof entry.resources === 'string') {
              try { const r = await fetch(`/data/modules/${encodeURIComponent(window._currentEditorCourse)}/${encodeURIComponent(entry.resources)}`); if (r.ok) existingResources = await r.json(); } catch(e){}
            }
          }

          if (kind === 'objectives') {
            const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
            const inner = document.createElement('div'); inner.className = 'edit-modal-inner'; inner.style.cssText = 'background:#fff;padding:24px;border-radius:8px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;';
            let html = '<h3 style="margin-top:0">Edit Learning Objectives</h3>';
            for (let i=0;i<10;i++) {
              const obj = existingObjectives[i] || '';
              html += `<div style="margin-bottom:12px"><label style="display:block;font-weight:600;margin-bottom:6px">Objective ${i+1}</label><textarea id="obj-${i}-edit" rows="2" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;font-family:Poppins,sans-serif">${escapeHtml(obj)}</textarea></div>`;
            }
            html += '<div style="display:flex;gap:8px;margin-top:16px"><button id="obj-save-edit" class="btn-primary" style="flex:1">Save Objectives</button><button id="obj-cancel-edit" class="btn" style="flex:1">Cancel</button></div>';
            inner.innerHTML = html; modal.appendChild(inner); document.body.appendChild(modal);
            const objSaveBtn = modal.querySelector('#obj-save-edit');
            const objCancelBtn = modal.querySelector('#obj-cancel-edit');
            if (objSaveBtn) objSaveBtn.addEventListener('click', async ()=>{
              const objs = [];
              for (let i=0;i<10;i++){ const el = modal.querySelector('#obj-'+i+'-edit'); const v = el ? el.value.trim() : ''; if (v) objs.push(v); }
              const content = editor.value || '';
              const body = { id: entry.id || undefined, title: entry.title || undefined, file: window._currentEditorFile, tag: entry.tag || undefined, isPremium: !!entry.isPremium, objectives: objs.length>0?objs:undefined, quiz: existingQuiz && existingQuiz.length>0? existingQuiz : (entry.quiz||undefined), projects: existingProjects && existingProjects.length>0? existingProjects : (entry.projects||undefined), content };
              const r = await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse), { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
              modal.remove();
              if (!r.ok) { let msg = `Status ${r.status}`; try { const t = await r.text(); if (t) msg += ' â€” ' + t; } catch(e){} await showAlert('Save Failed', 'Failed to save objectives: '+msg, 'error'); return; }
              // Sync modules to localStorage after save
              (async () => {
                try {
                  const modules = await (await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse))).json();
                  await StorageSync.saveModules(window._currentEditorCourse, modules);
                } catch(e) {}
              })();
              await showAlert('Success', 'Learning objectives saved successfully.', 'success');
            });
            if (objCancelBtn) objCancelBtn.addEventListener('click', ()=>{ modal.remove(); });
            return;
          }

          if (kind === 'quiz') {
            const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
            const inner = document.createElement('div'); inner.className = 'edit-modal-inner'; inner.style.cssText = 'background:#fff;padding:24px;border-radius:8px;width:90%;max-width:700px;max-height:80vh;overflow-y:auto;';
            let html = '<h3 style="margin-top:0">Edit Quiz Questions (10 slots)</h3>';
            for (let i=0;i<10;i++) {
              const q = existingQuiz[i] || {};
              html += `<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee"><label style="display:block;font-weight:600;margin-bottom:6px">Question ${i+1}</label><textarea id="quiz-q-${i}-edit" rows="2" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;margin-bottom:8px">${escapeHtml(q.question||'')}</textarea><label style="display:block;font-weight:600;margin-bottom:6px">Options (comma-separated)</label><textarea id="quiz-opts-${i}-edit" rows="2" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;margin-bottom:8px">${escapeHtml((q.options||[]).join(', '))}</textarea><label style="display:block;font-weight:600;margin-bottom:6px">Correct Answer (0-based index)</label><input id="quiz-ans-${i}-edit" type="number" placeholder="0" min="0" value="${q.answer !== undefined ? q.answer : ''}" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd"></div>`;
            }
            html += '<div style="display:flex;gap:8px;margin-top:16px"><button id="quiz-save-edit" class="btn-primary" style="flex:1">Save Quiz</button><button id="quiz-cancel-edit" class="btn" style="flex:1">Cancel</button></div>';
            inner.innerHTML = html; modal.appendChild(inner); document.body.appendChild(modal);
            const quizSaveBtn = modal.querySelector('#quiz-save-edit');
            const quizCancelBtn = modal.querySelector('#quiz-cancel-edit');
            if (quizSaveBtn) quizSaveBtn.addEventListener('click', async ()=>{
              const qArr = [];
              for (let i=0;i<10;i++) {
                const qEl = modal.querySelector('#quiz-q-'+i+'-edit');
                const optsEl = modal.querySelector('#quiz-opts-'+i+'-edit');
                const ansEl = modal.querySelector('#quiz-ans-'+i+'-edit');
                const q = qEl ? qEl.value.trim() : '';
                const opts = optsEl ? (optsEl.value || '').trim() : '';
                const ans = ansEl ? ansEl.value : '';
                if (q || opts || ans) { qArr.push({ question: q, options: opts?opts.split(',').map(s=>s.trim()):[], answer: Number.isFinite(Number(ans))?parseInt(ans):0 }); }
              }
              const content = editor.value || '';
              const body = { id: entry.id || undefined, title: entry.title || undefined, file: window._currentEditorFile, tag: entry.tag || undefined, isPremium: !!entry.isPremium, objectives: existingObjectives && existingObjectives.length>0? existingObjectives : undefined, quiz: qArr.length>0?qArr:undefined, projects: existingProjects && existingProjects.length>0? existingProjects : (entry.projects||undefined), content };
              const r = await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse), { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
              modal.remove();
              if (!r.ok) { let msg = `Status ${r.status}`; try { const t = await r.text(); if (t) msg += ' â€” ' + t; } catch(e){} await showAlert('Save Failed', 'Failed to save quiz: '+msg, 'error'); return; }
              // Sync modules to localStorage after save
              (async () => {
                try {
                  const modules = await (await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse))).json();
                  await StorageSync.saveModules(window._currentEditorCourse, modules);
                } catch(e) {}
              })();
              await showAlert('Success', 'Quiz questions saved successfully.', 'success');
            });
            if (quizCancelBtn) quizCancelBtn.addEventListener('click', ()=>{ modal.remove(); });
            return;
          }

          if (kind === 'projects') {
            const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
            const inner = document.createElement('div'); inner.className = 'edit-modal-inner'; inner.style.cssText = 'background:#fff;padding:24px;border-radius:8px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;';
            let html = '<h3 style="margin-top:0">Edit Projects</h3>';
            for (let i=0;i<5;i++) {
              const p = existingProjects[i] || {};
              html += `<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee"><label style="display:block;font-weight:600;margin-bottom:6px">Project ${i+1} Title</label><input id="proj-title-${i}-edit" type="text" value="${escapeHtml(p.title||'')}" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;margin-bottom:8px"><label style="display:block;font-weight:600;margin-bottom:6px">Description</label><textarea id="proj-desc-${i}-edit" rows="3" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd">${escapeHtml(p.description||'')}</textarea></div>`;
            }
            html += '<div style="display:flex;gap:8px;margin-top:16px"><button id="proj-save-edit" class="btn-primary" style="flex:1">Save Projects</button><button id="proj-cancel-edit" class="btn" style="flex:1">Cancel</button></div>';
            inner.innerHTML = html; modal.appendChild(inner); document.body.appendChild(modal);
            const projSaveBtn = modal.querySelector('#proj-save-edit');
            const projCancelBtn = modal.querySelector('#proj-cancel-edit');
            if (projSaveBtn) projSaveBtn.addEventListener('click', async ()=>{
              const pArr = [];
              for (let i=0;i<5;i++) {
                const titleEl = modal.querySelector('#proj-title-'+i+'-edit');
                const descEl = modal.querySelector('#proj-desc-'+i+'-edit');
                const title = titleEl ? titleEl.value.trim() : '';
                const desc = descEl ? descEl.value.trim() : '';
                if (title || desc) pArr.push({ title, description: desc });
              }
              const content = editor.value || '';
              const body = { id: entry.id || undefined, title: entry.title || undefined, file: window._currentEditorFile, tag: entry.tag || undefined, isPremium: !!entry.isPremium, objectives: existingObjectives && existingObjectives.length>0? existingObjectives : undefined, quiz: existingQuiz && existingQuiz.length>0? existingQuiz : undefined, projects: pArr.length>0? pArr:undefined, content };
              const r = await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse), { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
              modal.remove();
              if (!r.ok) { let msg = `Status ${r.status}`; try { const t = await r.text(); if (t) msg += ' â€” ' + t; } catch(e){} await showAlert('Save Failed', 'Failed to save projects: '+msg, 'error'); return; }
              // Sync modules to localStorage after save
              (async () => {
                try {
                  const modules = await (await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse))).json();
                  await StorageSync.saveModules(window._currentEditorCourse, modules);
                } catch(e) {}
              })();
              await showAlert('Success', 'Projects saved successfully.', 'success');
            });
            if (projCancelBtn) projCancelBtn.addEventListener('click', ()=>{ modal.remove(); });
            return;
          }

          if (kind === 'resources') {
            const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
            const inner = document.createElement('div'); inner.className = 'edit-modal-inner'; inner.style.cssText = 'background:#fff;padding:24px;border-radius:8px;width:90%;max-width:700px;max-height:80vh;overflow-y:auto;';
            let html = '<h3 style="margin-top:0">Edit Resources (20 slots max)</h3>';
            for (let i=0;i<20;i++) {
              const res = existingResources[i] || {};
              html += `<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee"><label style="display:block;font-weight:600;margin-bottom:6px">Resource ${i+1} Name</label><input id="res-name-${i}-edit" type="text" value="${escapeHtml(res.name||'')}" placeholder="e.g., Solar Energy Guide" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;margin-bottom:8px"><label style="display:block;font-weight:600;margin-bottom:6px">Resource URL</label><input id="res-url-${i}-edit" type="url" value="${escapeHtml(res.url||'')}" placeholder="https://example.com/resource" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd"></div>`;
            }
            html += '<div style="display:flex;gap:8px;margin-top:16px"><button id="res-save-edit" class="btn-primary" style="flex:1">Save Resources</button><button id="res-cancel-edit" class="btn" style="flex:1">Cancel</button></div>';
            inner.innerHTML = html; modal.appendChild(inner); document.body.appendChild(modal);
            const resSaveBtn = modal.querySelector('#res-save-edit');
            const resCancelBtn = modal.querySelector('#res-cancel-edit');
            if (resSaveBtn) resSaveBtn.addEventListener('click', async ()=>{
              const rArr = [];
              for (let i=0;i<20;i++) {
                const nameEl = modal.querySelector('#res-name-'+i+'-edit');
                const urlEl = modal.querySelector('#res-url-'+i+'-edit');
                const name = nameEl ? nameEl.value.trim() : '';
                const url = urlEl ? urlEl.value.trim() : '';
                if (name || url) rArr.push({ name, url });
              }
              const content = editor.value || '';
              const body = { id: entry.id || undefined, title: entry.title || undefined, file: window._currentEditorFile, tag: entry.tag || undefined, isPremium: !!entry.isPremium, objectives: existingObjectives && existingObjectives.length>0? existingObjectives : undefined, quiz: existingQuiz && existingQuiz.length>0? existingQuiz : undefined, projects: existingProjects && existingProjects.length>0? existingProjects : (entry.projects||undefined), resources: rArr.length>0? rArr:undefined, content };
              const r = await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse), { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
              modal.remove();
              if (!r.ok) { let msg = `Status ${r.status}`; try { const t = await r.text(); if (t) msg += ' â€” ' + t; } catch(e){} await showAlert('Save Failed', 'Failed to save resources: '+msg, 'error'); return; }
              // Sync modules to localStorage after save
              (async () => {
                try {
                  const modules = await (await fetch('/api/modules/'+encodeURIComponent(window._currentEditorCourse))).json();
                  await StorageSync.saveModules(window._currentEditorCourse, modules);
                } catch(e) {}
              })();
              await showAlert('Success', 'Resources saved successfully.', 'success');
            });
            if (resCancelBtn) resCancelBtn.addEventListener('click', ()=>{ modal.remove(); });
            return;
          }
        }

        // Wire up editor buttons
        const fsBtn = document.getElementById('cm-fullscreen-btn');
        const editorArea = document.getElementById('cm-editor-area');
        if (fsBtn && editorArea) {
          let inFs = false;
          let fsToolbar = null;
          let prevPaddingTop = '';

          function createFsToolbar() {
            if (fsToolbar) return;
            fsToolbar = document.createElement('div');
            fsToolbar.id = 'cm-fullscreen-toolbar';
            fsToolbar.style.cssText = 'position:fixed;top:24px;right:24px;display:flex;gap:8px;z-index:120000;';

            const ids = ['cm-insert-image-btn','cm-edit-objectives-btn','cm-edit-quiz-btn','cm-edit-projects-btn','cm-edit-resources-btn','cm-save-btn'];
            ids.forEach(id => {
              const orig = document.getElementById(id);
              const b = document.createElement('button');
              b.className = orig ? orig.className : 'btn';
              b.textContent = orig ? orig.textContent : id;
              b.style.cssText = 'padding:6px 10px;border-radius:6px;';
              b.addEventListener('click', (ev) => { ev.preventDefault(); if (orig) orig.click(); });
              fsToolbar.appendChild(b);
            });

            const exitBtn = document.createElement('button');
            exitBtn.className = 'btn';
            exitBtn.textContent = 'Exit';
            exitBtn.style.cssText = 'padding:6px 10px;border-radius:6px;background:transparent;';
            exitBtn.addEventListener('click', () => { fsBtn.click(); });
            fsToolbar.appendChild(exitBtn);

            // ensure toolbar is positioned relative to viewport (fixed) so it doesn't scroll
            document.body.appendChild(fsToolbar);

            // increase editor padding so toolbar doesn't overlap first line
            prevPaddingTop = editorArea.style.paddingTop || '';
            editorArea.style.paddingTop = '72px';
          }

          function removeFsToolbar() {
            if (!fsToolbar) return;
            try { fsToolbar.remove(); } catch(e){}
            fsToolbar = null;
            editorArea.style.paddingTop = prevPaddingTop;
          }

          fsBtn.addEventListener('click', () => {
            if (!inFs) {
              // Use CSS-based fullscreen only (avoid Fullscreen API to prevent duplicate layers)
              editorArea.classList.add('editor-fullscreen');
              fsBtn.textContent = 'Exit full screen';
              document.body.style.overflow = 'hidden';
              createFsToolbar();
              inFs = true;
            } else {
              editorArea.classList.remove('editor-fullscreen');
              fsBtn.textContent = 'Full screen';
              document.body.style.overflow = '';
              removeFsToolbar();
              inFs = false;
            }
          });

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && inFs) {
              fsBtn.click();
            }
            // Ctrl+F for fullscreen toggle
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
              e.preventDefault();
              fsBtn.click();
            }
          });
        }

        document.getElementById('cm-edit-objectives-btn').addEventListener('click', () => _openEditModal('objectives'));
        document.getElementById('cm-edit-quiz-btn').addEventListener('click', () => _openEditModal('quiz'));
        document.getElementById('cm-edit-projects-btn').addEventListener('click', () => _openEditModal('projects'));
        document.getElementById('cm-edit-resources-btn').addEventListener('click', () => _openEditModal('resources'));
        document.getElementById('cm-insert-image-btn').addEventListener('click', async () => {
          const modal = document.createElement('div'); 
          modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
          const inner = document.createElement('div'); 
          inner.className = 'edit-modal-inner';
          inner.style.cssText = 'background:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;';
          const timestamp = Date.now();
          inner.innerHTML = `
            <h3 style="margin-top:0">Insert Image</h3>
            <p style="color:var(--text-muted);font-size:14px">Insert an image using markdown syntax or add a caption to embed a responsive figure.</p>
            
            <div style="margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:6px;border:2px dashed #00796b">
              <label style="display:block;font-weight:600;margin-bottom:8px">Upload Local Image</label>
              <input id="img-file-input-${timestamp}" type="file" accept="image/*" style="display:none;">
              <button type="button" id="img-upload-btn-${timestamp}" class="btn-primary" style="width:100%;padding:10px;cursor:pointer">Choose Image File</button>
              <small id="img-upload-status-${timestamp}" style="display:block;margin-top:8px;color:#666;text-align:center"></small>
            </div>
            
            <div style="text-align:center;margin-bottom:16px;color:#999">OR</div>
            
            <div style="margin-bottom:12px">
              <label style="display:block;font-weight:600;margin-bottom:6px">Alt Text (description)</label>
              <input id="img-alt-${timestamp}" type="text" placeholder="Enter image description" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd">
            </div>
            <div style="margin-bottom:12px">
              <label style="display:block;font-weight:600;margin-bottom:6px">Image URL</label>
              <input id="img-url-${timestamp}" type="text" placeholder="https://example.com/image.jpg" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd">
            </div>
            <div style="margin-bottom:16px">
              <label style="display:block;font-weight:600;margin-bottom:6px">Caption (optional)</label>
              <input id="img-caption-${timestamp}" type="text" placeholder="Caption to display under the image (optional)" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd">
            </div>
            <div style="display:flex;gap:8px">
              <button id="img-insert-${timestamp}" class="btn-primary" style="flex:1">Insert Image</button>
              <button id="img-cancel-${timestamp}" class="btn" style="flex:1">Cancel</button>
            </div>
          `;
          modal.appendChild(inner); 
          document.body.appendChild(modal);
          
          // Allow clicking outside to close
          modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
          });
          
          const altInput = inner.querySelector(`#img-alt-${timestamp}`);
          const urlInput = inner.querySelector(`#img-url-${timestamp}`);
          const captionInput = inner.querySelector(`#img-caption-${timestamp}`);
          const insertBtn = inner.querySelector(`#img-insert-${timestamp}`);
          const cancelBtn = inner.querySelector(`#img-cancel-${timestamp}`);
          const fileInput = inner.querySelector(`#img-file-input-${timestamp}`);
          const uploadBtn = inner.querySelector(`#img-upload-btn-${timestamp}`);
          const uploadStatus = inner.querySelector(`#img-upload-status-${timestamp}`);
          
          // Upload button click handler
          uploadBtn.addEventListener('click', () => {
            fileInput.click();
          });
          
          // File input change handler
          fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            uploadStatus.textContent = 'Uploading...';
            uploadStatus.style.color = '#666';
            
            try {
              const formData = new FormData();
              formData.append('image', file);
              
              const response = await fetch('/api/upload-image', {
                method: 'POST',
                body: formData
              });
              
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
              }
              
              const result = await response.json();
              urlInput.value = result.url;
              uploadStatus.textContent = 'âœ“ Image uploaded successfully';
              uploadStatus.style.color = '#00796b';
            } catch (err) {
              console.error('Upload error:', err);
              uploadStatus.textContent = 'Upload failed: ' + (err.message || 'Unknown error');
              uploadStatus.style.color = '#dc2626';
            }
          });
          
          insertBtn.addEventListener('click', async () => {
            try {
              const alt = (altInput.value || 'image').trim();
              const url = urlInput.value.trim();
              const caption = (captionInput.value || '').trim();
              if (!url) { await showAlert('Missing URL', 'Please enter an image URL or upload an image.', 'warning'); return; }
              let markdownSyntax = `![${alt}](${url})`;
              if (caption) {
                const escAlt = escapeHtml(alt);
                const escUrl = escapeHtml(url);
                const escCaption = escapeHtml(caption);
                markdownSyntax = `<figure class="inline-figure"><img src="${escUrl}" alt="${escAlt}" loading="lazy" decoding="async"><figcaption class="image-caption">${escCaption}</figcaption></figure>`;
              }
              const start = editor.selectionStart || 0;
              const end = editor.selectionEnd || 0;
              const before = editor.value.substring(0, start);
              const after = editor.value.substring(end);
              editor.value = before + markdownSyntax + after;
              editor.selectionStart = editor.selectionEnd = start + markdownSyntax.length;
              editor.focus();
              modal.remove();
              await showAlert('Success', 'Image inserted.', 'success');
            } catch (err) {
              console.error('Insert image error', err);
              await showAlert('Insert Error', 'Failed to insert image: '+(err && err.message ? err.message : String(err)), 'error');
            }
          });
          
          cancelBtn.addEventListener('click', () => { 
            modal.remove(); 
          });
        });

      } catch (e) { console.error('loadContentManagementUI error:', e); }
    }

    // ----- Content Management -----

    async function loadInboxUI() {
      const container = document.getElementById('inbox-panel');
      if (!container) return;
      container.innerHTML = '';

      // Check admin role - only admin and superadmin can access
      const adminRole = localStorage.getItem('adminRole');
      const adminToken = localStorage.getItem('adminToken');

      if (!adminRole || (adminRole !== 'admin' && adminRole !== 'superadmin')) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);"><p>Access denied. Only admins can view the inbox.</p></div>';
        return;
      }

      // Dynamically import and render the inboxPage module
      try {
        const { renderInboxPage } = await import('./js/pages/inboxPage.js');
        const inboxContent = await renderInboxPage();
        container.appendChild(inboxContent);
      } catch (err) {
        console.error('Error loading inbox page:', err);
        container.innerHTML = '<div style="padding: 40px; color: #dc2626;"><p>Error loading inbox: ' + err.message + '</p></div>';
      }
    }

    async function loadAnalyticsUI() {
      const container = document.getElementById('analytics-panel');
      if (!container) return;
      let body = container.querySelector('.tab-body');
      if (!body) { body = document.createElement('div'); body.className = 'tab-body'; container.appendChild(body); }
      body.innerHTML = '<div id="analytics-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px"></div>';
      const wrap = body.querySelector('#analytics-cards');
      try {
        const res = await fetch('/api/admin/analytics');
        const d = await res.json();
        wrap.innerHTML = `<div class="stat-card"><div class="stat-number">${d.totalUsers}</div><div class="stat-label">Total Users</div></div>` +
          `<div class="stat-card"><div class="stat-number">${d.totalCourses}</div><div class="stat-label">Total Courses</div></div>` +
          `<div class="stat-card"><div class="stat-number">${d.activeSessions}</div><div class="stat-label">Active Chats</div></div>`;
      } catch (err) { wrap.innerHTML = '<div style="color:var(--text-muted)">Unable to load analytics.</div>'; console.error(err); }
    }

    async function loadSettingsUI() {
      const container = document.getElementById('settings-panel');
      if (!container) return;
      let body = container.querySelector('.tab-body');
      if (!body) { body = document.createElement('div'); body.className = 'tab-body'; container.appendChild(body); }
      body.innerHTML = `<div class="card" style="padding:12px">
        <form id="settings-form" style="display:flex;flex-direction:column;gap:10px">
          <label>Site Name
            <input id="setting-siteName" placeholder="Site Name" />
          </label>
          <div class="settings-row">
            <span class="field-title">Welcome Message</span>
            <textarea id="setting-welcome" placeholder="Welcome Message"></textarea>
          </div>
          <div class="settings-checkboxes">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="setting-allowRegistrations"/> Allow Registrations</label>
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="setting-maintenanceMode"/> Maintenance Mode</label>
            <label style="display:flex;align-items:center;gap:8px">Default Role
              <select id="setting-defaultRole" style="margin-left:8px">
                <option value="student">Student</option>
                <option value="instructor">Instructor</option>
              </select>
            </label>
          </div>
          <label>Analytics Refresh Interval (seconds)
            <input id="setting-analyticsInterval" type="number" min="5" step="5" style="width:140px" />
          </label>
          <label>Contact Email
            <input id="setting-contactEmail" type="email" placeholder="admin@yourdomain.com" />
          </label>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" type="submit">Save Settings</button>
            <button id="settings-reset" type="button" class="btn">Reset to Defaults</button>
          </div>
        </form>
      </div>`;

      try {
        const res = await fetch('/api/admin/settings');
        const s = await res.json();
        document.getElementById('setting-siteName').value = s.siteName || '';
        document.getElementById('setting-welcome').value = s.welcome || '';
        document.getElementById('setting-contactEmail').value = s.contactEmail || '';
        document.getElementById('setting-analyticsInterval').value = s.analyticsInterval || 60;
        document.getElementById('setting-defaultRole').value = s.defaultRole || 'student';
        document.getElementById('setting-allowRegistrations').checked = !!s.allowRegistrations;
        document.getElementById('setting-maintenanceMode').checked = !!s.maintenanceMode;
      } catch (err) { console.error(err); }

      document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const siteName = document.getElementById('setting-siteName').value.trim();
        const welcome = document.getElementById('setting-welcome').value.trim();
        const contactEmail = document.getElementById('setting-contactEmail').value.trim();
        const analyticsInterval = parseInt(document.getElementById('setting-analyticsInterval').value, 10) || 60;
        const defaultRole = document.getElementById('setting-defaultRole').value;
        const allowRegistrations = !!document.getElementById('setting-allowRegistrations').checked;
        const maintenanceMode = !!document.getElementById('setting-maintenanceMode').checked;

        const payload = { siteName, welcome, contactEmail, analyticsInterval, defaultRole, allowRegistrations, maintenanceMode };
        try {
          const token = localStorage.getItem('adminToken');
          await fetch('/api/admin/settings', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify(payload) });
          await showAlert('Saved', 'Settings have been saved successfully.', 'success');
        } catch (err) { console.error(err); await showAlert('Error', 'Failed to save settings.', 'error'); }
      });

      document.getElementById('settings-reset').addEventListener('click', async () => {
        if (!confirm('Reset settings to defaults?')) return;
        const defaults = { siteName: 'Aubie RET Hub', welcome: '', contactEmail: '', analyticsInterval: 60, defaultRole: 'student', allowRegistrations: true, maintenanceMode: false };
        try { await fetch('/api/admin/settings', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(defaults) });
          await showAlert('Reset', 'Settings reset to defaults.', 'info');
          loadSettingsUI();
        } catch (err) { console.error(err); await showAlert('Error', 'Failed to reset settings.', 'error'); }
      });

      // ===== ENABLE ENTER KEY SUBMISSION FOR ALL FORMS =====
      // Add user form
      enableEnterSubmit('new-name', 'add-user-form');
      enableEnterSubmit('new-email', 'add-user-form');
      enableEnterSubmit('new-password', 'add-user-form');
      
      // Add course form
      enableEnterSubmit('course-title', 'add-course-form');
      enableEnterSubmit('course-slug', 'add-course-form');
      enableEnterSubmit('course-image', 'add-course-form');
      enableEnterSubmit('course-desc', 'add-course-form');
      
      // Edit course form
      enableEnterSubmit('edit-course-title', 'edit-course-form');
      enableEnterSubmit('edit-course-slug', 'edit-course-form');
      enableEnterSubmit('edit-course-image', 'edit-course-form');
      enableEnterSubmit('edit-course-desc', 'edit-course-form');
      
      // Module add form (textareas)
      enableEnterSubmit('mm-content', 'mm-add-form');
      
      // Module edit form (textareas)
      enableEnterSubmit('mm-edit-content', 'mm-edit-form');
      
      // Content editor - special handler for Enter key (clicks save button instead)
      const cmContentEditor = document.getElementById('cm-content-editor');
      if (cmContentEditor) {
        cmContentEditor.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey && e.ctrlKey) {
            // Use Ctrl+Enter since plain Enter would be too annoying for long text editing
            e.preventDefault();
            const saveBtn = document.getElementById('cm-save-btn');
            if (saveBtn && saveBtn.onclick) saveBtn.onclick();
          }
        });
      }
      
      // Settings form
      enableEnterSubmit('setting-welcome', 'settings-form');
      enableEnterSubmit('setting-contactEmail', 'settings-form');
    }

    async function loadDiscussionsUI() {
      const courseSelect = document.getElementById('disc-course-select');
      const sessionsList = document.getElementById('disc-sessions-list');
      const form = document.getElementById('create-discussion-form');

      if (!courseSelect || !sessionsList || !form) return;

      // Load courses for dropdown
      try {
        const res = await fetch('/api/courses');
        const courses = await res.json();
        courseSelect.innerHTML = '<option value="">-- Select a course --</option>';
        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course.id;
          option.textContent = course.title;
          courseSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading courses:', error);
      }

      // Load active and upcoming sessions
      await refreshDiscussionSessions(sessionsList);

      // Set first tab as active
      setTimeout(() => {
        const firstTab = document.querySelector('.disc-tab-btn[data-tab="all"]');
        if (firstTab) firstTab.classList.add('active');
      }, 100);

      // Keep sessions list in sync (auto-refresh every 15 seconds)
      setInterval(async () => {
        try {
          await refreshDiscussionSessions(sessionsList);
        } catch (err) {
          console.warn('Auto-refresh sessions failed:', err.message);
        }
      }, 15000);

      // Form submission
      form.onsubmit = async (e) => {
        e.preventDefault();
        const notice = document.getElementById('disc-form-notice');
        const submitBtn = document.getElementById('disc-create-btn');

        const courseId = document.getElementById('disc-course-select').value;
        const subject = document.getElementById('disc-subject').value.trim();
        const description = document.getElementById('disc-description').value.trim();
        const sessionType = document.getElementById('disc-type').value;
        const startTime = document.getElementById('disc-start-time').value;
        const endTime = document.getElementById('disc-end-time').value;

        if (!courseId || !subject || !startTime || !endTime) {
          showNotice(notice, 'Please fill in all required fields', 'error');
          return;
        }

        if (new Date(endTime) <= new Date(startTime)) {
          showNotice(notice, 'End time must be after start time', 'error');
          return;
        }

        submitBtn.disabled = true;
        try {
          const adminRole = localStorage.getItem('adminRole') || 'superadmin';
          const adminEmail = localStorage.getItem('adminEmail') || '';
          const response = await fetch('/api/discussions/sessions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('adminToken'),
              'x-user-id': adminEmail,
              'x-user-role': adminRole
            },
            body: JSON.stringify({
              courseId,
              subject,
              description,
              sessionType,
              startTime: new Date(startTime).toISOString(),
              endTime: new Date(endTime).toISOString()
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to create session');
          }

          const session = await response.json();
          showNotice(notice, 'Session created successfully!', 'success');
          form.reset();
          courseSelect.innerHTML = '<option value="">-- Select a course --</option>';
          
          // Reload courses and sessions
          try {
            const res = await fetch('/api/courses');
            const courses = await res.json();
            courseSelect.innerHTML = '<option value="">-- Select a course --</option>';
            courses.forEach(course => {
              const option = document.createElement('option');
              option.value = course.id;
              option.textContent = course.title;
              courseSelect.appendChild(option);
            });
          } catch (e) {
            console.error('Error reloading courses:', e);
          }

          await refreshDiscussionSessions(sessionsList);
        } catch (error) {
          showNotice(notice, 'Error: ' + error.message, 'error');
        } finally {
          submitBtn.disabled = false;
        }
      };
    }

    async function refreshDiscussionSessions(container) {
      try {
        const response = await fetch('/api/discussions/sessions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('adminToken'),
            'x-user-id': localStorage.getItem('adminEmail') || '',
            'x-user-role': localStorage.getItem('adminRole') || 'superadmin'
          }
        });

        if (!response.ok) throw new Error('Failed to fetch sessions');

        const data = await response.json();
        const sessions = Array.isArray(data) ? data : (data.sessions || []);
        
        console.log('Admin fetched sessions:', sessions.length, 'total');
        
        // Filter to show active and upcoming only
        const now = new Date();
        const relevantSessions = sessions
          .filter(s => {
            const startTime = new Date(s.startTime);
            const endTime = new Date(s.endTime);
            return startTime < new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // Next 7 days
          })
          .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
          .slice(0, 10); // Show last 10

        if (!relevantSessions || relevantSessions.length === 0) {
          container.innerHTML = '<div style="padding: 40px 24px; text-align: center; color: var(--text-muted);"><i class="fas fa-inbox" style="font-size: 40px; opacity: 0.2; display: block; margin-bottom: 12px;"></i><p style="margin: 0; font-size: 14px;">No sessions yet</p><p style="margin: 4px 0 0 0; font-size: 12px;">Create one to get started</p></div>';
          return;
        }

        container.innerHTML = '';
        relevantSessions.forEach(session => {
          const status = getSessionStatus(session.status);
          const startTime = new Date(session.startTime);
          const endTime = new Date(session.endTime);
          const typeClass = session.sessionType === 'peer' ? 'peer' : 'instructor';

          const card = document.createElement('div');
          card.className = 'disc-session-card';
          card.innerHTML = `
            <div class="disc-session-card-header">
              <div>
                <div class="disc-session-title">${escapeHtml(session.subject)}</div>
                <div class="disc-session-course">${session.courseId || 'Course'}</div>
              </div>
              <div style="display: flex; gap: 6px; align-items: center;">
                <span class="disc-session-badge ${typeClass}">${session.sessionType === 'peer' ? 'Peer' : 'Instructor'}</span>
                <span class="disc-session-badge ${session.status}">${status.label}</span>
              </div>
            </div>

            <div class="disc-session-info">
              <div class="disc-session-meta">
                <i class="fas fa-calendar-alt"></i>
                <span>${startTime.toLocaleDateString()}</span>
              </div>
              <div class="disc-session-meta">
                <i class="fas fa-clock"></i>
                <span>${startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
              </div>
              <div class="disc-session-meta">
                <i class="fas fa-users"></i>
                <span>${session.participantCount || 0} participants</span>
              </div>
              <div class="disc-session-meta">
                <i class="fas fa-id-badge"></i>
                <span style="font-family: monospace; font-size: 11px;">${(session.sessionId || 'N/A').substring(0, 12)}...</span>
              </div>
            </div>

            <div class="disc-session-actions">
              ${session.status !== 'closed' ? `
                <button class="disc-session-btn disc-session-btn-primary" onclick="joinDiscussionSession('${session.sessionId}')">
                  <i class="fas fa-sign-in-alt" style="margin-right: 4px;"></i>Join
                </button>
              ` : '<button class="disc-session-btn disc-session-btn-primary" style="opacity: 0.5; cursor: not-allowed;" disabled>Join</button>'}
              <button class="disc-session-btn disc-session-btn-secondary" onclick="viewSessionDetails('${session.sessionId}')">
                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>Details
              </button>
              ${session.status !== 'closed' ? `
                <button class="disc-session-btn disc-session-btn-danger" onclick="endDiscussionSession('${session.sessionId}', '${escapeHtml(session.subject)}')">
                  <i class="fas fa-stop-circle" style="margin-right: 4px;"></i>End
                </button>
              ` : ''}
              <button class="disc-session-btn disc-session-btn-danger" onclick="deleteDiscussionSession('${session.sessionId}', '${escapeHtml(session.subject)}')">
                <i class="fas fa-trash" style="margin-right: 4px;"></i>Delete
              </button>
            </div>
          `;
          container.appendChild(card);
        });

        // Setup tab filters
        document.querySelectorAll('.disc-tab-btn').forEach(btn => {
          btn.removeEventListener('click', handleTabClick);
          btn.addEventListener('click', handleTabClick);
        });
      } catch (error) {
        console.error('Error loading sessions:', error);
        container.innerHTML = '<div style="padding: 40px 24px; text-align: center; color: #dc2626;"><i class="fas fa-exclamation-triangle" style="font-size: 40px; display: block; margin-bottom: 12px;"></i><p style="margin: 0; font-size: 14px;">Error loading sessions</p><p style="margin: 4px 0 0 0; font-size: 12px;">Please try again</p></div>';
      }
    }

    function handleTabClick(e) {
      const tab = e.currentTarget.getAttribute('data-tab');
      const container = document.getElementById('disc-sessions-list');
      
      // Update active button
      document.querySelectorAll('.disc-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      e.currentTarget.classList.add('active');

      // Filter cards
      const cards = container.querySelectorAll('.disc-session-card');
      cards.forEach(card => {
        const badges = card.querySelectorAll('.disc-session-badge');
        let statusBadge = '';
        badges.forEach(b => {
          if (b.classList.contains('active') || b.classList.contains('upcoming') || b.classList.contains('closed')) {
            statusBadge = b.textContent.trim();
          }
        });

        if (tab === 'all') {
          card.style.display = '';
        } else if (tab === 'active' && statusBadge === 'Active Now') {
          card.style.display = '';
        } else if (tab === 'upcoming' && statusBadge === 'Upcoming') {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }

    function getSessionStatus(status) {
      const statusMap = {
        'upcoming': { label: 'Upcoming', bg: '#dbeafe', color: '#0c4a6e' },
        'active': { label: 'Active Now', bg: '#dcfce7', color: '#166534' },
        'closed': { label: 'Closed', bg: '#f3f4f6', color: '#6b7280' }
      };
      return statusMap[status] || statusMap['upcoming'];
    }

    async function viewSessionDetails(sessionId) {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`/api/discussions/sessions/${sessionId}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'x-user-id': localStorage.getItem('adminEmail') || '',
            'x-user-role': localStorage.getItem('adminRole') || 'superadmin'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load session details');
        }

        const session = await response.json();
        
        const startTime = new Date(session.startTime);
        const endTime = new Date(session.endTime);
        const duration = Math.round((endTime - startTime) / 60000);

        const creatorName = session.creatorName || session.createdByName || (session.creator && (session.creator.name || session.creator.fullName)) || session.createdBy || 'Unknown';
        const creatorRole = session.creatorRole || session.createdByRole || (session.creator && session.creator.role) || 'unknown';
        const creatorRoleLabel = (creatorRole && typeof creatorRole === 'string') ? creatorRole.charAt(0).toUpperCase() + creatorRole.slice(1) : creatorRole;
        
        const detailsHtml = `
          <style>
            .session-details-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 24px;
              padding: 16px 0;
            }
            .session-details-grid.full {
              grid-column: 1 / -1;
            }
            .detail-item {
              display: flex;
              flex-direction: column;
              gap: 8px;
            }
            .detail-label {
              font-weight: 700;
              color: var(--green-main, #10b981);
              font-size: 11px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            .detail-value {
              color: var(--text-main, #1f2937);
              font-size: 14px;
              line-height: 1.6;
            }
            .detail-value.monospace {
              font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
              font-size: 12px;
              background: var(--bg-secondary, #f3f4f6);
              padding: 10px 12px;
              border-radius: 6px;
              word-break: break-all;
              overflow-wrap: break-word;
            }
            .status-badge {
              display: inline-block;
              padding: 6px 14px;
              border-radius: 20px;
              font-weight: 600;
              font-size: 12px;
              width: fit-content;
            }
            .status-badge.active {
              background-color: #dcfce7;
              color: #166534;
            }
            .status-badge.upcoming {
              background-color: #dbeafe;
              color: #0c4a6e;
            }
            .status-badge.closed {
              background-color: #f3f4f6;
              color: #6b7280;
            }
            .role-badge {
              display: inline-block;
              padding: 4px 12px;
              border-radius: 16px;
              background-color: var(--bg-secondary, #f3f4f6);
              color: #374151;
              font-weight: 600;
              font-size: 12px;
              width: fit-content;
            }
            .session-grid-full {
              grid-column: 1 / -1;
            }
          </style>
          <div class="session-details-grid">
            <div class="detail-item">
              <div class="detail-label">Session ID</div>
              <div class="detail-value monospace">${session.sessionId || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="status-badge ${session.status === 'active' ? 'active' : session.status === 'upcoming' ? 'upcoming' : 'closed'}">
                ${session.status === 'active' ? 'â— Active Now' : session.status === 'upcoming' ? 'â—¯ Upcoming' : 'âœ• Closed'}
              </div>
            </div>

            <div class="detail-item">
              <div class="detail-label">Created By</div>
              <div class="detail-value">${escapeHtml(creatorName)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Creator Role</div>
              <div class="role-badge">${escapeHtml(creatorRoleLabel)}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">Session Type</div>
              <div class="detail-value">${session.sessionType === 'peer' ? 'ðŸ‘¥ Peer Discussion' : 'ðŸ‘¨â€ðŸ« Instructor-Led'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Participants</div>
              <div class="detail-value">${session.participantCount || 0}</div>
            </div>

            <div class="detail-item session-grid-full">
              <div class="detail-label">Subject</div>
              <div class="detail-value">${escapeHtml(session.subject || 'N/A')}</div>
            </div>
            ${session.description ? `
            <div class="detail-item session-grid-full">
              <div class="detail-label">Description</div>
              <div class="detail-value">${escapeHtml(session.description)}</div>
            </div>
            ` : ''}
            <div class="detail-item session-grid-full">
              <div class="detail-label">Start Time</div>
              <div class="detail-value">ðŸ“… ${startTime.toLocaleString()}</div>
            </div>
            <div class="detail-item session-grid-full">
              <div class="detail-label">End Time</div>
              <div class="detail-value">ðŸ“… ${endTime.toLocaleString()}</div>
            </div>
            <div class="detail-item session-grid-full">
              <div class="detail-label">Duration</div>
              <div class="detail-value">â±ï¸ ${duration} minutes</div>
            </div>
            <div class="detail-item session-grid-full">
              <div class="detail-label">Course ID</div>
              <div class="detail-value monospace">${session.courseId || 'N/A'}</div>
            </div>
          </div>
        `;
        
        await showAlert('Session Details', detailsHtml, 'info', { isHtml: true });
      } catch (error) {
        console.error('Error loading session details:', error);
        await showAlert('Error', 'Failed to load session details: ' + error.message, 'error');
      }
    }

    async function joinDiscussionSession(sessionId) {
      try {
        console.log('[admin-dashboard] joinDiscussionSession called with sessionId:', sessionId);
        
        // Preserve admin authentication and promote to app auth
        const adminToken = localStorage.getItem('adminToken');
        const adminEmail = localStorage.getItem('adminEmail') || '';
        const adminRole = localStorage.getItem('adminRole') || 'superadmin';
        const adminName = localStorage.getItem('adminName') || 'Admin';
        const adminId = localStorage.getItem('adminId') || adminEmail;

        console.log('[admin-dashboard] Admin credentials:', { adminEmail, adminRole, token: !!adminToken });

        if (adminToken) {
          // Set standard auth token and currentUser so public pages recognize admin
          localStorage.setItem('authToken', adminToken);
          localStorage.setItem('currentUser', JSON.stringify({
            id: adminId,
            _id: adminId,
            email: adminEmail,
            name: adminName,
            fullName: adminName,
            username: adminName,
            role: adminRole
          }));
          localStorage.setItem('isLoggedIn', 'true');
          // Mark that this user came from the admin dashboard (for audits/UI)
          localStorage.setItem('fromAdminDashboard', 'true');
          
          console.log('[admin-dashboard] Auth tokens set. Redirecting to discussion room...');
        } else {
          throw new Error('No admin token found');
        }

        // Redirect into the discussion room using standard session URL
        const targetUrl = `/discussion-room.html?sessionId=${sessionId}`;
        console.log('[admin-dashboard] Redirecting to:', targetUrl);
        window.location.href = targetUrl;
      } catch (error) {
        console.error('[admin-dashboard] Error joining session:', error);
        alert('Error joining session: ' + error.message);
      }
    }

    async function deleteDiscussionSession(sessionId, subject) {
      const confirmed = await showConfirm('Delete Session', `Are you sure you want to delete the session "${subject}"? This action cannot be undone.`);
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`/api/discussions/sessions/${sessionId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('adminToken'),
            'x-user-id': localStorage.getItem('adminEmail') || '',
            'x-user-role': localStorage.getItem('adminRole') || 'superadmin'
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete session');
        }

        await showAlert('Success', 'Session deleted successfully.', 'success');
        
        // Reload sessions list
        const sessionsList = document.getElementById('disc-sessions-list');
        if (sessionsList) {
          await refreshDiscussionSessions(sessionsList);
        }
      } catch (error) {
        await showAlert('Error', 'Error deleting session: ' + error.message, 'error');
      }
    }

    async function endDiscussionSession(sessionId, subject) {
      const confirmed = await showConfirm('End Session', `End the session "${subject}"? All participants will be notified and redirected.`);
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`/api/discussions/sessions/${sessionId}/close`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('adminToken'),
            'x-user-id': localStorage.getItem('adminEmail') || '',
            'x-user-role': localStorage.getItem('adminRole') || 'superadmin'
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to end session');
        }

        await showAlert('Success', 'Session ended successfully.', 'success');
        
        // Reload sessions list
        const sessionsList = document.getElementById('disc-sessions-list');
        if (sessionsList) {
          await refreshDiscussionSessions(sessionsList);
        }
      } catch (error) {
        await showAlert('Error', 'Error ending session: ' + error.message, 'error');
      }
    }

    function showNotice(element, message, type) {
      element.textContent = message;
      element.style.display = 'block';
      element.style.backgroundColor = type === 'error' ? '#fee2e2' : '#dcfce7';
      element.style.color = type === 'error' ? '#991b1b' : '#166534';
      element.style.borderLeft = '4px solid ' + (type === 'error' ? '#dc2626' : '#22c55e');
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    function onTabActivated(name) {
      if (name === 'users') loadUsersUI();
      else if (name === 'courses') loadCoursesUI();
      else if (name === 'analytics') loadAnalyticsUI();
      else if (name === 'settings') loadSettingsUI();
      else if (name === 'inbox') loadInboxUI();
      else if (name === 'discussions') loadDiscussionsUI();
      else if (name === 'news') loadNewsManagementUI();
      else if (name === 'modules') loadModuleManagementUI();
      else if (name === 'content') loadContentManagementUI();
      else if (name === 'documents') loadDocumentsUI();
    }

    // Tab functionality (updated for new layout)
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');

    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        
        // Remove active class from all buttons and panels
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabPanels.forEach(panel => panel.classList.remove('active'));
        
        // Add active class to clicked button and corresponding panel
        this.classList.add('active');
        const panel = document.getElementById(tabName + '-panel');
        if (panel) {
          panel.classList.add('active');
          onTabActivated(tabName);
        }
      });
    });

    // Beautiful Live Chat UI with real-time updates and better UX
    (function() {
      const sessionsList = document.getElementById('sessions-list');
      const conversationWrap = document.getElementById('conversation-wrap');
      const conversationHeader = document.getElementById('conversation-header');
      const conversationEmpty = document.getElementById('conversation-empty');
      const currentHeader = document.getElementById('current-session-header');
      const sessionStatus = document.getElementById('session-status');
      const adminMessages = document.getElementById('admin-messages');
      const noMessages = document.getElementById('no-messages');
      const replyForm = document.getElementById('admin-reply-form');
      const adminFrom = document.getElementById('admin-from');
      const adminText = document.getElementById('admin-text');
      const adminTerminate = document.getElementById('admin-terminate');
      const adminDelete = document.getElementById('admin-delete');
      const adminNotice = document.getElementById('admin-notice');

      if (!sessionsList) return; // live chat not present

      let currentSessionId = null;
      let currentTab = 'new'; // Track which tab is active
      const ADMIN_NAME_KEY = 'chat_admin_name';
      const OPENED_CHATS_KEY = 'openedChats';
      const CHAT_EXPIRY_TIME = 1 * 60 * 60 * 1000; // 1 hour in milliseconds

      // Tab switching
      const tabNewChats = document.getElementById('tab-new-chats');
      const tabAttendedChats = document.getElementById('tab-attended-chats');
      let currentSessions = []; // Store sessions for re-rendering on tab switch
      
      // Auto-cleanup expired chats every 5 minutes
      setInterval(() => {
        cleanupExpiredChats(currentSessions);
        renderSessions(currentSessions);
      }, 5 * 60 * 1000);
      
      if (tabNewChats) {
        tabNewChats.addEventListener('click', () => {
          currentTab = 'new';
          tabNewChats.style.borderBottomColor = 'rgba(255,255,255,0.5)';
          tabNewChats.style.color = '#fff';
          tabAttendedChats.style.borderBottomColor = 'transparent';
          tabAttendedChats.style.color = 'rgba(255,255,255,0.7)';
          renderSessions(currentSessions);
        });
      }
      
      if (tabAttendedChats) {
        tabAttendedChats.addEventListener('click', () => {
          currentTab = 'attended';
          tabAttendedChats.style.borderBottomColor = 'rgba(255,255,255,0.5)';
          tabAttendedChats.style.color = '#fff';
          tabNewChats.style.borderBottomColor = 'transparent';
          tabNewChats.style.color = 'rgba(255,255,255,0.7)';
          renderSessions(currentSessions);
        });
      }

      // Load/persist admin name
      function getAdminName() {
        return localStorage.getItem(ADMIN_NAME_KEY) || 'Support Admin';
      }

      function setAdminName(name) {
        if (name.trim()) {
          localStorage.setItem(ADMIN_NAME_KEY, name.trim());
          adminFrom.value = name.trim();
        }
      }

      // Initialize admin name input
      adminFrom.value = getAdminName();
      adminFrom.addEventListener('blur', (e) => setAdminName(e.target.value));

      function showNotice(type, text) {
        adminNotice.className = 'form-notice ' + type;
        adminNotice.textContent = text;
        adminNotice.style.display = 'block';
        if (type === 'success') {
          setTimeout(() => { adminNotice.style.display = 'none'; }, 3000);
        }
      }

      // Get opened chats tracking (with timestamps)
      function getOpenedChats() {
        try {
          return JSON.parse(localStorage.getItem(OPENED_CHATS_KEY) || '{}');
        } catch {
          return {};
        }
      }

      // Mark chat as attended and store timestamp
      function markChatAsAttended(chatId) {
        const openedChats = getOpenedChats();
        openedChats[chatId] = new Date().toISOString();
        localStorage.setItem(OPENED_CHATS_KEY, JSON.stringify(openedChats));
      }

      // Check if chat should be deleted (older than 24 hours)
      function shouldDeleteChat(chatId) {
        const openedChats = getOpenedChats();
        if (!openedChats[chatId]) return false;
        const openedTime = new Date(openedChats[chatId]).getTime();
        const now = new Date().getTime();
        return (now - openedTime) > CHAT_EXPIRY_TIME;
      }

      // Clean up expired chats
      function cleanupExpiredChats(sessions) {
        const openedChats = getOpenedChats();
        let updated = false;
        const now = new Date().getTime();
        const sessionIds = new Set(sessions.map(s => s.id));

        for (const chatId in openedChats) {
          // Delete if expired (older than 24 hours)
          const openedTime = new Date(openedChats[chatId]).getTime();
          if ((now - openedTime) > CHAT_EXPIRY_TIME) {
            delete openedChats[chatId];
            updated = true;
          }
          // Also delete if the session no longer exists (was deleted by admin)
          else if (!sessionIds.has(chatId)) {
            delete openedChats[chatId];
            updated = true;
          }
        }

        if (updated) {
          localStorage.setItem(OPENED_CHATS_KEY, JSON.stringify(openedChats));
        }
      }

      function openAttachmentModal(fileName, fileUrl) {
        const modal = document.getElementById('attachment-modal');
        const title = document.getElementById('attachment-title');
        const content = document.getElementById('attachment-content');
        const downloadBtn = document.getElementById('attachment-download');
        
        title.textContent = fileName;
        downloadBtn.href = fileUrl;
        downloadBtn.download = fileName;
        
        // Determine file type and render appropriately
        const ext = fileName.split('.').pop().toLowerCase();
        
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
          // Image file with zoom support - let CSS handle sizing
          content.innerHTML = `<img src="${fileUrl}" alt="${fileName}" />`;
          const img = content.querySelector('img');
          if (img) {
            img.addEventListener('click', (e) => {
              e.stopPropagation();
              img.classList.toggle('zoomed');
            });
          }
        } else if (['mp4', 'webm', 'mov', 'avi'].includes(ext)) {
          // Video file
          content.innerHTML = `<video controls><source src="${fileUrl}" type="video/${ext}">Your browser does not support the video tag.</video>`;
        } else if (ext === 'pdf') {
          // PDF file
          content.innerHTML = `<iframe src="${fileUrl}"></iframe>`;
        } else {
          // Other file types - show download prompt
          content.innerHTML = `<div style="text-align:center;padding:40px;"><i class="fas fa-file" style="font-size:48px;color:var(--text-muted);margin-bottom:16px;display:block;"></i><p style="margin:0;color:var(--text-main);">This file cannot be previewed in your browser.</p><p style="margin:8px 0 0 0;font-size:12px;color:var(--text-muted);">${fileName}</p></div>`;
        }
        
        modal.style.display = 'flex';
      }

      function closeAttachmentModal() {
        const modal = document.getElementById('attachment-modal');
        if (modal) {
          modal.style.display = 'none';
          // Clear content to prevent memory leaks
          const content = document.getElementById('attachment-content');
          if (content) {
            content.innerHTML = '<div style="text-align:center;color:var(--text-muted);">Loading...</div>';
          }
        }
      }

      // Setup modal event listeners (with null checks for safety)
      function setupModalListeners() {
        const attachmentClose = document.getElementById('attachment-close');
        const attachmentCloseBtn = document.getElementById('attachment-close-btn');
        const attachmentModal = document.getElementById('attachment-modal');
        
        // Close button (X)
        if (attachmentClose) {
          attachmentClose.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeAttachmentModal();
            return false;
          });
        }
        
        // Close button (text)
        if (attachmentCloseBtn) {
          attachmentCloseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeAttachmentModal();
            return false;
          });
        }
        
        // Click on background overlay to close
        if (attachmentModal) {
          attachmentModal.addEventListener('click', (e) => {
            // Only close if clicking directly on the modal background, not on child elements
            if (e.target === attachmentModal) {
              closeAttachmentModal();
            }
          }, true); // Use capture phase
        }
      }
      
      // Initialize listeners after DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupModalListeners);
      } else {
        setupModalListeners();
      }
      
      // Add keyboard support for closing modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('attachment-modal');
          if (modal && modal.style.display === 'flex') {
            e.preventDefault();
            closeAttachmentModal();
          }
        }
      });

      async function fetchSessions() {
        try {
          const res = await fetch('/api/admin/chat/sessions');
          if (!res.ok) throw new Error('Failed to load sessions');
          const sessionsObj = await res.json();
          const sessions = Object.values(sessionsObj || {}).sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
          currentSessions = sessions; // Store for tab switching
          renderSessions(sessions);
          
          // Refresh current session if one is open
          if (currentSessionId) {
            const current = sessions.find(s => s.id === currentSessionId);
            if (current) {
              updateSessionMessages(current);
            }
          }
        } catch (err) {
          console.error('fetchSessions error', err);
        }
      }

      function renderSessions(sessions) {
        sessionsList.innerHTML = '';
        
        // Clean up expired chats
        cleanupExpiredChats(sessions);
        
        if (!sessions || sessions.length === 0) {
          sessionsList.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:16px;font-size:13px;flex:1;display:flex;align-items:center;justify-content:center;">No active chats</div>';
          // Update sidebar badge
          const badge = document.getElementById('live-chat-badge');
          if (badge) {
            badge.textContent = '0';
            badge.style.display = 'none';
          }
          return;
        }
        
        // Update sidebar badge with unopened count only
        const badge = document.getElementById('live-chat-badge');
        if (badge) {
          // Count only unopened sessions that are not terminated (based on server-side opened flag)
          const unopenedCount = sessions.filter(s => !s.opened && s.id !== currentSessionId && s.status !== 'terminated').length;
          badge.textContent = String(unopenedCount);
          badge.style.display = unopenedCount > 0 ? 'block' : 'none';
        }
        
        // Filter sessions based on current tab
        // Use server-side 'opened' flag instead of just localStorage for real-time sync
        let filteredSessions = sessions;
        
        if (currentTab === 'new') {
          // Show only unopened chats that are NOT terminated
          filteredSessions = sessions.filter(s => !s.opened && s.status !== 'terminated');
        } else if (currentTab === 'attended') {
          // Show only opened chats that are not terminated
          filteredSessions = sessions.filter(s => s.opened && s.status !== 'terminated');
        }
        
        if (filteredSessions.length === 0) {
          const emptyMsg = currentTab === 'new' ? 'No new chats' : 'No attended chats';
          sessionsList.innerHTML = `<div style="color:var(--text-muted);text-align:center;padding:16px;font-size:13px;flex:1;display:flex;align-items:center;justify-content:center;">${emptyMsg}</div>`;
          return;
        }
        
        // Sort by updatedAt descending (newest first)
        const sorted = [...filteredSessions].sort((a, b) => {
          const aTime = new Date(a.updatedAt || a.createdAt || 0).getTime();
          const bTime = new Date(b.updatedAt || b.createdAt || 0).getTime();
          return bTime - aTime;
        });

        sorted.forEach(s => {
          const lastMsg = (s.messages && s.messages.length) ? s.messages[s.messages.length-1] : null;
          const lastText = lastMsg ? lastMsg.text : '(no messages)';
          const isSelected = s.id === currentSessionId;
          const isNewChat = !s.opened && !isSelected;
          
          // Properly handle session name - don't show "undefined"
          const sessionName = (s.name && s.name !== 'undefined' && s.name.trim()) ? s.name : 'Support Chat';
          
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.style.width = '100%';
          btn.style.textAlign = 'left';
          btn.style.padding = '12px';
          btn.style.borderRadius = '8px';
          btn.style.border = 'none';
          btn.style.background = isNewChat ? 'rgba(76,175,80,0.12)' : 'var(--bg-secondary)';
          btn.style.color = 'var(--text-main)';
          btn.style.cursor = 'pointer';
          btn.style.transition = 'all 0.2s';
          btn.style.position = 'relative';
          btn.setAttribute('data-chat-id', s.id);
          
          const time = s.updatedAt ? new Date(s.updatedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
          
          const nameColor = isNewChat ? '#2e7d32' : 'var(--text-main)';
          const nameStyle = `color:${nameColor};display:flex;align-items:center;gap:6px;font-weight:600;`;
          const summaryStyle = isNewChat ? 'color:var(--text-muted);font-size:12px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.8;' : 'color:var(--text-muted);font-size:12px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.6;';
          
          btn.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <div style="display:flex;align-items:center;gap:8px;flex:1;">
                <strong style="${nameStyle}">${escapeHtml(sessionName)}</strong>
              </div>
              <span style="font-size:11px;color:var(--text-muted);">${time}</span>
            </div>
            <span style="${summaryStyle}">${escapeHtml(lastText)}</span>
          `;
          
          btn.addEventListener('click', () => {
            // Change button styling immediately
            btn.style.background = 'var(--bg-secondary)';
            const nameDiv = btn.querySelector('div:first-child strong');
            if (nameDiv) {
              nameDiv.style.color = 'var(--text-main)';
            }
            const summary = btn.querySelector('span:last-child');
            if (summary) summary.style.opacity = '0.6';
            
            openSession(s.id);
          });
          btn.addEventListener('mouseover', () => { 
            if (!isSelected) {
              if (isNewChat) {
                btn.style.background = 'rgba(76,175,80,0.2)';
              } else {
                btn.style.background = 'var(--bg-secondary)';
              }
            }
          });
          btn.addEventListener('mouseout', () => { 
            if (!isSelected) btn.style.background = isNewChat ? 'rgba(76,175,80,0.12)' : 'var(--bg-secondary)'; 
          });
          
          sessionsList.appendChild(btn);
        });
      }

      async function openSession(id) {
        try {
          const res = await fetch('/api/admin/chat/sessions/' + encodeURIComponent(id));
          if (!res.ok) throw new Error('Failed to load session');
          const session = await res.json();
          currentSessionId = session.id;
          
          conversationEmpty.style.display = 'none';
          conversationHeader.style.display = 'flex';
          conversationWrap.style.display = 'block';
          replyForm.style.display = 'flex';
          
          // Properly handle session name
          const displayName = (session.name && session.name !== 'undefined' && session.name.trim()) ? session.name : 'Support Chat';
          currentHeader.textContent = displayName;
          sessionStatus.textContent = session.status === 'terminated' ? 'ðŸ”’ Terminated' : 'ðŸŸ¢ Active';
          
          updateSessionMessages(session);
          const res2 = await fetch('/api/admin/chat/sessions');
          const sessionsObj = await res2.json();
          const sessions = Object.values(sessionsObj || {}).sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
          currentSessions = sessions;
          renderSessions(sessions);
          
          // Notify all other admins that this chat was opened
          try {
            fetch('/api/admin/chat/notify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId: id }) }).catch(() => {});
          } catch (e) { /* ignore */ }
        } catch (err) {
          console.error('openSession error', err);
          showNotice('error', 'Failed to load session');
        }
      }

      function updateSessionMessages(session) {
        adminMessages.innerHTML = '';
        if (!session.messages || session.messages.length === 0) {
          noMessages.style.display = 'flex';
          return;
        }
        noMessages.style.display = 'none';
        session.messages.forEach(m => appendMessageToUI(m));
        // Auto-scroll to bottom
        setTimeout(() => {
          conversationWrap.scrollTop = conversationWrap.scrollHeight;
        }, 0);
      }

      function formatTime(isoString) {
        try {
          const d = new Date(isoString);
          const now = new Date();
          const isToday = d.toDateString() === now.toDateString();
          return isToday 
            ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            : d.toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch { return ''; }
      }

      function appendMessageToUI(m) {
        const msgContainer = document.createElement('div');
        msgContainer.style.display = 'flex';
        msgContainer.style.width = '100%';
        msgContainer.style.justifyContent = m.role === 'admin' ? 'flex-end' : 'flex-start';
        msgContainer.style.alignItems = 'flex-end';
        msgContainer.style.gap = '8px';
        
        const bubble = document.createElement('div');
        bubble.style.maxWidth = '70%';
        bubble.style.padding = '10px 14px';
        bubble.style.borderRadius = '12px';
        bubble.style.wordWrap = 'break-word';
        bubble.style.lineHeight = '1.5';
        bubble.style.fontSize = '13px';
        
        const time = document.createElement('span');
        time.style.fontSize = '11px';
        time.style.color = 'var(--text-muted)';
        time.style.minWidth = '40px';
        time.textContent = formatTime(m.time);

        if (m.role === 'admin') {
          bubble.style.background = 'linear-gradient(135deg, var(--green-main) 0%, #005a4f 100%)';
          bubble.style.color = '#fff';
          bubble.innerHTML = `<strong style="display:block;font-size:12px;margin-bottom:4px;opacity:0.95">${escapeHtml(m.from || 'You')}</strong><span>${escapeHtml(m.text)}</span>`;
        } else {
          bubble.style.background = 'var(--bg-secondary)';
          bubble.style.color = 'var(--text-main)';
          bubble.style.border = '1px solid var(--border-color)';
          bubble.innerHTML = `<strong style="display:block;font-size:12px;margin-bottom:4px;color:var(--text-main)">${escapeHtml(m.from || 'User')}</strong><span>${escapeHtml(m.text)}</span>`;
        }
        
        // Add file attachments if present
        if (m.files && m.files.length > 0) {
          const filesDiv = document.createElement('div');
          filesDiv.style.marginTop = '8px';
          filesDiv.style.display = 'flex';
          filesDiv.style.flexDirection = 'column';
          filesDiv.style.gap = '6px';
          filesDiv.style.paddingTop = '8px';
          filesDiv.style.borderTop = m.role === 'admin' ? '1px solid rgba(255,255,255,0.2)' : '1px solid rgba(0,0,0,0.1)';
          
          m.files.forEach(f => {
            const link = document.createElement('a');
            link.href = '#';
            link.textContent = f.name;
            link.style.fontSize = '12px';
            link.style.textDecoration = 'underline';
            link.style.color = m.role === 'admin' ? '#fff' : '#0b66b3';
            link.style.opacity = m.role === 'admin' ? '0.95' : '1';
            link.style.cursor = 'pointer';
            link.addEventListener('click', (e) => {
              e.preventDefault();
              openAttachmentModal(f.name, f.url);
            });
            filesDiv.appendChild(link);
          });
          
          bubble.appendChild(filesDiv);
        }
        
        msgContainer.appendChild(bubble);
        if (m.role !== 'admin') msgContainer.appendChild(time);
        else msgContainer.insertBefore(time, bubble);
        
        adminMessages.appendChild(msgContainer);
      };

      // Allow Enter to send (Shift+Enter for new line)
      adminText.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          replyForm.dispatchEvent(new Event('submit'));
        }
      });

      replyForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const from = adminFrom.value.trim() || getAdminName();
        const text = adminText.value.trim();
        if (!text || !currentSessionId) return;

        const sendBtn = document.getElementById('admin-send');
        sendBtn.disabled = true;

        try {
          const res = await fetch('/api/admin/chat/sessions/' + encodeURIComponent(currentSessionId) + '/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ from, text })
          });
          if (!res.ok) throw new Error('Failed to send reply');
          const body = await res.json();
          if (body && body.message) {
            appendMessageToUI(body.message);
            conversationWrap.scrollTop = conversationWrap.scrollHeight;
          }
          adminText.value = '';
          showNotice('success', 'Message sent');
          setAdminName(from);
        } catch (err) {
          console.error('reply error', err);
          showNotice('error', 'Failed to send message');
        } finally {
          sendBtn.disabled = false;
        }
      });

      // Styled confirmation dialog
      function showStyledConfirm(title, message, onConfirm, onCancel) {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'background:#fff;border-radius:12px;padding:24px;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);';
        
        modal.innerHTML = `
          <h3 style="margin:0 0 12px 0;font-size:18px;color:var(--text-main);">${escapeHtml(title)}</h3>
          <p style="margin:0 0 20px 0;color:var(--text-muted);line-height:1.5;">${escapeHtml(message)}</p>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button style="padding:8px 16px;border:1px solid #e6eef4;background:#fff;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text-main);" onclick="this.closest('[data-modal]').remove()">Cancel</button>
            <button id="confirm-btn" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">Confirm</button>
          </div>
        `;
        modal.setAttribute('data-modal', 'true');
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        const confirmBtn = modal.querySelector('#confirm-btn');
        confirmBtn.addEventListener('click', () => {
          overlay.remove();
          if (onConfirm) onConfirm();
        });
        
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.remove();
            if (onCancel) onCancel();
          }
        });
      }

      adminTerminate.addEventListener('click', async function() {
        if (!currentSessionId) return;
        
        showStyledConfirm(
          'Terminate Chat',
          'End this chat session? The user will see it as closed.',
          async () => {
            try {
              const res = await fetch('/api/admin/chat/sessions/' + encodeURIComponent(currentSessionId) + '/terminate', { method: 'POST' });
              if (!res.ok) throw new Error('Failed to terminate');
              
              conversationEmpty.style.display = 'flex';
              conversationHeader.style.display = 'none';
              conversationWrap.style.display = 'none';
              replyForm.style.display = 'none';
              adminMessages.innerHTML = '';
              currentSessionId = null;
              
              showNotice('success', 'Chat terminated');
              fetchSessions();
            } catch (err) {
              console.error('terminate error', err);
              showNotice('error', 'Failed to terminate chat');
            }
          }
        );
      });

      adminDelete.addEventListener('click', async function() {
        if (!currentSessionId) return;
        
        showStyledConfirm(
          'Delete Chat',
          'Permanently delete this chat and all messages? This action cannot be undone.',
          async () => {
            try {
              const res = await fetch('/api/admin/chat/sessions/' + encodeURIComponent(currentSessionId) + '/delete', { method: 'POST' });
              if (!res.ok) throw new Error('Failed to delete');
              
              conversationEmpty.style.display = 'flex';
              conversationHeader.style.display = 'none';
              conversationWrap.style.display = 'none';
              replyForm.style.display = 'none';
              adminMessages.innerHTML = '';
              currentSessionId = null;
              
              showNotice('success', 'Chat deleted permanently');
              fetchSessions();
            } catch (err) {
              console.error('delete error', err);
              showNotice('error', 'Failed to delete chat');
            }
          }
        );
      });

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      // Real-time SSE updates for admin chat (when other admins open chats)
      if (window.EventSource) {
        try {
          const adminChatSSE = new EventSource('/api/admin/chat/stream');
          adminChatSSE.addEventListener('chatUpdated', () => {
            console.log('ðŸ“¢ Chat updated by another admin, refreshing...');
            fetchSessions();
          });
          adminChatSSE.addEventListener('error', (e) => {
            console.warn('Admin chat SSE error:', e);
          });
        } catch (e) {
          console.warn('Admin chat SSE not available, using polling only:', e);
        }
      }

      // Initial load
      fetchSessions();

      // Poll for new sessions and messages every 3 seconds
      setInterval(fetchSessions, 3000);
    })();

    // Dashboard fullscreen toggle removed

    // Styled Modal Dialogs
    function showModal(options) {
      const { type = 'info', title, message, onConfirm, onCancel, isHtml = false } = options;
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      const icons = {
        success: 'âœ“',
        warning: 'âš ',
        error: 'âœ•',
        info: 'â„¹'
      };
      
      const iconColor = {
        success: 'success',
        warning: 'warning',
        error: 'error',
        info: 'info'
      };

      const content = document.createElement('div');
      content.className = 'modal-content';
      content.innerHTML = `
        <div class="modal-icon ${iconColor[type]}">${icons[type]}</div>
        <h2 class="modal-title">${escapeHtml(title)}</h2>
        <div class="modal-message" ${isHtml ? '' : ''}></div>
        <div class="modal-buttons">
          ${onCancel ? '<button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>' : ''}
          ${onConfirm ? `<button class="modal-btn modal-btn-primary" id="modal-confirm">${onCancel ? 'Confirm' : 'OK'}</button>` : ''}
        </div>
      `;
      
      // Handle message content - either as HTML or escaped text
      const messageDiv = content.querySelector('.modal-message');
      if (isHtml) {
        messageDiv.innerHTML = message;
      } else {
        messageDiv.textContent = message;
      }
      
      overlay.appendChild(content);
      document.body.appendChild(overlay);
      
      const handleConfirm = () => {
        overlay.remove();
        if (onConfirm) onConfirm();
      };
      
      const handleCancel = () => {
        overlay.remove();
        if (onCancel) onCancel();
      };
      
      const confirmBtn = content.querySelector('#modal-confirm');
      const cancelBtn = content.querySelector('#modal-cancel');
      
      if (confirmBtn) confirmBtn.addEventListener('click', handleConfirm);
      if (cancelBtn) cancelBtn.addEventListener('click', handleCancel);
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) handleCancel();
      });
      
      if (confirmBtn) confirmBtn.focus();
    }

    function showAlert(title, message, type = 'info', options = {}) {
      return new Promise((resolve) => {
        showModal({
          type,
          title,
          message,
          isHtml: options.isHtml || false,
          onConfirm: resolve
        });
      });
    }

    function showConfirm(title, message, type = 'warning') {
      return new Promise((resolve) => {
        showModal({
          type,
          title,
          message,
          onConfirm: () => resolve(true),
          onCancel: () => resolve(false)
        });
      });
    }
  </script>

  <script>
    (function(){
      const btn = document.getElementById('sidebar-collapse-btn');
      if (!btn) return;
      btn.addEventListener('click', function(e){
        e.preventDefault();
        const collapsed = document.body.classList.toggle('sidebar-collapsed');
        btn.setAttribute('aria-expanded', collapsed ? 'true' : 'false');
        const icon = btn.querySelector('i');
        if (icon) {
          icon.classList.toggle('fa-angle-left', !collapsed);
          icon.classList.toggle('fa-angle-right', collapsed);
        }
      });
      // initialize icon state
      if (document.body.classList.contains('sidebar-collapsed')) {
        const icon = btn.querySelector('i'); if (icon) { icon.classList.remove('fa-angle-left'); icon.classList.add('fa-angle-right'); }
      }
    })();
  </script>

  <script>
    (function(){
      // Create mobile nav container
      let mobileNav = document.getElementById('mobile-nav');
      if (!mobileNav) {
        mobileNav = document.createElement('div');
        mobileNav.id = 'mobile-nav';
        mobileNav.style.cssText = 'position:fixed;top:64px;right:12px;width:220px;background:white;border:1px solid #e6eef4;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.08);z-index:10002;display:none;overflow:hidden;';
        mobileNav.innerHTML = '<div class="mobile-nav-links" style="display:flex;flex-direction:column;"></div>';
        document.body.appendChild(mobileNav);
      }

      function openMobileNav() {
        mobileNav.style.display = 'block';
        // overlay
        let ov = document.getElementById('mobile-nav-overlay');
        if (!ov) {
          ov = document.createElement('div');
          ov.id = 'mobile-nav-overlay';
          ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:10001;';
          ov.addEventListener('click', closeMobileNav);
          document.body.appendChild(ov);
        }
      }

      function closeMobileNav() {
        mobileNav.style.display = 'none';
        const ov = document.getElementById('mobile-nav-overlay');
        if (ov) ov.remove();
      }

      // Populate mobile nav by cloning desktop nav links
      const headerNav = document.querySelector('.nav-menu');
      const linksWrap = mobileNav.querySelector('.mobile-nav-links');
      function populate() {
        linksWrap.innerHTML = '';
        if (!headerNav) return;
        // clone only anchor elements inside nav-menu
        headerNav.querySelectorAll('a, button').forEach(el => {
          if (el.tagName === 'A') {
            const a = document.createElement('a');
            a.href = el.getAttribute('href') || '#';
            a.innerHTML = el.innerHTML;
            a.style.cssText = 'padding:12px 14px;border-bottom:1px solid #f3f7fa;color:var(--text-main);text-decoration:none;display:block;';
            a.addEventListener('click', () => setTimeout(closeMobileNav, 50));
            linksWrap.appendChild(a);
          }
          if (el.tagName === 'BUTTON') {
            // copy button actions (like logout click) by cloning text and wiring click to original
            const btn = document.createElement('a');
            btn.href = '#';
            btn.innerHTML = el.innerHTML;
            btn.style.cssText = 'padding:12px 14px;border-bottom:1px solid #f3f7fa;color:var(--text-main);text-decoration:none;display:block;';
            btn.addEventListener('click', (e) => { e.preventDefault(); el.click(); closeMobileNav(); });
            linksWrap.appendChild(btn);
          }
        });
      }

      populate();

      // Re-populate when nav changes (basic observer)
      const navObserver = new MutationObserver(populate);
      if (headerNav) navObserver.observe(headerNav, { childList: true, subtree: true });

      const hh = document.getElementById('header-hamburger');
      if (hh) {
        hh.addEventListener('click', (e) => {
          e.preventDefault();
          if (mobileNav.style.display === 'block') closeMobileNav(); else openMobileNav();
        });
      }

      // ensure links close the nav when clicked
      mobileNav.addEventListener('click', (e) => {
        const a = e.target.closest('a');
        if (a) closeMobileNav();
      });
    })();
  </script>

  <script>
    // Ensure sidebar and other fixed elements offset by actual header height
    (function(){
      const setHeaderHeightVar = () => {
        const hdr = document.querySelector('.site-header');
        if (!hdr) return;
        const h = hdr.getBoundingClientRect().height || 64;
        document.documentElement.style.setProperty('--site-header-height', Math.ceil(h) + 'px');
      };
      setHeaderHeightVar();
      let t = null;
      window.addEventListener('resize', () => { clearTimeout(t); t = setTimeout(setHeaderHeightVar, 120); });
      // also observe mutations that might change header size
      try {
        const obs = new MutationObserver(setHeaderHeightVar);
        obs.observe(document.querySelector('.site-header'), { childList: true, subtree: true, attributes: true });
      } catch (e){}
    })();
  </script>

  <!-- File Attachment Modal -->
  <div id="attachment-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;overflow:hidden;">
    <div style="background:var(--bg-main);border-radius:12px;padding:0;width:90vw;height:90vh;max-width:1400px;max-height:900px;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;pointer-events:auto;">
      <!-- Modal Header -->
      <div style="padding:16px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;background:var(--bg-secondary);">
        <h3 id="attachment-title" style="margin:0;font-size:16px;font-weight:600;color:var(--text-main);">View File</h3>
        <button id="attachment-close" type="button" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:color 0.2s;">âœ•</button>
      </div>
      <!-- Modal Content -->
      <div id="attachment-content" style="flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);padding:16px;user-select:none;min-height:300px;">
        <div style="text-align:center;color:var(--text-muted);">Loading...</div>
      </div>
      <!-- Modal Footer -->
      <div style="padding:12px 16px;border-top:1px solid var(--border-color);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;background:var(--bg-secondary);">
        <a id="attachment-download" href="#" download style="padding:8px 16px;background:#0b66b3;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;text-decoration:none;display:inline-block;transition:background 0.2s;">Download</a>
        <button id="attachment-close-btn" type="button" style="padding:8px 16px;background:var(--border-color);color:var(--text-main);border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:background 0.2s;">Close</button>
      </div>
    </div>
  </div>

  <style>
    /* Attachment modal styling */
    #attachment-modal {
      backdrop-filter: blur(4px);
    }
    
    /* Dark mode support for attachment modal */
    body.dark #attachment-modal {
      background: rgba(0, 0, 0, 0.95);
    }
    
    /* Content area - flex layout centers content naturally */
    #attachment-content {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      user-select: none;
      min-height: 300px;
    }
    
    /* Image sizing - fit to container without stretching */
    #attachment-content img {
      cursor: zoom-in;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }
    
    #attachment-content img.zoomed {
      cursor: zoom-out;
      transform: scale(2);
    }
    
    /* Video sizing */
    #attachment-content video {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      border-radius: 4px;
    }
    
    /* PDF iframe sizing */
    #attachment-content iframe {
      border: none;
      border-radius: 4px;
      width: 100%;
      height: 100%;
    }
    
    /* Close button styling */
    #attachment-close {
      cursor: pointer;
      user-select: none;
    }
    
    #attachment-close:hover {
      color: var(--text-main);
      transform: scale(1.1);
    }
    
    #attachment-close-btn:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }
    
    #attachment-download:hover {
      background: #0a5a9e !important;
    }
    
    /* File info text styling */
    #attachment-content > div {
      color: var(--text-muted);
    }
    
    body.dark #attachment-content > div i {
      color: var(--text-muted);
    }
  </style>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-socials">
        <a href="https://www.facebook.com/share/16eSPZmrA8/" target="_blank"><i class="fab fa-facebook-f"></i></a>
        <a href="https://www.instagram.com/aubie/" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://www.linkedin.com/school/auburn-university/" target="_blank"><i class="fab fa-linkedin-in"></i></a>
      </div>
      <p>&copy; <span class="site-year"></span> Aubie Renewable Energy Hub. All rights reserved.</p>
    </div>
  </footer>

</body>
</html>